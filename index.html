<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toya Guardians: Tirtatelaga Defense</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* --- STYLES UTAMA --- */
        :root {
            --primary-blue: #00A8FF; --tech-cyan: #00D9FF; --accent-gold: #FFD700;
            --dark-base: #050A14; --danger-red: #FF4444; --success-green: #00FF88;
            --glass-panel: rgba(5, 20, 40, 0.95);
        }
        
        body { 
            margin: 0; padding: 0; 
            background-color: #000; 
            color: white; 
            font-family: 'Rajdhani', sans-serif; 
            overflow: hidden; 
            width: 100vw; 
            height: 100vh;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            touch-action: none; 
        }
        
        /* --- CONTAINER UTAMA (FIXED RATIO SCALING) --- */
        #game-container { 
            position: relative; 
            width: 800px; 
            height: 600px; 
            background: #000; 
            border: 2px solid var(--primary-blue); 
            box-shadow: 0 0 50px rgba(0, 168, 255, 0.3); 
            overflow: hidden; 
            border-radius: 8px; 
            
            /* Penting untuk scaling */
            transform-origin: center center;
            transition: transform 0.2s ease-out; /* Smooth resizing */
        }
        
        /* Hapus border saat fullscreen agar terlihat menyatu */
        body.fullscreen-mode #game-container {
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* UI SCREENS */
        .ui-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* SCREEN SPLASH (LOADING BAR) */
        #screen-splash { background-color: #000; z-index: 100; font-family: 'VT323', monospace; color: var(--primary-blue); text-align: center; align-items: center; padding: 50px; box-sizing: border-box; cursor: default; }
        #loading-pct-large { font-size: 4rem; margin-bottom: 10px; text-shadow: 0 0 15px var(--primary-blue); color: var(--accent-gold); }
        .terminal-text { font-size: 1.2rem; margin-bottom: 5px; text-shadow: 0 0 5px var(--primary-blue); text-align: left; width: 100%; max-width: 600px; }
        .loading-bar-container { width: 100%; max-width: 600px; height: 20px; border: 2px solid var(--primary-blue); margin-top: 10px; padding: 2px; align-self: center; }
        .loading-bar-fill { height: 100%; background-color: var(--primary-blue); width: 0%; box-shadow: 0 0 15px var(--primary-blue); transition: width 0.1s; }
        
        /* Audio Setup Screen Styles */
        #screen-audio { background-color: var(--dark-base); background-image: radial-gradient(circle at center, #0a1f3d 0%, #000000 100%); z-index: 90; }
        .audio-icon-container { width: 120px; height: 120px; border: 2px solid var(--tech-cyan); border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(0, 217, 255, 0.2); animation: pulseAudio 2s infinite; }
        .audio-icon-img { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 0 10px var(--tech-cyan)); }
        
        @keyframes pulseAudio { 0% { box-shadow: 0 0 0 0 rgba(0, 217, 255, 0.4); transform: scale(1); } 70% { box-shadow: 0 0 0 20px rgba(0, 217, 255, 0); transform: scale(1.05); } 100% { box-shadow: 0 0 0 0 rgba(0, 217, 255, 0); transform: scale(1); } }
        
        /* TITLE & LIGHTNING */
        #screen-title { background-color: var(--dark-base); background-image: linear-gradient(rgba(5, 20, 40, 0.4), rgba(5, 20, 40, 0.9)), url('images/bg_title.png'); background-size: cover; background-position: center; justify-content: flex-start; padding-top: 20px; }
        
        #logo-container { margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; overflow: visible; }
        #logo-img { width: auto; height: auto; max-width: 80%; max-height: 420px; display: block; filter: drop-shadow(0 0 25px rgba(0, 168, 255, 0.7)); object-fit: contain; animation: floatLogo 3s ease-in-out infinite; }
        #subtitle-img { width: auto; height: auto; max-width: 70%; max-height: 90px; margin-top: -140px; display: block; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)); animation: floatLogo 3.5s ease-in-out infinite reverse; }
        
        @keyframes floatLogo { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        /* GEMINI BADGE STYLE */
        .gemini-badge {
            position: absolute; bottom: 15px; right: 15px;
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
            padding: 5px 12px; border-radius: 20px;
            font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.8rem;
            color: white; border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: glowBadge 3s infinite alternate;
        }
        @keyframes glowBadge { from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); } to { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); } }

        #lightning-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 5; mix-blend-mode: overlay; }
        
        /* REGISTER & CHAR SELECT */
        .panel { background: var(--glass-panel); padding: 30px; border: 1px solid var(--primary-blue); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 168, 255, 0.2); max-width: 400px; width: 90%; backdrop-filter: blur(5px); position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: var(--danger-red); font-size: 1.5rem; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; transition: 0.2s; }
        .close-btn:hover { transform: scale(1.2); text-shadow: 0 0 10px red; }
        
        .form-group { margin-bottom: 10px; text-align: left; }
        label { color: var(--tech-cyan); font-weight: bold; font-size: 0.8rem; display: block; margin-bottom: 3px; }
        input, select { width: 100%; padding: 8px; background: rgba(0,0,0,0.6); border: 1px solid #445; color: white; font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--tech-cyan); box-shadow: 0 0 10px var(--primary-blue); }
        
        /* Button Animations */
        @keyframes pulseButton { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(0, 168, 255, 0.7); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(0, 168, 255, 0.7); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(0, 168, 255, 0); } }
        .btn-anim { animation: pulseButton 2s infinite; }

        .btn-ml { background: linear-gradient(180deg, var(--primary-blue) 0%, #0056b3 100%); border: 2px solid var(--tech-cyan); color: white; padding: 12px 30px; font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 1.1rem; border-radius: 6px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 0 #003366, 0 0 15px rgba(0, 168, 255, 0.4); transition: 0.1s; margin-top: 15px; width: 100%; position: relative; overflow: hidden; }
        .btn-ml:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-ml:active { transform: translateY(4px); box-shadow: none; border-color: #556; }
        .btn-ml:disabled { background: #333; color: #777; border-color: #555; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(100%); }
        
        /* --- MENU BUTTONS FIXED POSITIONING --- */
        .btn-music-toggle { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--tech-cyan); color: var(--tech-cyan); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.2rem; z-index: 100; transition: 0.3s; }
        
        .btn-fullscreen-toggle { position: absolute; top: 20px; right: 70px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--tech-cyan); color: var(--tech-cyan); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.5rem; z-index: 100; transition: 0.3s; }
        
        .btn-about-toggle { position: absolute; top: 20px; right: 120px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--tech-cyan); color: var(--tech-cyan); width: 40px; height: 40px; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; font-size: 1.2rem; z-index: 100; transition: 0.3s; font-family: 'Orbitron'; font-weight: bold; }
        
        .btn-about-toggle:hover, .btn-fullscreen-toggle:hover, .btn-music-toggle:hover { background: var(--primary-blue); color: #000; box-shadow: 0 0 10px var(--tech-cyan); }

        #screen-register { 
            background-color: var(--dark-base); 
            background-image: linear-gradient(rgba(5, 20, 40, 0.8), rgba(5, 20, 40, 0.9)), url('images/bg_noc.png'); 
            background-size: cover; 
            background-position: center; 
            flex-direction: row; 
            gap: 30px;
        }
        .reg-illustration { width: 250px; height: 400px; background: rgba(0,0,0,0.3); border: 1px solid var(--primary-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; display: none; }
        @media (min-width: 800px) { .reg-illustration { display: flex; } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03) translateY(-5px); } }
        .reg-illustration img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; filter: grayscale(50%); animation: breathe 4s infinite ease-in-out; }

        #screen-char { 
            background-color: var(--dark-base); 
            background-image: linear-gradient(rgba(5, 20, 40, 0.7), rgba(5, 20, 40, 0.9)), url('images/bg_noc.png'); 
            background-size: cover; 
            background-position: center; 
        }
        .char-grid { display: flex; gap: 20px; margin-top: 20px; justify-content: center; }
        .char-card { background: rgba(255,255,255,0.05); border: 2px solid #445; border-radius: 12px; padding: 10px; cursor: pointer; width: 120px; text-align: center; transition: 0.3s; position: relative; overflow: hidden; }
        
        @keyframes floatCardHero { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .char-card img { width: 100%; height: 130px; object-fit: cover; object-position: top center; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); image-rendering: pixelated; border-radius: 8px; animation: floatCardHero 3s infinite ease-in-out; }
        #char-2 img { animation-delay: 1s; }
        #char-3 img { animation-delay: 2s; }
        .char-card.selected { border-color: var(--tech-cyan); background: linear-gradient(135deg, rgba(0, 168, 255, 0.1), rgba(0, 86, 179, 0.3)); transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 168, 255, 0.4); }

        #screen-story { justify-content: flex-end; background-color: #000; }
        #story-bg { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; opacity: 0.6; background-image: url('images/bg_server.png'); transition: background-image 0.5s ease-in-out; }
        .dialogue-box { position: relative; width: 90%; min-height: 160px; background: linear-gradient(90deg, rgba(5, 20, 40, 0.95), rgba(10, 30, 60, 0.9)); border: 2px solid var(--tech-cyan); margin-bottom: 20px; padding: 20px; box-sizing: border-box; display: flex; align-items: flex-end; border-radius: 12px; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .char-portrait { width: 100px; height: 100px; background: #000; border: 2px solid var(--primary-blue); margin-right: 20px; flex-shrink: 0; overflow: hidden; border-radius: 8px; margin-bottom: 10px; }
        @keyframes talkBreath { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.05); filter: brightness(1.2); } 100% { transform: scale(1); filter: brightness(1); } }
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; object-position: top center; animation: talkBreath 2.5s infinite ease-in-out; }
        .dialogue-text { width: 100%; }
        .dialogue-text h3 { margin: 0 0 5px 0; color: var(--tech-cyan); font-family: 'Orbitron'; font-size: 1.2rem; }
        .dialogue-text p { margin: 0; font-size: 1.1rem; line-height: 1.4; color: #eee; }
        .next-arrow { position: absolute; bottom: 15px; right: 20px; color: var(--accent-gold); animation: bounce 1s infinite; font-size: 1.5rem; cursor: pointer; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; box-sizing: border-box; display: none; justify-content: space-between; pointer-events: none; z-index: 20; }
        .hud-top-left { display:flex; gap:10px; flex-direction: column; align-items: flex-start; }
        .hud-panel { background: rgba(5, 20, 40, 0.85); border: 1px solid var(--tech-cyan); padding: 5px 15px; border-radius: 6px; color: white; font-family: 'Orbitron'; font-size: 1rem; display: flex; flex-direction: column; align-items: center; min-width: 80px; box-shadow: 0 0 10px rgba(0, 168, 255, 0.2); }
        .hud-val { font-size: 1.2rem; font-weight: bold; }
        .purity-container { width: 150px; height: 10px; background: #333; border: 1px solid #555; margin-top: 5px; position: relative; }
        .purity-fill { height: 100%; width: 100%; transition: width 0.3s, background-color 0.5s; box-shadow: 0 0 5px var(--tech-cyan); }
        
        #mission-overlay { 
            background: linear-gradient(90deg, rgba(5, 20, 40, 0.95), rgba(10, 30, 60, 0.8));
            border: 1px solid var(--accent-gold); padding: 8px 15px; border-radius: 6px; 
            color: var(--accent-gold); font-family: 'Orbitron', sans-serif; font-size: 0.9rem; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); display: none; z-index: 20;
        }

        #rpg-controls { position: absolute; bottom: 20px; right: 20px; display: none; gap: 15px; z-index: 50; }
        #dpad-controls { position: absolute; bottom: 20px; left: 20px; width: 150px; height: 150px; display: none; z-index: 50; pointer-events: auto; }
        .dpad-btn { position: absolute; width: 45px; height: 45px; background: rgba(0, 168, 255, 0.3); border: 2px solid var(--tech-cyan); border-radius: 8px; color: white; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; user-select: none; cursor: pointer; backdrop-filter: blur(2px); touch-action: manipulation; }
        .dpad-btn:active { background: var(--tech-cyan); color: black; transform: scale(0.95); }
        .dpad-up { top: 0; left: 50px; }
        .dpad-down { bottom: 0; left: 50px; }
        .dpad-left { top: 50px; left: 0; }
        .dpad-right { top: 50px; right: 0; }
        .dpad-center { top: 50px; left: 50px; width: 45px; height: 45px; background: rgba(255, 68, 68, 0.5); border-radius: 50%; border-color: var(--danger-red); font-size: 0.8rem; font-weight: bold; }

        .rpg-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff; display: flex; justify-content: center; align-items: center; font-family: 'Orbitron'; font-weight: bold; font-size: 0.9rem; color: white; cursor: pointer; user-select: none; box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .rpg-btn:active { transform: scale(0.9); }
        #btn-atk { background: radial-gradient(circle, #FF4444, #880000); border-color: #FF8888; width: 80px; height: 80px; font-size: 1.1rem; }
        #btn-skill { background: radial-gradient(circle, #00D9FF, #0056b3); border-color: #88FFFF; }
        /* NEW DASH BUTTON STYLE */
        #btn-dash { background: radial-gradient(circle, #888, #444); border-color: #AAA; width: 60px; height: 60px; font-size: 0.8rem; }
        
        .cooldown { filter: grayscale(1); opacity: 0.6; pointer-events: none; border-color: #555 !important; color: #aaa; background: #333 !important; box-shadow: none !important; }

        .float-score { position: absolute; color: var(--accent-gold); font-family: 'Orbitron'; font-weight: bold; font-size: 1.5rem; text-shadow: 0 0 10px black; animation: floatUp 1s forwards; pointer-events: none; z-index: 50; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* CUSTOM MESSAGE BOX - UPDATED CSS */
        #custom-message-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: linear-gradient(135deg, rgba(5, 20, 40, 0.98), rgba(10, 30, 60, 0.98)); 
            border: 3px solid var(--accent-gold); border-radius: 10px; padding: 25px; 
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8); /* Intensified Shadow */
            z-index: 20000 !important; /* EXTREMELY HIGH Z-INDEX */
            max-width: 450px; width: 90%; text-align: center; 
            display: none; /* Controlled by JS */
            flex-direction: column; align-items: center; 
        }
        #msg-icon { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--primary-blue); margin-bottom: 10px; object-fit: cover; object-position: top center; background: #000; display: none; }
        #msg-title { color: var(--tech-cyan); font-family: 'Orbitron'; font-size: 1.5rem; margin-bottom: 10px; margin-top: 0; }
        #msg-body { color: white; margin-bottom: 20px; font-size: 1rem; line-height: 1.5; width: 100%; }
        .btn-msg-ok { background: linear-gradient(180deg, var(--primary-blue) 0%, #0056b3 100%); border: 2px solid var(--tech-cyan); color: white; padding: 8px 20px; font-family: 'Orbitron'; border-radius: 5px; cursor: pointer; font-size: 1.1rem; width: 100px; }


        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #ccc; font-size: 0.8rem;}
        #leaderboard-table th { text-align: left; color: var(--tech-cyan); border-bottom: 1px solid #445; padding: 5px;}
        #leaderboard-table td { border-bottom: 1px solid #223; padding: 5px; }
        .lb-controls { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; flex-wrap: wrap; }
        .lb-select { flex: 1; padding: 5px; background: rgba(0,0,0,0.5); border: 1px solid #445; color: white; font-family: 'Rajdhani'; min-width: 150px;}
        
        .sync-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 10px; border: 1px solid transparent; }
        .status-online { background: rgba(0, 255, 136, 0.1); color: var(--success-green); border-color: var(--success-green); }
        .status-offline { background: rgba(255, 68, 68, 0.1); color: var(--danger-red); border-color: var(--danger-red); }
        .status-loading { background: rgba(0, 168, 255, 0.1); color: var(--primary-blue); border-color: var(--primary-blue); animation: pulseStatus 1s infinite; }
        @keyframes pulseStatus { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        #screen-loading { background-color: #000; z-index: 99; color: var(--primary-blue); font-family: 'Orbitron'; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .sync-status { font-size: 0.8rem; color: #888; margin-top: 5px; font-style: italic; }
        .sync-success { color: var(--success-green); }
        .sync-error { color: var(--danger-red); }
        
        #screen-title-ch1, #screen-title-ch2, #screen-title-ch3 { background-color: #111; }
        #screen-quiz { background-image: linear-gradient(rgba(5, 20, 40, 0.8), rgba(5, 20, 40, 0.9)), url('images/bg_monitor.png'); background-size: cover; background-position: center; }
        #quiz-code-display span { margin: 0 5px; }
        .quiz-option-btn { width: 100%; text-align: left; }

        /* --- UPDATED RESULT SCREEN STYLES --- */
        #screen-ending { 
            background-color: rgba(5, 10, 20, 0.92); /* Background gelap transparan */
            backdrop-filter: blur(8px); /* Efek blur pada game di belakangnya */
            z-index: 200; /* Pastikan di atas segalanya */
        }

        .result-panel {
            background: linear-gradient(145deg, rgba(10, 30, 60, 0.9), rgba(0, 0, 0, 0.95));
            border: 2px solid var(--tech-cyan);
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            position: relative;
            animation: slideUpFade 0.6s ease-out;
        }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .result-win { border-color: var(--accent-gold); box-shadow: 0 0 40px rgba(255, 215, 0, 0.2); }
        .result-loss { border-color: var(--danger-red); box-shadow: 0 0 40px rgba(255, 68, 68, 0.2); }

        .result-title {
            font-family: 'Orbitron'; font-size: 2rem; margin: 0 0 10px 0;
            text-shadow: 0 0 10px currentColor;
        }

        .rank-circle {
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 4px double rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            margin: 15px 0;
            background: rgba(0,0,0,0.3);
            position: relative;
        }
        
        #end-rank {
            font-size: 5rem; font-family: 'Orbitron'; font-weight: 900; margin: 0;
            text-shadow: 0 0 20px currentColor; z-index: 2;
        }
        
        .score-box {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 10px 30px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
            text-align: center;
            width: 100%; box-sizing: border-box;
        }
        
        .score-label { color: #888; font-size: 0.9rem; letter-spacing: 2px; margin-bottom: 5px; font-family: 'Rajdhani'; text-transform: uppercase; }
        #end-score { color: white; font-size: 2rem; font-family: 'Orbitron'; font-weight: bold; margin: 0; text-shadow: 0 0 10px white; }

        #end-msg { color: #ccc; margin-bottom: 10px; font-style: italic; }
        #save-status { font-size: 0.8rem; color: #666; margin-bottom: 10px; border-top: 1px solid #333; padding-top: 5px; width: 100%; text-align: center; }

        /* STATISTICS GRID (STATS SCREEN) */
        .stats-container {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-family: 'Rajdhani';
        }
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #aaa;
            display: flex; justify-content: space-between;
        }
        .stat-val { color: var(--tech-cyan); font-weight: bold; }

    </style>
</head>
<body>

<!-- AUDIO TRACKS -->
<audio id="bgm-player" loop><source src="audio/bgm.mp3" type="audio/mp3"></audio>
<audio id="bgm-shooter" loop><source src="audio/bgm_shooter.mp3" type="audio/mp3"></audio> 
<audio id="bgm-bomber" loop><source src="audio/bgm_bomber.mp3" type="audio/mp3"></audio> 
<audio id="bgm-boss" loop><source src="audio/boss.mp3" type="audio/mp3"></audio> 
<audio id="bgm-ending" loop><source src="audio/ending.mp3" type="audio/mp3"></audio> 

<audio id="sfx-click"><source src="audio/click.mp3" type="audio/mp3"></audio>
<audio id="sfx-correct"><source src="audio/correct.mp3" type="audio/mp3"></audio>
<audio id="sfx-wrong"><source src="audio/wrong.mp3" type="audio/mp3"></audio>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <!-- BUTTONS TOP RIGHT -->
    <div class="btn-music-toggle" id="btn-music" onclick="app.toggleMusic()" title="Toggle Music">â™ª</div>
    
    <div class="btn-fullscreen-toggle" id="btn-fullscreen" onclick="app.toggleFullScreen()" title="Full Screen">â›¶</div>
    <div class="btn-about-toggle" id="btn-about" onclick="app.toggleAbout()" title="About">?</div>
    
    <!-- Lightning Effect Overlay -->
    <div id="lightning-overlay"></div>

    <div id="hud">
        <div class="hud-top-left">
            <div style="display:flex; gap:10px;">
                <div class="hud-panel"><span>SCORE</span><span class="hud-val" id="hud-score" style="color:var(--accent-gold)">0</span></div>
                <div class="hud-panel" style="border-color: var(--danger-red)"><span>TIME</span><span class="hud-val" id="hud-timer" style="color:var(--danger-red)">--</span></div>
            </div>
            <div id="mission-overlay">MISI: <span id="current-mission-text"></span></div>
        </div>
        <div class="hud-panel" style="min-width: 160px; align-items: flex-start;">
            <span style="color:var(--tech-cyan)">TOYA PURITY</span>
            <div class="purity-container"><div class="purity-fill" id="hud-purity" style="background-color: var(--danger-red);"></div></div>
        </div>
    </div>

    <!-- RPG Controls (BOSS BATTLE) -->
    <div id="rpg-controls">
        <div class="rpg-btn" id="btn-dash" onclick="app.currentChapter.dash()">DASH</div>
        <div class="rpg-btn" id="btn-skill" onclick="app.currentChapter.skill()">SKILL</div>
        <div class="rpg-btn" id="btn-atk" onclick="app.currentChapter.attack()">ATK</div>
    </div>

    <!-- D-PAD VIRTUAL (CHAPTER 3 MOBILE) -->
    <div id="dpad-controls">
        <div class="dpad-btn dpad-up" data-key="ArrowUp">â–²</div>
        <div class="dpad-btn dpad-left" data-key="ArrowLeft">â—€</div>
        <div class="dpad-btn dpad-center" data-key="Space">BOMB</div>
        <div class="dpad-btn dpad-right" data-key="ArrowRight">â–¶</div>
        <div class="dpad-btn dpad-down" data-key="ArrowDown">â–¼</div>
    </div>

    <!-- SCREENS -->
    <div id="screen-splash" class="ui-screen active">
        <div style="width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center;">
            <div id="loading-pct-large">0%</div>
            <div id="terminal-output"></div>
            <div class="loading-bar-container"><div class="loading-bar-fill" id="loading-fill"></div></div>
        </div>
    </div>

    <!-- Audio Setup Screen -->
    <div id="screen-audio" class="ui-screen">
        <div class="panel" style="text-align: center; display: flex; flex-direction: column; align-items: center; max-width: 450px;">
            <div class="audio-icon-container">
                <img src="images/icon_headset.png" class="audio-icon-img" alt="Audio Setup">
            </div>
            <h2 style="color: var(--tech-cyan); font-family: 'Orbitron'; margin: 0 0 10px 0;">PENGATURAN AUDIO</h2>
            <p style="color: #ccc; margin-bottom: 25px;">Game ini memiliki latar musik. Gunakan headset untuk pengalaman terbaik.</p>
            <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                <button class="btn-ml btn-anim" onclick="app.initAudioContext(true)">
                    <span style="font-size: 1.2rem;">ðŸ”Š</span> NYALAKAN MUSIK
                </button>
                <button class="btn-ml" style="background: transparent; border-color: #555; color: #888; box-shadow: none;" onclick="app.initAudioContext(false)">
                    <span style="font-size: 1.2rem;">ðŸ”‡</span> MAIN TANPA SUARA
                </button>
            </div>
        </div>
    </div>

    <div id="screen-loading" class="ui-screen">
        <div class="spinner"></div>
        <h2>SINKRONISASI JARINGAN...</h2>
        <p style="color:#aaa; font-family:'Rajdhani'">Menghubungkan ke Telaga Dunia</p>
    </div>
    
    <!-- ABOUT SCREEN -->
    <div id="screen-about" class="ui-screen" style="z-index: 200; background: rgba(0,0,0,0.9);">
        <div class="panel" style="text-align:center;">
            <div class="close-btn" onclick="app.toggleAbout()">X</div>
            <h2 style="color:var(--accent-gold); font-family: 'Orbitron';">TENTANG PENGEMBANG</h2>
            <img src="images/logo_main.png" style="width:150px; margin-bottom:10px;" onerror="this.style.display='none'">
            <h3 style="color:var(--tech-cyan); margin:0;">TOYA GUARDIANS</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-top:5px;">Tirtatelaga Defense System</p>
            <p style="border-top:1px solid #333; border-bottom:1px solid #333; padding:10px 0; margin:15px 0;">
                Versi: 20.0 (ARPG Update)<br>
                <span style="font-size:0.8rem; color:var(--success-green);">Real-Time Action Battle</span>
            </p>
            <p style="font-size:0.8rem; color:#888;">Dikembangkan oleh:</p>
            <h3 style="color:white; margin:5px 0;">TIM GELOMBANG UTARA</h3>
            <p style="font-size:0.8rem; color:#888;">SMK Negeri 1 Brondong</p>
            <br>
            <p style="font-size:0.7rem; color:#555;">Assets by: Gemini AI & Custom Logic</p>
        </div>
    </div>

    <div id="screen-title" class="ui-screen">
        
        <!-- --- TOMBOL DEBUG (UNTUK TESTING) --- -->
        <div style="position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 9999;">
            <div style="background:red; color:white; font-size:0.7rem; padding:2px 5px; font-weight:bold;">DEBUG MODE</div>
            <button class="btn-ml" style="font-size: 0.7rem; padding: 5px; width: auto; background: #800000; border-color: red;" onclick="app.debugJumpBoss()">LOMPAT KE BOSS</button>
            <button class="btn-ml" style="font-size: 0.7rem; padding: 5px; width: auto; background: #4B0082; border-color: violet;" onclick="app.startEndingCinematic()">LOMPAT KE ENDING</button>
        </div>
        <!-- ----------------------------------- -->

        <div id="logo-container">
            <img id="logo-img" src="images/logo_main.png" alt="TOYA GUARDIANS" onerror="this.style.display='none'">
            <img id="subtitle-img" src="images/subtitle.png" alt="TIRTATELAGA DEFENSE" onerror="this.style.display='none'">
        </div>
        <div class="panel" style="background:transparent; border:none; box-shadow:none; margin-top:10px;">
            <button class="btn-ml btn-anim" onclick="app.goToRegister()">MULAI MISI BARU</button>
            <button class="btn-ml btn-anim" style="background: #002244; border-color:#004488;" onclick="app.showLeaderboard()">HALL OF GUARDIANS (NASIONAL)</button>
        </div>
        <p style="position:absolute; bottom:10px; color:var(--tech-cyan); font-size:0.8rem; text-shadow:0 0 5px black;">Ver. 20.0 (ARPG Matrix)</p>

        <!-- BADGE GEMINI (NEW) -->
        <div class="gemini-badge">
            <span style="font-size:1.2rem;">âœ¦</span> Made with Gemini
        </div>
    </div>

    <div id="screen-register" class="ui-screen">
        <div class="reg-illustration"><img src="images/hero_male.png" alt="Guardian"></div>
        <div class="panel">
            <div class="close-btn" onclick="app.switchScreen('screen-title')">X</div>
            <h2 style="color:var(--primary-blue); text-align:center; margin-top:0;">DATA GUARDIAN</h2>
            <div class="form-group"><label>CODENAME</label><input type="text" id="reg-name" placeholder="Ex: CyberOne" maxlength="12"></div>
            <div class="form-group"><label>PROVINSI</label><select id="reg-prov" onchange="app.populateCities()"><option value="">Pilih Provinsi...</option></select></div>
            <div class="form-group"><label>KOTA / KAB</label><select id="reg-city" disabled onchange="app.populateDistricts()"><option>-</option></select></div>
            <div class="form-group"><label>KECAMATAN</label><select id="reg-district" disabled><option>-</option></select></div>
            <div class="form-group"><label>SEKOLAH</label><input type="text" id="reg-school" placeholder="Nama Sekolah..." oninput="this.value = this.value.toUpperCase()"></div>
            <button class="btn-ml" onclick="app.submitRegistration()">LANJUT</button>
        </div>
    </div>

    <div id="screen-char" class="ui-screen">
        <div class="panel" style="max-width: 600px;">
            <h2 style="text-align:center; color:var(--tech-cyan);">PILIH AVATAR</h2>
            <div class="char-grid">
                <div class="char-card selected" id="char-1" onclick="app.selectChar(1)">
                    <img src="images/hero_male.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">TECH BOY</div>
                </div>
                <div class="char-card" id="char-2" onclick="app.selectChar(2)">
                    <img src="images/hero_female_hijab.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">HIJAB HERO</div>
                </div>
                <div class="char-card" id="char-3" onclick="app.selectChar(3)">
                    <img src="images/hero_female.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">CYBER GIRL</div>
                </div>
            </div>
            <button class="btn-ml" onclick="app.startStory()">DEPLOY</button>
        </div>
    </div>

    <div id="screen-story" class="ui-screen" onclick="story.next()">
        <div id="story-bg"></div>
        <div class="dialogue-box">
            <div class="char-portrait"><img id="story-portrait" src="images/npc_rex.png"></div>
            <div class="dialogue-text"><h3 id="story-speaker">NAME</h3><p id="story-text">...</p></div>
            <div class="next-arrow">â–¼</div>
        </div>
    </div>

    <div id="screen-leaderboard" class="ui-screen">
        <div class="panel" style="height: 500px; display:flex; flex-direction:column; max-width:600px; width:95%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="color:var(--accent-gold); margin:0;">HALL OF GUARDIANS</h2>
                <div id="lb-status-badge" class="sync-badge status-loading">CONNECTING...</div>
            </div>
            
            <div class="lb-controls">
                <select id="lb-filter" class="lb-select" onchange="app.renderLeaderboard()">
                    <option value="all">LINGKUP: NASIONAL</option>
                    <option value="prov">LINGKUP: PROVINSI</option>
                    <option value="city">LINGKUP: KOTA/KAB</option>
                    <option value="district">LINGKUP: KECAMATAN</option>
                    <option value="school">LINGKUP: SEKOLAH</option>
                </select>
                <!-- MENU SUB-FILTER TAMBAHAN (DINAMIS) -->
                <select id="lb-sub-filter" class="lb-select" style="display:none; background:#002244; border-color:var(--tech-cyan);" onchange="app.applySubFilter()">
                    <option value="">- Pilih Detail -</option>
                </select>
            </div>
            
            <h3 id="lb-current-scope" style="margin:5px 0; color:var(--tech-cyan); font-size:0.9rem; border-bottom:1px solid #334; padding-bottom:5px;">Peringkat: NASIONAL</h3>
            <div id="lb-sync-text" class="sync-status">Mengambil data dari server...</div>

            <div style="overflow-y:auto; flex:1; border:1px solid #334; padding:5px;">
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th style="width:30px">#</th>
                            <th>GUARDIAN</th>
                            <th>SEKOLAH</th>
                            <th>LOKASI</th>
                            <th>SKOR</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
            <button class="btn-ml btn-anim" style="background:#002244; margin-top:10px;" onclick="app.switchScreen('screen-title')">KEMBALI</button>
        </div>
    </div>

    <!-- Chapter Title Screen 1 -->
    <div id="screen-title-ch1" class="ui-screen">
        <h1 style="color:var(--primary-blue); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(0, 168, 255, 0.5);">CHAPTER 1</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">DASAR KEAMANAN JARINGAN</h2>
        <p style="color:#aaa;">Persiapan Infiltrasi Server Utama</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter1Story()">LANJUT</button>
    </div>

    <!-- Chapter Title Screen 2 -->
    <div id="screen-title-ch2" class="ui-screen">
        <h1 style="color:var(--danger-red); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(255, 68, 68, 0.5);">CHAPTER 2</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">PERTAHANAN FIREWALL</h2>
        <p style="color:#aaa;">Menghalau Serangan Genderuwo</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter2Intro()">LANJUT</button>
    </div>

    <!-- Chapter Title Screen 3 -->
    <div id="screen-title-ch3" class="ui-screen">
        <h1 style="color:var(--accent-gold); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(255, 215, 0, 0.5);">CHAPTER 3</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">INVESTIGASI SERANGAN</h2>
        <p style="color:#aaa;">Melacak Posisi Boss & Forensik Digital</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter3Intro()">LANJUT</button>
    </div>

    <!-- Quiz Screen -->
    <div id="screen-quiz" class="ui-screen">
        <div class="panel" style="max-width: 600px; padding: 20px;">
            <h2 id="quiz-title-text" style="color:var(--accent-gold); text-align:center; margin-top:0; font-family:'Orbitron'">KODE AKSES PINTU </h2>
            <div id="quiz-code-display" style="font-family:'VT323', monospace; font-size:2.5rem; letter-spacing:15px; color:var(--success-green); text-align:center; background:rgba(0,0,0,0.5); padding:10px; margin-bottom:20px; border:1px dashed #334;">
                <span id="digit-0">-</span><span id="digit-1">-</span><span id="digit-2">-</span><span id="digit-3">-</span><span id="digit-4">-</span>
            </div>
            
            <p style="color:var(--tech-cyan); font-weight:bold;">PHASE <span id="quiz-phase-num">1</span> / 5</p>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:5px; margin-bottom:15px;">
                <p id="quiz-question-text" style="font-size:1.1rem; color:white; margin:0;">Pertanyaan akan muncul di sini.</p>
            </div>
            
            <div id="quiz-options-container" class="flex flex-col gap-2">
                <!-- Answer options will be injected here -->
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <button class="btn-ml" id="btn-hint" style="width:150px; padding:8px; font-size:1rem; background:linear-gradient(180deg, #FFD700 0%, #B8860B 100%); border-color:#FFC400;" onclick="app.currentChapter.getHint()">BANTUAN (REX)</button>
                <span id="quiz-feedback" style="font-weight:bold; font-family:'Orbitron'"></span>
            </div>
        </div>
    </div>


    <div id="screen-ending" class="ui-screen">
        <div id="result-panel-container" class="result-panel">
            <h1 id="end-title" class="result-title">MISI SELESAI</h1>
            
            <div class="rank-circle">
                <div id="end-rank">S</div>
            </div>
            
            <div class="score-box">
                <div class="score-label">TOTAL SKOR AKHIR</div>
                <div id="end-score">0</div>
            </div>
            
            <!-- NEW STATISTICS SECTION -->
            <div class="stats-container">
                <div class="stat-item"><span>Enemies:</span> <span id="stat-kills" class="stat-val">0</span></div>
                <div class="stat-item"><span>Max Combo:</span> <span id="stat-combo" class="stat-val">0</span></div>
                <div class="stat-item"><span>Dmg Taken:</span> <span id="stat-dmg" class="stat-val">0</span></div>
                <div class="stat-item"><span>Play Time:</span> <span id="stat-time" class="stat-val">0m</span></div>
            </div>

            <p id="end-msg">Energi Toya Berhasil Dimurnikan!</p>
            <div id="save-status">Menyimpan data...</div>
            
            <button id="btn-victory-action" class="btn-ml btn-anim" style="width:100%" onclick="location.reload()">RE-DEPLOY</button>
        </div>
    </div>

    <!-- MOVED TO BOTTOM FOR HIGHEST Z-INDEX PRIORITY -->
    <!-- CUSTOM MESSAGE BOX -->
    <div id="custom-message-box">
        <img id="msg-icon" src="images/npc_rex.png" alt="Rex">
        <h3 id="msg-title">NOTIFIKASI</h3>
        <div id="msg-body">Pesan akan muncul di sini.</div>
        <button class="btn-msg-ok">OK</button>
    </div>

</div>

<script>
/**
 * TOYA GUARDIANS v20.1: JUICINESS UPDATE
 * - Screen Shake
 * - Combo System
 * - Player HUD
 * - Statistics
 */

// ... [KODE SEBELUMNYA TETAP SAMA] ...
// --- GOOGLE SHEETS CONFIGURATION ---
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTFofoEEYIn0kMDqTbbjU9KghQA9Yre-ZrbEbxV9mpWsUlAkQ4nBdj0V6rqrZLVFRX/exec"; 

const ASSETS = {
    // FIX: Hero 1 (Laki-laki) menggunakan asset Laki-laki
    //hero1_idle: 'images/hero_male.png', 
    hero1_idle: 'images/hero1_walk1.png', // SEBELUMNYA TERTUKAR DENGAN hero2
    hero1_walk1: 'images/hero1_walk1.png', 
    hero1_walk2: 'images/hero1_walk2.png', 
    hero1_walk3: 'images/hero1_walk3.png', 
    hero1_walk4: 'images/hero1_walk4.png',
    hero1_tembak: 'images/hero1_tembak.png',

    // FIX: Hero 2 (Hijab) menggunakan asset Hijab (sebelumnya file ini dipakai hero1)
    //hero2_idle: 'images/hero_female_hijab.png', 
    hero2_idle: 'images/hero2_walk1.png', 
    hero2_walk1: 'images/hero2_walk1.png', 
    hero2_walk2: 'images/hero2_walk2.png', 
    hero2_walk3: 'images/hero2_walk3.png', 
    hero2_walk4: 'images/hero2_walk4.png',
    hero2_tembak: 'images/hero2_tembak.png',

    // Hero 3 (Perempuan Cyber) - Tetap
    //hero3_idle: 'images/hero_female.png',
    hero3_idle: 'images/hero3_walk1.png', 
    hero3_walk1: 'images/hero3_walk1.png', 
    hero3_walk2: 'images/hero3_walk2.png', 
    hero3_walk3: 'images/hero3_walk3.png', 
    hero3_walk4: 'images/hero3_walk4.png',
    hero3_tembak: 'images/hero3_tembak.png',
	
	rex: 'images/npc_rex.png', virus: 'images/enemy_virus.png', narrator: 'images/narrator.png', androidtoya: 'images/androidtoya.png',
    //gambar
	bg_title: 'images/bg_title.png', bg_server: 'images/bg_server.png', bg_firewall: 'images/bg_firewall.png', bg_noc: 'images/bg_noc.png',bg_open1: 'images/bg_open1.png',bg_open2: 'images/bg_open2.png',
	bg_masuklt1nyala: 'images/bg_masuklt1nyala.png', bg_menujulift: 'images/bg_menujulift.png', bg_firewall1: 'images/bg_firewall1.png',  bg_firewall2: 'images/bg_firewall2.png',
    bg_firewall3: 'images/bg_firewall3.png', 
	bg_open3: 'images/bg_open3.png',bg_open4: 'images/bg_open4.png',bg_open5: 'images/bg_open5.png', bg_masuklt1 : 'images/bg_masuklt1.png',
	bg_siap: 'images/bg_siap.png', bg_monitor: 'images/bg_monitor.png',
	bg_tutorend: 'images/bg_tutorend.png',bg_victory: 'images/bg_victory.png',bg_rtraining: 'images/bg_rtraining.png',bg_rtraining1: 'images/bg_rtraining1.png',bg_jaringan: 'images/bg_jaringan.png',
    bg_kabel: 'images/bg_kabel.png', bg_bomber: 'images/bg_server.png',
	item_pc: 'images/item_pc.png', item_server: 'images/item_server.png', item_tablet: 'images/item_tablet.png', item_laptop: 'images/item_laptop.png',
    item_switch: 'images/item_switch.png', item_firewall: 'images/item_firewall.png', item_keylogger: 'images/item_keylogger.png',
    item_door: 'images/item_door.png',
    icon_http: 'images/icon_http.png', icon_ssh: 'images/icon_ssh.png', icon_email: 'images/icon_email.png',
    icon_sql: 'images/icon_sql.png', icon_ping: 'images/icon_ping.png', icon_telnet: 'images/icon_telnet.png', icon_exe: 'images/icon_exe.png',
    subtitle: 'images/subtitle.png',
    zone_allow: 'images/zone_allow.png',
    zone_block: 'images/zone_block.png',
    pintu_keluar: 'images/item_door.png',
    icon_headset: 'images/icon_headset.png',
    
    // --- NEW ASSETS FOR BOMBERMAN ---
    tile_tembok: 'images/tile_tembok.png',
    tile_meledak: 'images/tile_meledak.png',
    bomb_lt1: 'images/bomb_lt1.png',
    bomb_lt2: 'images/bomb_lt2.png',
    bomb_lt3: 'images/bomb_lt3.png'
};

// --- TAMBAHAN ASSET ENDING ---
for(let i=1; i<=14; i++) {
    ASSETS[`ending${i}`] = `ending/${i}.png`;
}

const DATA_INDONESIA = {
    "Aceh": {
        "Banda Aceh": ["Baiturrahman", "Banda Raya", "Jaya Baru", "Kuta Alam", "Kuta Raja", "Lueng Bata", "Meuraxa", "Syiah Kuala", "Ulee Kareng"],
        "Sabang": ["Sukakarya", "Sukajaya"],
        "Lhokseumawe": ["Banda Sakti", "Blang Mangat", "Muara Dua", "Muara Satu"],
        "Langsa": ["Langsa Barat", "Langsa Baro", "Langsa Kota", "Langsa Lama", "Langsa Timur"],
        "Subulussalam": ["Longkib", "Penanggalan", "Rundeng", "Simpang Kiri", "Sultan Daulat"]
    },
    "Jawa Timur": {
        "Surabaya": ["Gubeng", "Tegalsari", "Genteng", "Wonokromo", "Rungkut", "Sukolilo"],
        "Malang": ["Klojen", "Blimbing", "Kedungkandang", "Lowokwaru", "Sukun"],
		"Lamongan": ["Brondong", "Tlogoretno", "Sedayulawas", "Brengkok", "Labuhan", "Paciran", "Babat"],
        "Gresik": ["Gresik Kota", "Kebomas", "Manyar", "Driyorejo"]
    },
    "Jawa Barat": {
        "Bandung": ["Cicendo", "Coblong", "Andir", "Buahbatu", "Kiaracondong"],
        "Bekasi": ["Bekasi Barat", "Bekasi Timur", "Bekasi Selatan", "Jatiasih"],
        "Bogor": ["Bogor Tengah", "Bogor Barat", "Bogor Selatan"]
    },
    "DKI Jakarta": {
        "Jakarta Pusat": ["Gambir", "Tanah Abang", "Menteng", "Senen", "Cempaka Putih"],
        "Jakarta Selatan": ["Kebayoran Baru", "Kebayoran Lama", "Cilandak", "Pasar Minggu", "Tebet"]
    }
};

const BANK_SOAL_CH1 = [
    { q: "Apa nama serangan yang membanjiri server dengan lalu lintas palsu agar layanan lumpuh?", options: [{text:"DDoS",correct:true},{text:"Phishing",correct:false},{text:"Trojan",correct:false},{text:"Worm",correct:false}], hint:"Distributed Denial of Service." },
    { q: "Tiga pilar utama keamanan informasi dikenal dengan singkatan CIA. Apa kepanjangannya?", options: [{text:"Confidentiality, Integrity, Availability",correct:true},{text:"Control, Intelligence, Access",correct:false},{text:"Cyber, Internet, Authority",correct:false},{text:"Code, Input, Algorithm",correct:false}], hint:"Kerahasiaan, Integritas, Ketersediaan." },
    { q: "Jenis malware yang menyamar sebagai program berguna namun berisi kode berbahaya disebut...", options: [{text:"Trojan Horse",correct:true},{text:"Worm",correct:false},{text:"Spyware",correct:false},{text:"Adware",correct:false}], hint:"Seperti kuda kayu Yunani kuno." },
    { q: "Serangan di mana peretas menempatkan diri di antara dua pihak yang berkomunikasi disebut...", options: [{text:"Man-in-the-Middle (MITM)",correct:true},{text:"Brute Force",correct:false},{text:"SQL Injection",correct:false},{text:"Ransomware",correct:false}], hint:"Orang di tengah-tengah." },
    { q: "Teknik memalsukan identitas pengirim (seperti IP address) untuk menipu penerima disebut...", options: [{text:"Spoofing",correct:true},{text:"Sniffing",correct:false},{text:"Hacking",correct:false},{text:"Phishing",correct:false}], hint:"Mirip kata 'Spoof' (parodi/palsu)." }
];

const BANK_SOAL_CH2 = [
    { q: "Apa perbedaan mendasar antara Firewall dan IDS (Intrusion Detection System)?", options: [{text:"Firewall memblokir akses, IDS mendeteksi serangan",correct:true},{text:"Firewall hanya mencatat log, IDS memblokir virus",correct:false},{text:"Keduanya sama saja",correct:false},{text:"IDS hanya untuk WiFi",correct:false}], hint:"Satu bertindak sebagai gerbang (memblokir), satu sebagai alarm (mendeteksi)." },
    { q: "Teknologi apa yang memungkinkan akses aman ke jaringan privat melalui jaringan publik (internet)?", options: [{text:"VPN (Virtual Private Network)",correct:true},{text:"VLAN",correct:false},{text:"WAN",correct:false},{text:"LAN",correct:false}], hint:"Jaringan 'Pribadi Virtual'." },
    { q: "Dalam konfigurasi firewall, aturan apa yang paling aman diterapkan sebagai standar?", options: [{text:"Default Deny (Blokir semua kecuali yang diizinkan)",correct:true},{text:"Default Allow (Izinkan semua)",correct:false},{text:"Block Port 80",correct:false},{text:"Allow All Traffic",correct:false}], hint:"Tolak semua secara default." },
    { q: "Apa fungsi dari ACL (Access Control List) pada router atau firewall?", options: [{text:"Mengontrol lalu lintas berdasarkan aturan (IP/Port)",correct:true},{text:"Mempercepat koneksi internet",correct:false},{text:"Menyimpan password pengguna",correct:false},{text:"Mendeteksi kerusakan kabel",correct:false}], hint:"Daftar untuk mengontrol akses." },
    { q: "Tindakan 'Hardening' pada perangkat jaringan meliputi...", options: [{text:"Menutup port yang tidak perlu & update firmware",correct:true},{text:"Menambah RAM perangkat",correct:false},{text:"Membersihkan debu perangkat",correct:false},{text:"Memasang kipas tambahan",correct:false}], hint:"Memperkuat sistem dari sisi software/konfigurasi." }
];

const BANK_SOAL_CH3 = [
    { q: "Aplikasi apa yang paling umum digunakan untuk menganalisis paket data jaringan (Packet Sniffer)?", options: [{text:"Wireshark",correct:true},{text:"Photoshop",correct:false},{text:"Notepad++",correct:false},{text:"WinRAR",correct:false}], hint:"Ikonnya sirip hiu." },
    { q: "Di dalam Wireshark, warna merah pada baris paket biasanya menandakan...", options: [{text:"Paket Error / Reset (RST)",correct:true},{text:"Paket Aman",correct:false},{text:"Paket Gambar",correct:false},{text:"Paket Email",correct:false}], hint:"Warna bahaya." },
    { q: "Langkah pertama dalam Incident Response menurut standar NIST adalah...", options: [{text:"Preparation (Persiapan)",correct:true},{text:"Detection",correct:false},{text:"Eradication",correct:false},{text:"Recovery",correct:false}], hint:"Sedia payung sebelum hujan." },
    { q: "Apa itu 'Log File' dalam server?", options: [{text:"Catatan aktivitas sistem dan user",correct:true},{text:"Batang kayu",correct:false},{text:"File sampah",correct:false},{text:"Program antivirus",correct:false}], hint:"Jejak digital." },
    { q: "Jika ditemukan login sukses di jam 3 pagi dari IP asing, ini indikasi...", options: [{text:"Compromised Account (Akun jebol)",correct:true},{text:"Server update",correct:false},{text:"Admin lembur",correct:false},{text:"Listrik padam",correct:false}], hint:"Aktivitas anomali." }
];

const BANK_SOAL_KABEL = [
    { q: "Hubungkan PC ke Switch (Straight)", srcType: 'item_pc', targetType: 'item_switch', cableType: 'straight' },
    { q: "Hubungkan Laptop ke Switch (Straight)", srcType: 'item_laptop', targetType: 'item_switch', cableType: 'straight' },
    { q: "Hubungkan Server ke Switch (Straight)", srcType: 'item_server', targetType: 'item_switch', cableType: 'straight' },
    { q: "Hubungkan Switch ke Firewall (Straight)", srcType: 'item_switch', targetType: 'item_firewall', cableType: 'straight' },
    { q: "Hubungkan PC ke Laptop (Crossover)", srcType: 'item_pc', targetType: 'item_laptop', cableType: 'crossover' },
    { q: "Hubungkan Switch ke Switch (Crossover)", srcType: 'item_switch', targetType: 'item_switch', cableType: 'crossover' },
    { q: "Hubungkan PC ke Server (Crossover)", srcType: 'item_pc', targetType: 'item_server', cableType: 'crossover' },
    { q: "Hubungkan Laptop ke Server (Crossover)", srcType: 'item_laptop', targetType: 'item_server', cableType: 'crossover' },
    { q: "Hubungkan Firewall ke PC (Crossover)", srcType: 'item_firewall', targetType: 'item_pc', cableType: 'crossover' },
    { q: "Hubungkan Switch ke Server (Straight)", srcType: 'item_switch', targetType: 'item_server', cableType: 'straight' }
];

// ... [KODE SAVE SYSTEM & AUDIO MGR TETAP SAMA] ...
// --- SAVE SYSTEM MODIFIED: PERSISTENT PROFILE & LEADERBOARD ---
const SaveSystem = {
    LB_KEY: 'toya_lb', // Key untuk leaderboard lokal
    PROFILE_KEY: 'toya_profile', // Key untuk profil user agar tidak hilang saat reload

    // Simpan Profil Player agar bertahan saat Refresh
    saveProfile: function(playerData) {
        localStorage.setItem(this.PROFILE_KEY, JSON.stringify(playerData));
    },

    loadProfile: function() {
        try {
            return JSON.parse(localStorage.getItem(this.PROFILE_KEY));
        } catch(e) { return null; }
    },
    
    // Simpan ke Cache Lokal (Hanya untuk Leaderboard Display)
    updateLocalLeaderboard: function(playerData) {
        try {
            let lb = JSON.parse(localStorage.getItem(this.LB_KEY) || '[]');
            // Cari apakah player ini sudah ada di daftar
            const index = lb.findIndex(p => p.name === playerData.name && (p.school||"").trim().toUpperCase() === (playerData.school||"").trim().toUpperCase());
            
            if (index !== -1) {
                // Jika sudah ada, update skor jika lebih tinggi
                if (playerData.score > lb[index].score) {
                    lb[index] = playerData;
                }
            } else {
                // Jika belum ada, tambahkan baru
                lb.push(playerData);
            }
            
            localStorage.setItem(this.LB_KEY, JSON.stringify(lb));
            // Juga update profil terakhir
            this.saveProfile(playerData);
            console.log("Leaderboard Cache Updated");
        } catch (e) {
            console.warn("Gagal update leaderboard lokal", e);
        }
    },

    // Kirim data lengkap ke Cloud (Google Sheet)
    saveCloud: async function(playerData) {
        // Cek apakah URL masih placeholder
        if(GOOGLE_SCRIPT_URL.includes("123456789")) {
            console.warn("Script URL belum dikonfigurasi. Data hanya disimpan lokal.");
            return false;
        }

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'save',
                    data: playerData 
                })
            });
            console.log("Data terkirim ke Cloud (Fire-and-forget)");
            return true;
        } catch (e) {
            console.error("Cloud Save Gagal (Mungkin Offline)", e);
            return false;
        }
    },

    fetchLeaderboard: async function() {
        if(GOOGLE_SCRIPT_URL.includes("123456789")) return { status: 'config_error' };
        
        try {
            // Kita gunakan abort controller untuk timeout jika koneksi lambat (3 detik)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const url = `${GOOGLE_SCRIPT_URL}?action=getLeaderboard`;
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error("Server response not ok");

            const data = await response.json();
            return data;
        } catch (e) {
            console.warn("Gagal ambil data cloud:", e);
            return { status: 'error', error: e };
        }
    },
    
    // --- UPDATED: Generate Mock Data for Simulation (LEBIH BANYAK DATA) ---
    getMockData: function() {
        const names = ["Andi", "Budi", "Citra", "Dewi", "Eko", "Fajar", "Gita", "Hana", "Indra", "Joko", "Kiki", "Lina", "Maya", "Nina", "Oscar", "Putri", "Qory", "Rini", "Sari", "Tono", "Bayu", "Rizky", "Adit", "Putra", "Dinda"];
        const mockData = [];
        
        // 1. Generate random players (General)
        for(let i=0; i<30; i++) {
            const name = names[Math.floor(Math.random() * names.length)] + "_" + Math.floor(Math.random()*100);
            const provs = Object.keys(DATA_INDONESIA);
            const prov = provs[Math.floor(Math.random() * provs.length)];
            const cities = Object.keys(DATA_INDONESIA[prov]);
            const city = cities[Math.floor(Math.random() * cities.length)];
            const districts = DATA_INDONESIA[prov][city];
            const district = districts[Math.floor(Math.random() * districts.length)];
            
            mockData.push({
                name: name,
                score: Math.floor(Math.random() * 5000) + 500,
                school: "SMK " + city.toUpperCase() + " " + Math.floor(Math.random()*5+1),
                prov: prov,
                city: city,
                district: district,
                charId: Math.floor(Math.random()*3)+1
            });
        }
        
        // 2. Generate SPECIFIC High Volume Data for Jawa Timur (Agar Filter Terasa)
        const jatimCities = Object.keys(DATA_INDONESIA["Jawa Timur"]);
        for(let i=0; i<40; i++) { // 40 Pemain Tambahan Jatim
             const name = names[Math.floor(Math.random() * names.length)] + "_JATIM" + i;
             const city = jatimCities[Math.floor(Math.random() * jatimCities.length)];
             const districts = DATA_INDONESIA["Jawa Timur"][city];
             const district = districts[Math.floor(Math.random() * districts.length)];
             
             mockData.push({
                name: name,
                score: Math.floor(Math.random() * 8000) + 1000,
                school: "SMK " + city.toUpperCase() + " NEGERI",
                prov: "Jawa Timur",
                city: city,
                district: district,
                charId: Math.floor(Math.random()*3)+1
             });
        }

        // Add Top Players
        mockData.push({name: "TKJ_Skansabro", score: 9500, school: "SMKN 1 BRONDONG", prov: "Jawa Timur", city: "Lamongan", district: "Brondong"});
        mockData.push({name: "Arema_Code", score: 9200, school: "SMKN 4 MALANG", prov: "Jawa Timur", city: "Malang", district: "Klojen"});
        mockData.push({name: "Lamongan_Cyber", score: 8800, school: "SMKN 1 BRONDONG", prov: "Jawa Timur", city: "Lamongan", district: "Brondong"});
        
        return mockData;
    }
};

const AudioMgr = {
    isMuted: false,
    currentTrack: 'bgm-player',
    contextInitialized: false,
    initContext: function() {
        if(!this.contextInitialized) {
            this.contextInitialized = true;
            ['bgm-player', 'bgm-shooter', 'bgm-bomber', 'bgm-boss', 'bgm-ending'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.load(); }
            });
        }
    },
    playMusic: function(trackId) {
        if (this.isMuted) return;
        this.stopAll();
        this.currentTrack = trackId;
        const t = document.getElementById(trackId);
        if(t) { 
            t.volume = 0.5; t.currentTime = 0; 
            const promise = t.play();
            if (promise !== undefined) {
                promise.catch(error => {
                    console.log("Autoplay prevented. Interaction required.");
                });
            }
        }
    },
    stopAll: function() {
        ['bgm-player', 'bgm-shooter', 'bgm-bomber', 'bgm-boss', 'bgm-ending'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.pause();
        });
    },
    playSFX: function(id) { if(!this.isMuted) { const s=document.getElementById(id); if(s){s.currentTime=0; s.play().catch(()=>{});} } },
    toggle: function() { 
        this.isMuted = !this.isMuted; 
        const btn = document.querySelector('.btn-music-toggle'); 
        if(this.isMuted) { this.stopAll(); btn.style.opacity="0.5"; btn.innerHTML='ðŸ”‡'; } 
        else { this.playMusic(this.currentTrack); btn.style.opacity="1"; btn.innerHTML='â™ª'; } 
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const AppState = { SPLASH: -1, AUDIO_SETUP: -0.5, TITLE: 0, STORY: 1, TUTORIAL: 1.5, GAME_CH1: 2, BRIDGE_CH1: 2.5, GAME_CH2: 3, GAME_CH2_CONFIG: 3.2, GAME_CH2_QUIZ: 3.5, BRIDGE_CH2: 3.8, GAME_CH3: 4, GAME_CH3_BOMBER: 4.2, GAME_CH3_QUIZ: 4.5, GAME_CH3_IR: 4.8, BOSS_BATTLE: 4.9, ENDING_CINEMATIC: 5, VICTORY_SCORE: 5.5, CREDITS: 6, ENDING: 5.5 };

// --- FIX 1: SIMPLIFIED & FORCED SHOW MESSAGE ---
function showMessage(title, body, onCloseCallback) {
    const box = document.getElementById('custom-message-box');
    
    // 1. Reset Content
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-body').innerHTML = body;
    document.getElementById('msg-icon').style.display = 'none'; 
    
    // 2. HARD FORCE DISPLAY STYLE (Override CSS)
    box.style.setProperty('display', 'flex', 'important');
    box.style.zIndex = '20000'; // Super high Z-Index
    box.style.opacity = '1';

    const btn = box.querySelector('.btn-msg-ok');
    
    // 3. Clear existing listeners (Clone element approach is safest against old events)
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    // 4. Attach new Listener
    newBtn.onclick = function(e) {
        e.preventDefault(); // Prevent accidental propagation
        box.style.display = 'none';
        AudioMgr.playSFX('sfx-click');
        if(onCloseCallback) onCloseCallback();
    };

    AudioMgr.playSFX('sfx-click');
}

function showRexMessage(title, body) {
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-body').innerText = body;
    const rexIcon = document.getElementById('msg-icon');
    rexIcon.style.display = 'block'; 
    rexIcon.src = ASSETS.rex; 
    
    const box = document.getElementById('custom-message-box');
    box.style.setProperty('display', 'flex', 'important');
    
    // Use simple close for hint
    const btn = box.querySelector('.btn-msg-ok');
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.onclick = function() {
        box.style.display = 'none';
        AudioMgr.playSFX('sfx-click');
    };

    AudioMgr.playSFX('sfx-click');
}

function spawnFloatingScore(text) {
    const el = document.createElement('div');
    el.className = 'float-score';
    el.innerText = text;
    const x = 400 + (Math.random() * 100 - 50);
    const y = 300 + (Math.random() * 50 - 25);
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    document.getElementById('game-container').appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function triggerLightning() {
    const overlay = document.getElementById('lightning-overlay');
    overlay.style.opacity = '0.8';
    overlay.style.transition = 'none';
    setTimeout(() => {
        overlay.style.transition = 'opacity 0.5s ease-out';
        overlay.style.opacity = '0';
    }, 50);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    ctx.beginPath();
    let lx = Math.random() * 800;
    let ly = 0;
    ctx.moveTo(lx, ly);
    while(ly < 600) {
        lx += (Math.random() - 0.5) * 50;
        ly += Math.random() * 50;
        ctx.lineTo(lx, ly);
    }
    ctx.stroke();
    //AudioMgr.playSFX('sfx-click');
}

// ... [CLASS GAME APP, CHAPTER 2, CHAPTER 3 BOMBER, ETC TETAP SAMA] ...

class GameApp {
    constructor() {
        // LOAD SAVED PROFILE ON STARTUP
        const savedProfile = SaveSystem.loadProfile();
        if (savedProfile) {
            this.player = savedProfile;
        } else {
            this.player = { name: "", charId: 1, score: 0, toyaPurity: 20, school: "", prov: "", city: "", district: "", chapter: 0 }; 
        }

        // NEW STATS TRACKING
        this.gameStats = {
            totalKills: 0,
            maxCombo: 0,
            damageTaken: 0,
            startTime: Date.now()
        };
        this.screenShake = 0; // NEW: Screen Shake Value

        this.state = AppState.SPLASH;
        this.currentChapter = null; this.lastTime = 0;
        this.imgs = {};
        let loadedCount = 0;
        const totalAssets = Object.keys(ASSETS).length;

        for (const [k, v] of Object.entries(ASSETS)) { 
            this.imgs[k] = new Image(); 
            this.imgs[k].src = v; 
            this.imgs[k].onload = () => {
                loadedCount++;
                const progress = Math.floor((loadedCount / totalAssets) * 100);
                const pct = document.getElementById('loading-pct-large');
                const fill = document.getElementById('loading-fill');
                if(pct) pct.innerText = progress + "%";
                if(fill) fill.style.width = progress + "%";
                if (loadedCount === totalAssets) this.runSplashTextAnimation();
            };
            this.imgs[k].onerror = () => { 
                if(k.includes('_w')) { let id = k.split('_')[0]+'_idle'; if(this.imgs[id]) this.imgs[k].src = this.imgs[id].src; } else if(k==='narrator') this.imgs[k].src = this.imgs['rex']?this.imgs['rex'].src:''; 
                loadedCount++;
                if (loadedCount === totalAssets) this.runSplashTextAnimation();
            };
        }
        this.initUI();
        this.loop = this.loop.bind(this);

        // --- FIXED: ADD RESIZE HANDLER ---
        window.addEventListener('resize', () => this.resizeGame());
        this.resizeGame(); // Initial call
    }

    // --- NEW FUNCTION: RESIZE GAME (FIXED ASPECT RATIO) ---
    resizeGame() {
        const container = document.getElementById('game-container');
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const gameWidth = 800;
        const gameHeight = 600;

        // Calculate Scale Factor
        const scale = Math.min(
            windowWidth / gameWidth,
            windowHeight / gameHeight
        );

        // Apply Scale Transform
        container.style.transform = `scale(${scale})`;
    }
    
    initAudioContext(enableMusic) {
        AudioMgr.initContext();
        if(enableMusic) {
            AudioMgr.isMuted = false;
            AudioMgr.playMusic('bgm-player');
        } else {
            AudioMgr.isMuted = true;
            const btn = document.querySelector('.btn-music-toggle'); 
            btn.style.opacity="0.5"; 
            btn.innerHTML='ðŸ”‡';
        }
        this.switchScreen('screen-title'); 
        this.state = AppState.TITLE; 
        this.updatePurityDisplay(this.player.toyaPurity); 
    }

    // --- REPLACED saveGame with submitHighscore ---
    submitHighscore() {
        // Update local leaderboard for instant feedback
        SaveSystem.updateLocalLeaderboard(this.player);

        // Cloud Save (Fire and forget)
        const statusEl = document.getElementById('save-status');
        if(statusEl) statusEl.innerText = "Mengirim Skor ke Database...";
        
        SaveSystem.saveCloud(this.player).then(success => {
            if(statusEl) statusEl.innerText = success ? "Skor Tersimpan di Cloud." : "Offline Mode: Skor Disimpan Lokal.";
        });
    }

    addScore(amount) {
        if(isNaN(amount)) { console.warn("Invalid score amount"); return; }
        this.player.score += amount;
        const hudScore = document.getElementById('hud-score');
        if(hudScore) hudScore.innerText = Math.floor(this.player.score);
        spawnFloatingScore(amount >= 0 ? `+${amount}` : `${amount}`);
    }

    getHeroFrames(charId) { const p = 'hero' + charId; return [ this.imgs[p+'_walk1'], this.imgs[p+'_walk2'], this.imgs[p+'_walk3'], this.imgs[p+'_walk4'] ]; }
    getHeroIdle(charId) { return this.imgs['hero'+charId+'_idle']; }
    
    updatePurityDisplay(newPurity) {
        this.player.toyaPurity = Math.min(100, Math.max(0, newPurity));
        const purityEl = document.getElementById('hud-purity');
        if (purityEl) {
            purityEl.style.width = this.player.toyaPurity + "%";
            const r = Math.floor(255 * (1 - this.player.toyaPurity / 100));
            const g = Math.floor(255 * (this.player.toyaPurity / 100) * 0.7); 
            const b = Math.floor(255 * (this.player.toyaPurity / 100));
            purityEl.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        }
    }
    
    toggleAbout() {
        const s = document.getElementById('screen-about');
        if(s.style.display === 'flex') s.style.display = 'none';
        else s.style.display = 'flex';
        AudioMgr.playSFX('sfx-click');
    }

    triggerGameOver() {
        this.active = false;
        if(this.currentChapter && this.currentChapter.cleanup) this.currentChapter.cleanup();
        this.state = AppState.ENDING;
        this.switchScreen('screen-ending');
        
        // CSS Styling Logic for Loss
        const panel = document.getElementById('result-panel-container');
        panel.className = "result-panel result-loss"; // Tambahkan class Merah

        const title = document.getElementById('end-title');
        title.innerText = "MISSION FAILED";
        title.style.color = "var(--danger-red)";
        
        const rank = document.getElementById('end-rank');
        rank.innerText = "F";
        rank.style.color = "var(--danger-red)";
        
        document.getElementById('end-msg').innerText = "Sistem Keamanan Telah Dikuasai Malware!";
        document.getElementById('end-score').innerText = Math.floor(this.player.score);
        
        // --- NEW: Submit score even on loss ---
        this.submitHighscore(); 

        const btn = document.querySelector('#screen-ending button');
        btn.innerText = "COBA LAGI";
        btn.onclick = () => location.reload();
        
        AudioMgr.stopAll();
        AudioMgr.playSFX('sfx-wrong');
    }

    runSplashTextAnimation() {
        requestAnimationFrame(this.loop); 
        const texts = ["MENGHUBUNGKAN KE TELAGA DUNIA...", "MEMINDAI INTEGRITAS DATA...", "MENYIAPKAN PETA DIGITAL...", "PROTOKOL TOYA GUARDIAN AKTIF...", "SISTEM SIAP."];
        let i = 0;
        const out = document.getElementById('terminal-output');
        const totalSteps = texts.length;
        const pct = document.getElementById('loading-pct-large');
        const fill = document.getElementById('loading-fill');
        
        const timer = setInterval(() => {
            if(i < totalSteps) { 
                let d = document.createElement('div'); d.className='terminal-text'; d.innerText="> "+texts[i]; out.appendChild(d); i++; 
                const textProgress = Math.floor((i / totalSteps) * 99);
                if(pct) pct.innerText = textProgress + "%";
                if(fill) fill.style.width = textProgress + "%";
            } else {
                clearInterval(timer);
                if(pct) pct.innerText = "100%";
                if(fill) fill.style.width = "100%";
                
                setTimeout(() => {
                    this.state = AppState.AUDIO_SETUP;
                    this.switchScreen('screen-audio');
                }, 800);
            }
        }, 600);
    }

    initUI() {
        const s = document.getElementById('reg-prov');
        Object.keys(DATA_INDONESIA).forEach(p => { let o=document.createElement('option'); o.innerText=p; s.appendChild(o); });
    }

    // --- FUNGSI DEBUG BARU ---
    debugJumpBoss() {
        // Setup minimal state agar game tidak crash saat lompat
        this.player.charId = this.player.charId || 1; // Default char
        this.player.name = this.player.name || "Tester";
        
        // Hide Title
        this.switchScreen('dummy');
        
        // Setup UI Battle
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "DEBUG: BOSS BATTLE";
        document.getElementById('rpg-controls').style.display = 'flex';

        // Start Boss Logic
        this.state = AppState.BOSS_BATTLE;
        AudioMgr.playMusic('bgm-boss'); // CHANGED: Use boss music
        this.currentChapter = new ChapterBossBattle(this);
        
        showMessage("DEBUG ACCESS", "Melompat langsung ke Boss Battle. Good Luck!");
    }
    // -------------------------

    populateCities() {
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city'); 
        const d = document.getElementById('reg-district');
        c.innerHTML='<option value="-">Pilih Kota/Kab...</option>'; 
        d.innerHTML='<option value="-">-</option>'; d.disabled=true;
        c.disabled=!p;
        if(DATA_INDONESIA[p]) Object.keys(DATA_INDONESIA[p]).forEach(city => { let o=document.createElement('option'); o.innerText=city; c.appendChild(o); });
    }
    populateDistricts() {
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city').value;
        const d = document.getElementById('reg-district');
        d.innerHTML='<option value="-">Pilih Kecamatan...</option>'; d.disabled=!c || c==='-';
        if(DATA_INDONESIA[p] && DATA_INDONESIA[p][c]) {
            DATA_INDONESIA[p][c].forEach(dist => { let o=document.createElement('option'); o.innerText=dist; d.appendChild(o); });
        }
    }

    switchScreen(id) {
        document.querySelectorAll('.ui-screen').forEach(e => e.classList.remove('active'));
        const s = document.getElementById(id); if(s) s.classList.add('active');
        document.getElementById('hud').style.display = 'none';
        document.getElementById('mission-overlay').style.display = 'none';
        
        document.getElementById('rpg-controls').style.display = 'none';
        // Hide D-Pad by default, only enabled in specific chapters
        if(document.getElementById('dpad-controls')) {
            document.getElementById('dpad-controls').style.display = 'none';
        }

        const aboutBtn = document.getElementById('btn-about');
        const fsBtn = document.getElementById('btn-fullscreen');
        
        // Atur visibilitas tombol menu
        if (id === 'screen-title') {
            aboutBtn.style.display = 'flex';
            if(fsBtn) fsBtn.style.display = 'flex';
            AudioMgr.playMusic('bgm-player');
        } else if (id === 'dummy') { // Gameplay mode
            aboutBtn.style.display = 'none';
            if(fsBtn) fsBtn.style.display = 'flex';
        } else {
            aboutBtn.style.display = 'none';
            if(fsBtn) fsBtn.style.display = 'flex'; 
        }
    }
    toggleMusic() { AudioMgr.toggle(); }
    
    // --- UPDATED: Full Screen Logic with Scaling ---
    toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
                document.body.classList.add('fullscreen-mode');
                // Timeout needed to wait for browser layout update
                setTimeout(() => this.resizeGame(), 100);
            }).catch(err => {
                console.warn(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen-mode');
                    setTimeout(() => this.resizeGame(), 100);
                });
            }
        }
    }

    goToRegister() { 
        // Reset player jika mulai baru, tapi pertahankan nama jika pernah main
        // Gunakan profil yang tersimpan jika ada
        const saved = SaveSystem.loadProfile();
        if(saved && saved.name) {
            this.player = saved;
            // FIX: Reset selection to Default (Male/1) agar sesuai dengan tampilan visual HTML
            // yang secara default memilih card pertama (Male).
            // Ini mencegah ketidaksesuaian antara visual (Male selected) dan memori (Hijab selected dari save lama).
            this.player.charId = 1; 

            // Pre-fill form
            document.getElementById('reg-name').value = saved.name || "";
            document.getElementById('reg-school').value = saved.school || "";
        } else {
            this.player = { name: "", charId: 1, score: 0, toyaPurity: 20, school: "", prov: "", city: "", district: "", chapter: 0 };
        }
        
        // Reset Visual Selection in case it was modified previously in DOM
        document.querySelectorAll('.char-card').forEach(e => e.classList.remove('selected'));
        document.getElementById('char-1').classList.add('selected');
        
        AudioMgr.playSFX('sfx-click'); 
        this.switchScreen('screen-register'); 
    }
    
    submitRegistration() { 
        AudioMgr.playSFX('sfx-click'); 
        const n = document.getElementById('reg-name').value;
        const s = document.getElementById('reg-school').value;
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city').value;
        const d = document.getElementById('reg-district').value;
        
        if(!n || !s || !p || c === '-' || d === '-') {
            showMessage("DATA TIDAK LENGKAP", "Harap isi semua data (Nama, Sekolah, Wilayah, Kecamatan) untuk melanjutkan.");
            return;
        }

        this.player.name = n; 
        this.player.school = s;
        this.player.prov = p;
        this.player.city = c;
        this.player.district = d;
        this.player.score = 0; // Reset score on new game
        this.gameStats.startTime = Date.now(); // Reset stats

        // SIMPAN PROFIL AGAR TIDAK HILANG SAAT RELOAD
        SaveSystem.saveProfile(this.player);

        this.switchScreen('screen-char');
        
        // FIX ADDED: Ensure UI matches the Data
        // Panggil selectChar dengan charId saat ini (yang sudah direset jadi 1 di goToRegister)
        // untuk memastikan border hijau (class .selected) ada di kartu yang benar.
        this.selectChar(this.player.charId);
    }
    
    selectChar(id) { 
        AudioMgr.playSFX('sfx-click'); 
        this.player.charId = id; 
        document.querySelectorAll('.char-card').forEach(e => e.classList.remove('selected')); 
        document.getElementById('char-'+id).classList.add('selected'); 
    }

    startStory() {
        AudioMgr.playSFX('sfx-click'); this.state = AppState.STORY; this.switchScreen('screen-story');
        story.start([
           { speaker: "Dewi Air", text: "Tirtatelaga, kota digital yang dilindungi oleh TOYAâ€”energi suci dari Telaga Dunia.", char: 'narrator', bg: 'bg_open1' },
            { speaker: "Dewi Air", text: "Tapi ancaman datang... Malware Genderuwo menyerang, mencoba mengkontaminasi Toya.", char: 'narrator', bg: 'bg_open2' },
            { speaker: "Dewi Air", text: "Semua senior hero sedang bertarung di garis depan. Kamu, Guardian muda, adalah harapan terakhir kami!", char: 'narrator', bg: 'bg_open3' },
            { speaker: "Dewi Air", text: "Misi mu adalah Lindungi server kota dan murnikan Toya dari kontaminasi malware!", char: 'narrator', bg: 'bg_open4' },
			 { speaker: "Dewi Air", text: "Kamu akan dipandu oleh Master Rex - Mentor kamu di SMK Nusantara Muda Tech.", char: 'narrator', bg: 'bg_open5' }
        ], () => { this.switchScreen('screen-loading'); setTimeout(() => this.startTutorial(), 2000); });
    }

    startTutorial() { this.switchScreen('dummy'); document.getElementById('hud').style.display = 'flex'; this.state = AppState.TUTORIAL; this.currentChapter = new ChapterTutorial(this); }
    finishTutorial() {
        this.switchScreen('screen-story'); this.state = AppState.STORY;
        story.start([ { speaker: "MASTER REX", text: "Kamu siap. Menuju gerbang server sekarang.", char: 'rex', bg: 'bg_siap' } ], () => { this.startChapter1(); });
    }
    
    startChapter1() { AudioMgr.playSFX('sfx-click'); this.switchScreen('screen-title-ch1'); }
    startChapter1Story() {
        AudioMgr.playSFX('sfx-click'); this.state = AppState.STORY; this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Pintu ini dikunci sistem kuantum. Pecahkan Kode Akses!", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Jawab dengan benar dan cepat untuk membuka pintu.", char: 'rex', bg: 'bg_server' }
        ], () => { 
            this.switchScreen('screen-quiz');
            document.getElementById('hud').style.display = 'flex'; 
            document.getElementById('mission-overlay').style.display = 'block';
            document.getElementById('current-mission-text').innerText = "PECAHKAN KODE AKSES";
            this.state = AppState.GAME_CH1; 
            
            this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH1, () => {
                showMessage("AKSES DITERIMA", "Pintu Terbuka.");
                setTimeout(() => this.triggerCablingNarrative(), 2000); 
            }, null);
        });
    }

    triggerCablingNarrative() {
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "System AI Gedung Server", text: "PERINGATAN! Koneksi fisik terputus.", char: 'androidtoya', bg: 'bg_masuklt1' },
            { speaker: "MASTER REX", text: "Sistem keamanan server mengalami gangguan. Kamu harus memasang perangkat dan kabel yang benar agar jaringan kembali menyala.", char: 'rex', bg: 'bg_masuklt1' }
        ], () => {
            this.startChapterCabling();
        });
    }

    startChapterCabling() { 
        this.switchScreen('dummy'); 
        document.getElementById('hud').style.display = 'flex'; 
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "HUBUNGKAN KABEL JARINGAN";
        this.state = AppState.GAME_CH1; 
        this.currentChapter = new ChapterCabling(this); 
    }

    triggerPostCablingNarrative() {
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "System AI Gedung Server", text: "Koneksi Stabil. Jaringan Kembali Online.", char: 'androidtoya', bg: 'bg_masuklt1nyala' },
            { speaker: "MASTER REX", text: "Jaringan Gedung kembali menyala! Kerja bagus. Sekarang menuju lift ke lantai berikutnya.", char: 'rex', bg: 'bg_masuklt1nyala' }
        ], () => {
            this.startChapter1Bridge();
        });
    }

    startChapter1Bridge() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "MENUJU LIFT";
        this.state = AppState.BRIDGE_CH1;
        this.currentChapter = new ChapterWalkingScene(this, () => this.triggerChapter2Narrative());
    }

    triggerChapter2Narrative() {
        AudioMgr.playSFX('sfx-click'); 
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Kerja bagus Guardian. Kamu telah berada di lantai Ruang Firewall.", char: 'rex', bg: 'bg_monitor' },
            { speaker: "System AI Gedung Server", text: "Akses Level 2: FIREWALL PERIMETER.", char: 'androidtoya', bg: 'bg_monitor' }
        ], () => { 
            this.switchScreen('screen-title-ch2');
        });
    }

    startChapter2Intro() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "System AI Gedung Server", text: "PERINGATAN! Gelombang Malware terdeteksi mencoba menembus Firewall!", char: 'androidtoya', bg: 'bg_firewall' },
            { speaker: "MASTER REX", text: "Guardian! Aktifkan mode pertahanan. Hancurkan malware itu sebelum mereka masuk ke sistem!", char: 'rex', bg: 'bg_firewall' }
        ], () => {
            this.startChapter2(); // Masuk ke Shooter terlebih dahulu
        });
    }

    startChapter2() { 
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        // KEMBALIKAN KE GAMEPLAY SHOOTER (DEFENSE)
        document.getElementById('current-mission-text').innerText = "PERTAHANAN FIREWALL";
        document.getElementById('mission-overlay').style.display = 'block';
        this.state = AppState.GAME_CH2; 
        AudioMgr.playSFX('sfx-click'); 
        this.currentChapter = new Chapter2(this); 
    }

    // Fungsi baru untuk menjembatani Shooter ke Pemilihan Paket
    triggerConfigNarrative() {
        AudioMgr.playMusic('bgm-player');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Area berhasil diamankan. Serangan fisik telah reda.", char: 'rex', bg: 'bg_firewall2' },
            { speaker: "System AI", text: "Memulai Protokol Konfigurasi Manual.", char: 'androidtoya', bg: 'bg_firewall3' }
        ], () => {
            this.startChapter2Config(); // Masuk ke Pemilihan Paket
        });
    }

    startChapter2Config() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        this.updatePurityDisplay(this.player.toyaPurity + 15); 
        document.getElementById('current-mission-text').innerText = "KONFIGURASI FIREWALL";
        document.getElementById('mission-overlay').style.display = 'block';
        this.state = AppState.GAME_CH2_CONFIG; 
        AudioMgr.playSFX('sfx-click'); 
        this.currentChapter = new ChapterFirewallConfig(this);
    }

    startChapter2Narrative() {
        // Fungsi legacy, kita arahkan ke Config Narrative jika masih ada yang memanggil
        this.triggerConfigNarrative();
    }

    startChapter2Quiz() {
        AudioMgr.playSFX('sfx-click');
        showMessage("VERIFIKASI KEAMANAN", "Firewall aktif. Jawab pertanyaan untuk memvalidasi dan mengunci sistem.");
        this.switchScreen('screen-quiz');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('hud-purity').style.width = this.player.toyaPurity + "%";
        document.getElementById('quiz-title-text').innerText = "VALIDASI FIREWALL";
        
        const display = document.getElementById('quiz-code-display');
        display.style.display = 'block'; 
        display.innerHTML = ''; 
        
        for(let i=0; i<5; i++) {
             const s = document.createElement('span');
             s.id = `lock-${i}`;
             s.innerText = 'ðŸ”“'; 
             s.style.margin = '0 10px';
             s.style.color = '#FF4444'; 
             s.style.fontSize = '2rem'; 
             display.appendChild(s);
        }

        this.state = AppState.GAME_CH2_QUIZ;
        this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH2, () => {
            showMessage("SYSTEM SECURE", "Semua Port Terkunci Aman. Firewall Valid!");
            setTimeout(() => this.startChapter2Bridge(), 2000); 
        }, [1,1,1,1,1]);
    }

    startChapter2Bridge() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "MENUJU LIFT SERVER";
        this.state = AppState.BRIDGE_CH2;
        this.currentChapter = new ChapterWalkingScene(this, () => {
            this.startChapter3IntroNarrative();
        });
    }

    startChapter3IntroNarrative() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Kita sudah di lantai teratas sekarang. Boss Monster bersembunyi di dalam.", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Kamu harus mencari 'Keylogger' yang disembunyikan virus agar bisa masuk ke ruang server utama.", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Hati-hati, labirin ini dipenuhi virus penjaga. Jangan sampai tertangkap!", char: 'rex', bg: 'bg_server' }
        ], () => {
             this.switchScreen('screen-title-ch3');
        });
    }

    startChapter3Intro() { 
        this.startChapter3Bomber();
    }

    startChapter3Bomber() {
        AudioMgr.playSFX('sfx-click');
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('current-mission-text').innerText = "TEMUKAN KEYLOGGER";
        document.getElementById('mission-overlay').style.display = 'block';
        this.state = AppState.GAME_CH3_BOMBER;
        AudioMgr.playMusic('bgm-bomber');
        this.currentChapter = new Chapter3Bomber(this);
    }

    startChapter3Quiz() {
        AudioMgr.playMusic('bgm-player');
        showMessage("INVESTIGASI LANJUTAN", "IP Penyerang Ditemukan! Analisis paket data untuk mendapatkan kode dekripsi.");
        this.switchScreen('screen-quiz');
        document.getElementById('hud').style.display = 'flex'; 
        document.getElementById('quiz-title-text').innerText = "FORENSIK DIGITAL";
        
        const display = document.getElementById('quiz-code-display');
        display.style.display = 'block'; 
        display.innerHTML = ''; 
        for(let i=0; i<5; i++) {
             const s = document.createElement('span');
             s.id = `digit-${i}`;
             s.innerText = '-';
             s.style.margin = '0 5px';
             display.appendChild(s);
        }

        const fixedCode = [1,9,0,1,9]; 
        
        this.state = AppState.GAME_CH3_QUIZ;
        this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH3, () => {
            showMessage("DATA TERDEKRIPSI", "Kode Kunci: 19019. Sistem pulih... Tapi tunggu!");
            setTimeout(() => this.triggerBossNarrative(), 2000);
        }, fixedCode);
    }

    startChapter3IR() {
        this.triggerBossNarrative();
    }
    
    triggerBossNarrative() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "System AI Gedung Server", text: "ALERT! Deteksi anomali energi masif di Core Server!", char: 'androidtoya', bg: 'bg_open4' },
            { speaker: "GENDERUWO", text: "GRRR... SIAPA YANG BERANI MENGAKTIFKAN KEMBALI FIREWALL?!", char: 'virus', bg: 'bg_open4' },
            { speaker: "MASTER REX", text: "Itu dia! Genderuwo Sang Pemimipin! Dia marah karena aksesnya kita tutup.", char: 'rex', bg: 'bg_open4' },
            { speaker: "MASTER REX", text: "Guardian! Gunakan tombol ATK dan SKILL untuk menyerang. HINDARI serangan virus dengan bergerak!", char: 'rex', bg: 'bg_open4' }
        ], () => {
            this.startBossBattle();
        });
    }

    startBossBattle() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "BOSS BATTLE: KALAHKAN GENDERUWO (REAL-TIME)";
        
        document.getElementById('rpg-controls').style.display = 'flex';
        
        this.state = AppState.BOSS_BATTLE;
        // AudioMgr.playMusic('bgm-boss'); // Called inside ChapterBossBattle now or assured here
        AudioMgr.playMusic('bgm-boss');
        this.currentChapter = new ChapterBossBattle(this);
    }

    // --- MODIFIED: New Ending Flow ---
    startEndingCinematic() {
        // FIX: Pastikan UI Screen (Title/Menu) tertutup agar Canvas terlihat
        this.switchScreen('dummy'); 

        document.getElementById('rpg-controls').style.display = 'none';
        document.getElementById('hud').style.display = 'none';
        document.getElementById('mission-overlay').style.display = 'none';
        
        this.updatePurityDisplay(100); 
        this.state = AppState.ENDING_CINEMATIC;
        
        // PENTING: Memastikan BGM Ending diputar
        AudioMgr.playMusic('bgm-ending'); 
        
        // Simpan Local + Cloud segera
        this.submitHighscore();

        this.currentChapter = new ChapterEndingCinematic(this);
    }

    showVictoryScreen() {
        this.state = AppState.VICTORY_SCORE;
        
        // CSS Styling Logic for Win
        const panel = document.getElementById('result-panel-container');
        panel.className = "result-panel result-win"; // Tambahkan class Emas/Hijau

        const title = document.getElementById('end-title');
        title.innerText = "MISSION COMPLETE";
        title.style.color = "var(--accent-gold)"; // Emas

        const rank = document.getElementById('end-rank');
        rank.innerText = "S"; // Bisa dilogika nanti berdasarkan skor
        rank.style.color = "var(--accent-gold)";

        document.getElementById('end-score').innerText = Math.floor(this.player.score); 
        
        // --- POPULATE STATISTICS ---
        document.getElementById('stat-kills').innerText = this.gameStats.totalKills;
        document.getElementById('stat-combo').innerText = this.gameStats.maxCombo + "x";
        document.getElementById('stat-dmg').innerText = Math.floor(this.gameStats.damageTaken);
        
        const playTime = Math.floor((Date.now() - this.gameStats.startTime) / 60000); // in minutes
        document.getElementById('stat-time').innerText = playTime + "m";

        // Update tombol untuk lanjut ke credits
        const btn = document.getElementById('btn-victory-action');
        btn.innerText = "LIHAT CREDIT";
        btn.onclick = () => this.startCredits();
        
        this.switchScreen('screen-ending'); 
    }

    startCredits() {
        this.switchScreen('dummy'); // Pindah ke canvas kosong
        this.state = AppState.CREDITS;
        this.currentChapter = new ChapterCredits(this);
        AudioMgr.playMusic('bgm-player'); // Mainkan lagu santai
    }
    
    // Legacy support jika masih dipanggil
    finishGame() { 
        this.startEndingCinematic();
    }

    async showLeaderboard() { 
        this.switchScreen('screen-leaderboard');
        
        const statusBadge = document.getElementById('lb-status-badge');
        const statusText = document.getElementById('lb-sync-text');
        
        // State 1: Loading
        statusBadge.className = "sync-badge status-loading";
        statusBadge.innerText = "SYNCING...";
        statusText.innerText = "Menghubungkan ke Telaga Dunia...";
        statusText.className = "sync-status";
        
        // Coba Fetch Cloud dulu
        const cloudData = await SaveSystem.fetchLeaderboard();
        
        if(cloudData && cloudData.status === 'success') {
            // State 2: Sukses Online
            localStorage.setItem('toya_lb_cache', JSON.stringify(cloudData.data));
            
            statusBadge.className = "sync-badge status-online";
            statusBadge.innerText = "ONLINE";
            statusText.innerText = "Data Nasional Terupdate dari Server.";
            statusText.className = "sync-status sync-success";
            
            this.renderLeaderboard(cloudData.data);
        } else if (cloudData && cloudData.status === 'config_error') {
            // State 3: URL Belum Diset
            statusBadge.className = "sync-badge status-offline";
            statusBadge.innerText = "NO CONFIG";
            statusText.innerText = "Server belum dikonfigurasi. Menampilkan data lokal.";
            statusText.className = "sync-status sync-error";
            
            this.fallbackToLocalLeaderboard();
        } else {
            // State 4: Error / Offline
            statusBadge.className = "sync-badge status-offline";
            statusBadge.innerText = "OFFLINE";
            statusText.innerText = "Gagal terhubung. Menampilkan data cache lokal.";
            statusText.className = "sync-status sync-error";
            
            this.fallbackToLocalLeaderboard();
        }
    }

    fallbackToLocalLeaderboard() {
        const cached = JSON.parse(localStorage.getItem('toya_lb_cache') || '[]');
        const local = JSON.parse(localStorage.getItem('toya_lb') || '[]');
        const mock = SaveSystem.getMockData(); // Ensure mock data is used in fallback
        
        const combinedMap = new Map();
        
        // Merge mock, cached, local (Local overwrites Mock if same name)
        [...mock, ...cached, ...local].forEach(item => {
            const key = item.name + '_' + item.school;
            if (combinedMap.has(key)) {
                if (item.score > combinedMap.get(key).score) {
                    combinedMap.set(key, item);
                }
            } else {
                combinedMap.set(key, item);
            }
        });

        const combinedArray = Array.from(combinedMap.values());
        this.renderLeaderboard(combinedArray);
    }
    
    // --- MISSING FUNCTION ADDED: applySubFilter ---
    applySubFilter() {
        this.renderLeaderboard();
    }

    // --- ENHANCED LEADERBOARD WITH DYNAMIC SUB-FILTERS ---
    renderLeaderboard(data = null) {
        const lbBody = document.getElementById('leaderboard-body');
        const lbScopeTitle = document.getElementById('lb-current-scope');
        const subFilter = document.getElementById('lb-sub-filter');
        lbBody.innerHTML = '';
        
        let lbData = data;
        if(!lbData) {
             // If no data passed, reconstruct from local sources
             const cached = JSON.parse(localStorage.getItem('toya_lb_cache') || '[]');
             const local = JSON.parse(localStorage.getItem('toya_lb') || '[]');
             const mock = SaveSystem.getMockData();
             const map = new Map();
             [...mock, ...cached, ...local].forEach(i => map.set(i.name+'_'+i.school, i));
             lbData = Array.from(map.values());
        }

        const filterType = document.getElementById('lb-filter').value;
        const player = this.player;

        // Reset Sub-Filter jika mengubah Kategori Utama
        if(this.lastFilterType !== filterType) {
            this.lastFilterType = filterType;
            subFilter.style.display = (filterType === 'all') ? 'none' : 'block';
            subFilter.innerHTML = '<option value="">- Pilih Detail -</option>';
            
            // Populate Sub Filter dengan data unik yang ada di leaderboard
            let uniqueValues = new Set();
            lbData.forEach(d => {
                let val = "";
                if(filterType === 'prov') val = d.prov;
                else if(filterType === 'city') val = d.city;
                else if(filterType === 'district') val = d.district;
                else if(filterType === 'school') val = d.school;
                
                if(val) uniqueValues.add(val.trim().toUpperCase());
            });

            // Tambahkan opsi ke dropdown, sorted
            Array.from(uniqueValues).sort().forEach(val => {
                let opt = document.createElement('option');
                opt.value = val;
                opt.innerText = val;
                subFilter.appendChild(opt);
            });

            // Auto-select milik player jika ada
            let myVal = "";
            if(filterType === 'prov') myVal = player.prov;
            else if(filterType === 'city') myVal = player.city;
            else if(filterType === 'district') myVal = player.district;
            else if(filterType === 'school') myVal = player.school;
            
            if(myVal && uniqueValues.has(myVal.trim().toUpperCase())) {
                subFilter.value = myVal.trim().toUpperCase();
            } else if (uniqueValues.size > 0) {
                 // Default select first item if player data not found, to show something
                 subFilter.selectedIndex = 1; 
            }
        }

        // Apply Filtering berdasarkan Sub-Filter
        let selectedSub = subFilter.value;
        let scopeName = "NASIONAL";

        if(filterType !== 'all') {
             if(selectedSub) {
                 if(filterType === 'prov') lbData = lbData.filter(d => (d.prov||"").toUpperCase() === selectedSub);
                 else if(filterType === 'city') lbData = lbData.filter(d => (d.city||"").toUpperCase() === selectedSub);
                 else if(filterType === 'district') lbData = lbData.filter(d => (d.district||"").toUpperCase() === selectedSub);
                 else if(filterType === 'school') lbData = lbData.filter(d => (d.school||"").toUpperCase() === selectedSub);
                 
                 scopeName = selectedSub;
             } else {
                 // Jika belum pilih sub, tampilkan kosong atau instruksi
                 scopeName = "Pilih Detail...";
                 lbData = []; 
             }
        }

        // Update Judul Lingkup
        lbScopeTitle.innerText = "Peringkat: " + scopeName;
        
        lbData.sort((a, b) => b.score - a.score);
        lbData = lbData.slice(0, 50);

        if(lbData.length === 0) {
            lbBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">Belum ada data untuk kategori ini.<br>Pilih filter lain atau mainkan game!</td></tr>`;
        } else {
            lbData.forEach((d, i) => {
                const tr = document.createElement('tr');
                if(d.name === player.name && (d.school||"").toUpperCase() === (player.school||"").toUpperCase()) {
                    tr.style.background = "rgba(0, 168, 255, 0.4)";
                    tr.style.border = "1px solid var(--accent-gold)";
                }
                
                const loc = (d.district && d.district !== '-') ? d.district : (d.city || d.prov);
                const school = d.school || '-';
                tr.innerHTML = `<td>${i+1}</td><td>${d.name}</td><td style="font-size:0.8rem; color:#aaa">${school}</td><td style="font-size:0.8rem; color:#aaa">${loc}</td><td style="color:var(--accent-gold); font-weight:bold;">${d.score}</td>`;
                lbBody.appendChild(tr);
            });
        }
    }

    loop(timestamp) {
        const dt = timestamp - (this.lastTime || timestamp); this.lastTime = timestamp;

        if (this.state === AppState.TITLE && Math.random() < 0.005) {
            triggerLightning();
        }

        // --- RENDER LOGIC UTAMA ---
        if (this.state >= AppState.TUTORIAL && this.state <= AppState.CREDITS) {
            ctx.clearRect(0,0, 800, 600);
            
            // --- NEW: SCREEN SHAKE LOGIC ---
            if(this.screenShake > 0) {
                const dx = (Math.random() - 0.5) * this.screenShake;
                const dy = (Math.random() - 0.5) * this.screenShake;
                ctx.translate(dx, dy);
                this.screenShake *= 0.9; // Decay shake
                if(this.screenShake < 0.5) this.screenShake = 0;
            }
            // --------------------------------

            let bgKey = 'bg_rtraining';
            
            // Set Background based on State
            if(this.state === AppState.GAME_CH1 && this.currentChapter instanceof ChapterCabling) bgKey = 'bg_kabel';
            else if(this.state === AppState.BRIDGE_CH1) bgKey = 'bg_menujulift'; 
            else if(this.state === AppState.GAME_CH1 && this.currentChapter instanceof ChapterQuiz) bgKey = 'bg_menujulift';
            else if(this.state === AppState.GAME_CH2) bgKey = 'bg_firewall1';
            else if(this.state === AppState.GAME_CH2_CONFIG) bgKey = 'bg_firewall3'; 
            else if(this.state === AppState.GAME_CH2_QUIZ) bgKey = 'bg_firewall1';
            else if(this.state === AppState.BRIDGE_CH2) bgKey = 'bg_menujulift';
            else if(this.state === AppState.GAME_CH3_BOMBER || this.state === AppState.BOSS_BATTLE) bgKey = 'bg_bomber'; 
            else if(this.state === AppState.GAME_CH3_QUIZ || this.state === AppState.GAME_CH3_IR) bgKey = 'bg_rtraining';
            else if(this.state === AppState.ENDING_CINEMATIC || this.state === AppState.CREDITS) bgKey = 'bg_title'; // BG untuk ending/credits
            
            let bg = this.imgs[bgKey];
            // Khusus Bomberman, BG digambar sendiri oleh method draw-nya (untuk lantai spesifik)
            // Tapi untuk amannya kita tidak gambar BG global di sini jika bomberman aktif
            if(this.state !== AppState.GAME_CH3_BOMBER && bg && bg.complete && bg.naturalWidth > 0 && this.state !== AppState.ENDING_CINEMATIC) {
                // Jangan gambar BG default di Cinematic karena dia gambar sendiri
                ctx.drawImage(bg, 0, 0, 800, 600); 
            } 
            else if (this.state !== AppState.ENDING_CINEMATIC && this.state !== AppState.GAME_CH3_BOMBER) { 
                ctx.fillStyle='#050A14'; ctx.fillRect(0,0,800,600); 
            }

            if(this.currentChapter) { 
                this.currentChapter.update(dt); 
                this.currentChapter.draw(ctx); 
                // Hanya update purity di gameplay
                if(this.state < AppState.ENDING_CINEMATIC) {
                     document.getElementById('hud-purity').style.width = this.player.toyaPurity + "%"; 
                }
            }
            
            // Reset Shake
            ctx.setTransform(1, 0, 0, 1, 0, 0);
        }
        requestAnimationFrame(this.loop);
    }
}

class ChapterEndingCinematic {
    constructor(game) {
        this.game = game;
        this.slideIdx = 1;
        this.totalSlides = 14; // DIPERBARUI: Menjadi 14 Slide
        this.timer = 0;
        this.slideDuration = 300; // Frames per slide (~5 detik)
        this.alpha = 0;
        this.state = 'fade-in'; // fade-in, hold, fade-out
        
        // --- VISUAL EFFECTS SYSTEM ---
        this.particles = [];
        this.flashAlpha = 0; // Untuk efek kilatan kamera
        this.animFrame = 0;  // Counter global untuk animasi
        
        // --- MATRIX RAIN SYSTEM ---
        this.matrixDrops = [];
        // Inisialisasi kolom matrix
        for(let x = 0; x < 800; x += 20) {
            this.matrixDrops.push({
                x: x,
                y: Math.random() * -600, // Mulai dari atas layar random
                speed: 2 + Math.random() * 5,
                char: String.fromCharCode(0x30A0 + Math.random() * 96), // Katakana/Simbol Matrix
                opacity: Math.random() * 0.5 + 0.1
            });
        }
        // ----------------------------------

        this.captions = [
            "", // index 0 dummy
            "Ledakan energi terakhir menandai kekalahan Genderuwo.",
            "Kabut gelap malware perlahan terangkat dari Core Server.",
            "Sistem Pertahanan Tirtatelaga mulai melakukan reboot otomatis.",
            "Protokol pemulihan menyebar ke seluruh jaringan kota.",
            "Jalur data yang merah kini berubah menjadi biru murni.",
            "Firewall kembali tegak, membentuk perisai tak terlihat.",
            "Energi Toya mengalir deras, menyembuhkan sektor yang rusak.",
            "Di seluruh kota, lampu-lampu digital kembali menyala terang.",
            "Warga Tirtatelaga bersorak, koneksi mereka telah pulih.",
            "Master Rex tersenyum, bangga pada murid barunya.",
            "Keseimbangan antara teknologi dan tradisi telah kembali.",
            "Kamu, Guardian, telah membuktikan keberanianmu.",
            "Namamu kini terukir dalam sejarah digital Tirtatelaga.",
            "TIRTATELAGA AMAN KEMBALI. MISI SELESAI."
        ];
    }

    update(dt) {
        this.animFrame++;

        // 1. UPDATE FLASH TRANSITION
        if(this.flashAlpha > 0) {
            this.flashAlpha = Math.max(0, this.flashAlpha - 0.05);
        }

        // 2. UPDATE MATRIX RAIN (Hujan Kode Digital)
        this.matrixDrops.forEach(drop => {
            drop.y += drop.speed;
            
            // Randomly change character
            if(Math.random() < 0.05) {
                drop.char = Math.random() > 0.5 ? '1' : '0'; // Binary effect
            }

            // Reset jika lewat bawah
            if(drop.y > 600) {
                drop.y = Math.random() * -100;
                drop.speed = 2 + Math.random() * 5;
            }
        });

        // 3. UPDATE PARTICLES (Toya Energy Rising)
        // Spawn particles (2 particles every 4 frames)
        if(this.animFrame % 4 === 0 && this.particles.length < 30) {
            for(let i=0; i<2; i++) {
                this.particles.push({
                    x: Math.random() * 800,
                    y: 620, // Spawn below screen
                    vx: 0, 
                    vy: -2 - Math.random(), // Move Up
                    offset: Math.random() * 100, // For wobble
                    size: 3 + Math.random() * 5,
                    color: 'white',
                    opacity: 1.0,
                    life: 1.0
                });
            }
        }

        // Move particles
        for(let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.y += p.vy;
            // Wobble effect
            p.x += Math.cos(this.animFrame * 0.05 + p.offset) * 0.5;
            
            // Fade out near top
            if(p.y < 300) {
                p.opacity -= 0.02;
            }

            // Remove dead particles
            if(p.y < -50 || p.opacity <= 0) {
                this.particles.splice(i, 1);
            }
        }

        // 4. EXISTING SLIDE LOGIC
        if(this.state === 'fade-in') {
            this.alpha += 0.02;
            if(this.alpha >= 1) { this.alpha = 1; this.state = 'hold'; }
        } else if(this.state === 'hold') {
            this.timer++;
            if(this.timer > this.slideDuration) {
                this.timer = 0;
                this.state = 'fade-out';
            }
        } else if(this.state === 'fade-out') {
            this.alpha -= 0.02;
            if(this.alpha <= 0) {
                this.alpha = 0;
                this.slideIdx++;
                
                // TRIGGER FLASH SAAT GANTI SLIDE
                this.flashAlpha = 0.6;
                
                if(this.slideIdx > this.totalSlides) {
                    this.finish();
                } else {
                    this.state = 'fade-in';
                }
            }
        }
    }

    draw(ctx) {
        // Black background base
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, 800, 600);

        // --- DRAW MATRIX RAIN (LAYER PALING BELAKANG) ---
        ctx.save();
        
        // Tentukan warna Matrix berdasarkan progress slide (Merah -> Ungu -> Emas/Cyan)
        let matrixColor = "#00FF00"; // Default
        
        if (this.slideIdx <= 3) {
            // Fase Awal: Merah (Sisa Malware)
            matrixColor = "#FF0000";
        } else if (this.slideIdx <= 6) {
            // Fase Tengah: Transisi (Ungu/Biru)
            matrixColor = "#AA00FF";
        } else {
            // Fase Akhir: Murni (Cyan/Emas)
            matrixColor = "#00D9FF";
        }

        ctx.font = "14px monospace";
        this.matrixDrops.forEach(drop => {
            // Buat efek fading di ekor drop
            ctx.globalAlpha = drop.opacity * 0.6; // Agak transparan biar tidak mengganggu gambar utama
            ctx.fillStyle = matrixColor;
            ctx.fillText(drop.char, drop.x, drop.y);
            
            // Efek 'Kepala' drop yang lebih terang
            ctx.fillStyle = "white";
            ctx.globalAlpha = drop.opacity * 0.8;
            if(Math.random() > 0.8) ctx.fillText(drop.char, drop.x, drop.y + 15);
        });
        ctx.restore();
        // ------------------------------------------------

        // 1. DRAW PARTICLES (TOYA ENERGY - LAYER TENGAH)
        ctx.save();
        this.particles.forEach(p => {
            ctx.globalAlpha = p.opacity;
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00D9FF'; // Cyan glow
            
            // Radial Gradient per particle
            let grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
            grad.addColorStop(0, "white");
            grad.addColorStop(0.4, "#00D9FF");
            grad.addColorStop(1, "rgba(0, 217, 255, 0)");
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
        });
        ctx.restore();

        // 2. DRAW MAIN IMAGE (KEN BURNS EFFECT)
        const imgKey = `ending${this.slideIdx}`;
        const img = this.game.imgs[imgKey];

        // PERBAIKAN PENTING: Tambahkan '&& img.naturalWidth > 0'
        // Ini memastikan jika gambar tidak ditemukan (broken), kode akan lari ke 'else' (menampilkan teks)
        // bukannya menggambar kotak kosong transparan.
        if(img && img.complete && img.naturalWidth > 0) {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            
            // Calculate Zoom (Scale 1.05 -> 1.0)
            let progress = this.timer / this.slideDuration;
            if(this.state === 'fade-in') progress = 0;
            if(this.state === 'fade-out') progress = 1;
            
            const scale = 1.05 - (0.05 * progress);
            
            // Center the zoomed image
            const w = 800 * scale;
            const h = 600 * scale;
            const x = (800 - w) / 2;
            const y = (600 - h) / 2;

            // Ambient Brightness Pulse (Breathing effect)
            const brightness = 1.0 + Math.sin(Date.now() / 3000) * 0.05;
            ctx.filter = `brightness(${brightness})`;

            ctx.drawImage(img, x, y, w, h);
            ctx.restore();
        } else {
            // Fallback text (Akan muncul karena gambar ending belum ada)
            ctx.fillStyle = "white";
            ctx.font = "bold 40px Orbitron";
            ctx.textAlign = "center";
            ctx.fillText(`SCENE ${this.slideIdx}`, 400, 250);
            
            // Tambahan visual untuk fallback agar tidak sepi
            ctx.font = "20px Rajdhani";
            ctx.fillStyle = "#00D9FF";
            ctx.fillText("- CINEMATIC VISUALIZATION -", 400, 290);
            ctx.textAlign = "left";
        }

        // 3. VIGNETTE EFFECT (Focus Center)
        const vig = ctx.createRadialGradient(400, 300, 100, 400, 300, 500);
        vig.addColorStop(0, "rgba(0,0,0,0)");
        vig.addColorStop(1, "rgba(0,0,0,0.6)"); // Darken edges
        ctx.fillStyle = vig;
        ctx.fillRect(0, 0, 800, 600);

        // 4. DRAW CAPTION
        if(this.captions[this.slideIdx]) {
            ctx.save();
            ctx.globalAlpha = this.alpha; 
            
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.fillRect(0, 480, 800, 120);
            
            // Main Text with Glow
            ctx.fillStyle = "#00D9FF";
            ctx.font = "24px 'Orbitron', sans-serif";
            ctx.textAlign = "center";
            ctx.shadowColor = "#00A8FF";
            ctx.shadowBlur = 10;
            ctx.fillText(this.captions[this.slideIdx], 400, 545);
            
            ctx.restore();
        }

        // 5. FLASH TRANSITION (TOP LAYER)
        if(this.flashAlpha > 0) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.flashAlpha})`;
            ctx.fillRect(0, 0, 800, 600);
        }
    }

    finish() {
        this.game.showVictoryScreen();
    }
}

class ChapterCredits {
    constructor(game) {
        this.game = game;
        this.y = 600; // Start below screen
        this.speed = 0.5;
        this.lines = [
            { t: "TOYA GUARDIANS", size: "40px", color: "#00D9FF", bold: true },
            { t: "Tirtatelaga Defense System", size: "20px", color: "#aaa" },
            { t: "", size: "20px" },
            { t: "DIKEMBANGKAN OLEH", size: "24px", color: "#FFD700" },
            { t: "TIM GELOMBANG UTARA", size: "30px", color: "white", bold: true },
            { t: "SMK Negeri 1 Brondong", size: "20px", color: "#ccc" },
            { t: "", size: "30px" },
            { t: "PROGRAMMER", size: "24px", color: "#00A8FF" },
            { t: "Lead Developer", size: "20px", color: "white" },
            { t: "AI Logic Assistant", size: "20px", color: "white" },
            { t: "", size: "30px" },
            { t: "ASSET DESIGN", size: "24px", color: "#00A8FF" },
            { t: "Character & Environment", size: "20px", color: "white" },
            { t: "Generated by Gemini AI", size: "16px", color: "#888" },
            { t: "", size: "30px" },
            { t: "AUDIO", size: "24px", color: "#00A8FF" },
            { t: "BGM & SFX Library", size: "20px", color: "white" },
            { t: "", size: "30px" },
            { t: "SPECIAL THANKS", size: "24px", color: "#FF4444" },
            { t: "Bapak/Ibu Guru Pembimbing", size: "20px", color: "white" },
            { t: "Teman-teman SMKN 1 Brondong", size: "20px", color: "white" },
            { t: "Seluruh Player Toya Guardians", size: "20px", color: "white" },
            { t: "", size: "50px" },
            { t: "TERIMA KASIH TELAH BERMAIN", size: "30px", color: "#00FF88", bold: true },
            { t: "Sampai Jumpa di Misi Selanjutnya!", size: "20px", color: "#aaa" },
            { t: "", size: "60px" },
            // --- UPDATED: BADGE DI AKHIR ---
            { t: "POWERED BY", size: "16px", color: "#888" },
            { t: "âœ¦ Made with Gemini", size: "24px", color: "#4285F4", bold: true }
        ];

        // --- FIXED: ADD CLICK LISTENER FOR SKIP BUTTON ---
        this.handler = (e) => this.handleClick(e);
        canvas.addEventListener('mousedown', this.handler);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleClick(e.touches[0]); }, {passive: false});
    }

    handleClick(e) {
        const r = canvas.getBoundingClientRect(); 
        const mx = (e.clientX - r.left) * (800/r.width); 
        const my = (e.clientY - r.top) * (600/r.height);

        // Cek area tombol SKIP (X: 700-780, Y: 550-580)
        if (mx > 700 && mx < 780 && my > 550 && my < 580) {
            AudioMgr.playSFX('sfx-click');
            location.reload(); // Kembali ke awal
        } else {
            // Jika klik di luar tombol, percepat scroll
            this.y -= 2;
        }
    }

    update(dt) {
        this.y -= this.speed;
        
        // Cek jika credit sudah habis lewat atas
        // Tinggi estimasi sekitar 1500px
        if(this.y < -1500) {
            location.reload(); // Reset game
        }
    }

    draw(ctx) {
        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fillRect(0, 0, 800, 600);

        let currentY = this.y;
        
        this.lines.forEach(line => {
            if(currentY > -50 && currentY < 650) { // Hanya gambar yang masuk layar
                ctx.fillStyle = line.color || "white";
                ctx.font = `${line.bold ? 'bold ' : ''}${line.size || '20px'} Orbitron`;
                ctx.textAlign = "center";
                ctx.fillText(line.t, 400, currentY);
            }
            // Tambah spasi berdasarkan ukuran font + padding
            const sizeInt = parseInt(line.size || "20");
            currentY += sizeInt + 15;
        });
        
        // --- PERBAIKAN VISUAL TOMBOL SKIP ---
        // Gaya visual disamakan dengan tema game (Cyberpunk Blue/Cyan)
        ctx.save();
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#00D9FF";
        
        // Background Tombol
        ctx.fillStyle = "#002244"; // Dark Blue
        ctx.fillRect(700, 550, 80, 30);
        
        // Border Tombol
        ctx.strokeStyle = "#00D9FF"; // Cyan Border
        ctx.lineWidth = 2;
        ctx.strokeRect(700, 550, 80, 30);
        
        // Teks Tombol
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "bold 12px Orbitron"; // Gunakan font game
        ctx.textAlign = "center";
        ctx.fillText("SKIP >>", 740, 570);
        
        ctx.restore();
    }

    cleanup() {
        canvas.removeEventListener('mousedown', this.handler);
        // Hapus touch juga jika perlu, meski browser modern handle otomatis saat elemen hilang
    }
}

// ... [KODE STORY, SPRITE, TUTORIAL TETAP SAMA] ...

const story = {
    data: [], idx: 0, cb: null,
    start: function(data, cb) { this.data = data; this.idx = 0; this.cb = cb; this.render(); },
    render: function() {
        if(this.idx >= this.data.length) { if(this.cb) this.cb(); return; }
        const d = this.data[this.idx];
        document.getElementById('story-speaker').innerText = d.speaker; document.getElementById('story-text').innerText = d.text;
        const bgEl = document.getElementById('story-bg');
        if(app.imgs[d.bg]) bgEl.style.backgroundImage = `url('${app.imgs[d.bg].src}')`;
        let charKey = d.char;
        if(charKey === 'hero') charKey = 'hero'+app.player.charId+'_idle';
        const img = app.imgs[charKey] || app.imgs['rex'];
        document.getElementById('story-portrait').src = img.src;
    },
    next: function() { AudioMgr.playSFX('sfx-click'); this.idx++; this.render(); }
};

class CharacterSprite {
    constructor(idleImg, frames, x, y, size = 64) { 
        this.idleImg = idleImg; this.frames = frames; this.x = x; this.y = y; this.tx = x; this.ty = y; 
        this.moving = false; this.frameIdx = 0; this.frameTimer = 0;
        this.size = size; 
        this.facingRight = true; // Default menghadap kanan
    }
    moveTo(tx, ty) { this.tx = tx; this.ty = ty; this.moving = true; }
    update(dt) {
        if(!this.moving) return;
        const dx = this.tx - this.x; const dy = this.ty - this.y; const dist = Math.sqrt(dx*dx + dy*dy);
        
        // Logika Arah Hadap (Flip Sprite)
        if (Math.abs(dx) > 1) { // Hanya ubah jika gerak horizontal signifikan
            this.facingRight = dx > 0;
        }

        if(dist > 5) {
            const s = 0.3 * dt; this.x += (dx/dist)*s; this.y += (dy/dist)*s;
            this.frameTimer += dt;
            if(this.frameTimer > 150) { this.frameIdx = (this.frameIdx + 1) % 4; this.frameTimer = 0; }
        } else { this.moving = false; this.frameIdx = 0; }
    }
    draw(ctx) {
        let img = this.idleImg;
        if(this.moving && this.frames[this.frameIdx] && this.frames[this.frameIdx].complete) img = this.frames[this.frameIdx];
        
        const halfSize = this.size / 2;
        const offset = this.size * 0.9375; 
        
        let w = this.size;
        let h = this.size;
        let yOffset = 0;

        if (!this.moving) {
            const breath = Math.sin(Date.now() / 300) * 3;
            h += breath;
            yOffset = breath; 
        }

        // Simpan state context sebelum transformasi
        ctx.save();
        
        // Pindahkan titik pusat (pivot) ke posisi karakter
        ctx.translate(this.x, this.y);
        
        // FIX: Invert Logic Scale
        // Sebelumnya !this.facingRight, sekarang diubah jadi this.facingRight
        // karena user melaporkan gerakannya terbalik (Right Input -> Left Look)
        if (this.facingRight) {
            ctx.scale(-1, 1);
        }

        if(img && img.complete && img.naturalWidth > 0) {
             // Gambar relatif terhadap titik pusat (0,0 karena sudah di-translate)
             // Posisi X digeser ke kiri setengah ukuran (-halfSize) agar gambar tetap di tengah
             ctx.drawImage(img, -halfSize, -offset - yOffset, w, h);
        }
        else { 
            // Fallback jika gambar gagal load
            ctx.fillStyle = "cyan"; ctx.beginPath(); ctx.arc(0, -halfSize, halfSize/2, 0, Math.PI*2); ctx.fill(); 
        }
        
        // Kembalikan state context untuk render berikutnya
        ctx.restore();
    }
}

class ChapterTutorial {
    constructor(game) {
        this.game = game; this.step = 0; 
        const frames = game.getHeroFrames(game.player.charId); const idle = game.getHeroIdle(game.player.charId);
        this.hero = new CharacterSprite(idle, frames, 400, 300, 96); 
        this.handler = (e) => this.click(e); canvas.addEventListener('mousedown', this.handler);
        this.finished = false;
    }
    click(e) {
        const r = canvas.getBoundingClientRect(); const mx = (e.clientX - r.left) * (800/r.width); const my = (e.clientY - r.top) * (600/r.height);
        if(this.step === 1) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); setTimeout(() => this.step=2, 1500); }
        else if(this.step === 3) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); } 
        else { this.step++; AudioMgr.playSFX('sfx-click'); }
    }
    update(dt) {
        this.hero.update(dt);
        if(this.step === 3 && this.hero.x > 700 && !this.finished) { this.finished = true; this.cleanup(); this.game.finishTutorial(); }
    }
    draw(ctx) {
        this.hero.draw(ctx);
        const box = (txt, next) => {
            const bx=50, by=420;
            ctx.fillStyle = "rgba(5, 20, 40, 0.95)"; ctx.strokeStyle = "#00D9FF"; ctx.lineWidth = 2;
            ctx.fillRect(bx, by, 700, 150); ctx.strokeRect(bx, by, 700, 150);
            if(this.game.imgs.rex && this.game.imgs.rex.complete && this.game.imgs.rex.naturalWidth > 0) ctx.drawImage(this.game.imgs.rex, bx+20, by-40, 100, 100);
            ctx.fillStyle = "#FFD700"; ctx.font = "24px Orbitron"; ctx.textAlign="left"; ctx.fillText("MASTER REX", bx+140, by+40);
            ctx.fillStyle = "white"; ctx.font = "20px Rajdhani"; ctx.fillText(txt, bx+140, by+80);
            if(next) { ctx.fillStyle = "#00D9FF"; ctx.font="16px sans-serif"; ctx.fillText("â–¼ Klik untuk lanjut", 650, by+130); }
        };
        if(this.step === 0) box("Selamat datang! Mari tes sistem gerakmu.", true);
        else if(this.step === 1) box("[KLIK] di lantai untuk berjalan ke sana.", false);
        else if(this.step === 2) {
            box("Bagus! Cek inventori: Tablet & Laptop.", true);
            // ANIMATION 1: Floating Items in Tutorial
            const drawItem = (img, x, y) => { 
                const floatY = Math.sin(Date.now() / 300) * 5; // Floating Effect
                if(img && img.complete) ctx.drawImage(img, x, y + floatY, 64, 64); 
            }
            drawItem(this.game.imgs.item_tablet, 350, 200);
            drawItem(this.game.imgs.item_laptop, 450, 200);
        } else if(this.step === 3) {
            box("Peralatan siap. Jalan ke pintu keluar (EXIT) untuk mulai misi!", false);
            ctx.fillStyle = "rgba(0, 255, 136, 0.3)"; ctx.fillRect(700, 200, 100, 400); 
            ctx.fillStyle = "white"; ctx.font="20px Orbitron"; ctx.fillText("EXIT >>", 720, 300);
        }
    }
    cleanup() { canvas.removeEventListener('mousedown', this.handler); }
}

class ChapterWalkingScene {
    constructor(game, onFinish) {
        this.game = game; this.onFinish = onFinish; 
        const frames = game.getHeroFrames(game.player.charId); 
        const idle = game.getHeroIdle(game.player.charId);
        this.hero = new CharacterSprite(idle, frames, 50, 450, 96); 
        this.handler = (e) => this.click(e); 
        canvas.addEventListener('mousedown', this.handler);
        this.finished = false;
        showMessage("AREA LORONG SERVER", "Klik lantai untuk berjalan menuju LIFT di ujung kanan.");
    }
    click(e) {
        const r = canvas.getBoundingClientRect(); const mx = (e.clientX - r.left) * (800/r.width); const my = (e.clientY - r.top) * (600/r.height);
        if(my > 350 && my < 600) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); }
    }
    update(dt) {
        this.hero.update(dt);
        if(this.hero.x > 700 && !this.finished) { this.finished = true; this.cleanup(); if(this.onFinish) this.onFinish(); }
    }
    draw(ctx) {
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, 0, 800, 600);
        ctx.fillStyle = "#222"; ctx.fillRect(700, 200, 100, 400); ctx.strokeStyle = "#00D9FF"; ctx.lineWidth = 3; ctx.strokeRect(700, 200, 100, 400);
        ctx.fillStyle = "#333"; ctx.fillRect(710, 210, 80, 380); ctx.fillStyle = "#00FF88"; ctx.font="20px Orbitron"; ctx.fillText("LIFT", 725, 300);
        if(!this.finished) { ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; ctx.font = "30px sans-serif"; ctx.fillText(">>>", 400 + (Math.sin(Date.now()/200)*20), 500); }
        this.hero.draw(ctx);
    }
    cleanup() { canvas.removeEventListener('mousedown', this.handler); }
}

class ChapterQuiz {
    constructor(game, questionBank, onComplete, fixedCode = null) {
        this.game = game; this.onComplete = onComplete; this.currentPhase = 0; 
        this.activeQuestions = shuffleArray([...questionBank]).slice(0, 5);
        this.generatedCode = fixedCode || Array(5).fill(0).map(() => Math.floor(Math.random() * 10)); 
        this.userCode = ['-', '-', '-', '-', '-'];
        this.hasUsedHint = false; 
        this.isQuizActive = false; // Start paused, waiting for tutorial
        this.timeLeft = 120; 
        this.attemptsOnCurrent = 0;

        document.getElementById('hud-timer').innerText = this.timeLeft;

        // TUTORIAL OVERLAY QUIZ (NEW) - ADDED TIMEOUT
        setTimeout(() => {
            showMessage(
                "TUTORIAL: KODE AKSES",
                `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
                <strong>ðŸŽ® CARA BERMAIN:</strong><br>
                âœ… KLIK JAWABAN PALING BENAR.<br>
                ðŸ¦– JIKA KESULITAN, BISA MENGGUNAKAN <strong>BANTUAN MASTER REX</strong>.<br>
                âš ï¸ BANTUAN HANYA BISA DIGUNAKAN <strong>SEKALI SAJA</strong>!
                </div>`,
                () => {
                    this.isQuizActive = true;
                    this.timerInterval = setInterval(() => this.tick(), 1000);
                    this.loadPhase(); 
                    this.updateCodeDisplay();
                }
            );
        }, 500);
    }
    tick() {
        if (!this.isQuizActive) return;
        this.timeLeft--; document.getElementById('hud-timer').innerText = this.timeLeft;
        if (this.timeLeft <= 0) {
            this.timeLeft = 0; clearInterval(this.timerInterval); this.isQuizActive = false;
            this.game.triggerGameOver();
        }
    }
    loadPhase() {
        if (this.currentPhase >= this.activeQuestions.length) { this.finishQuiz(); return; }
        this.attemptsOnCurrent = 0; 
        document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = false);
        const data = this.activeQuestions[this.currentPhase];
        document.getElementById('quiz-phase-num').innerText = this.currentPhase + 1;
        document.getElementById('quiz-question-text').innerText = data.q;
        document.getElementById('quiz-feedback').innerText = '';
        const btnHint = document.getElementById('btn-hint');
        if(this.hasUsedHint) { btnHint.disabled = true; btnHint.innerText = "DIGUNAKAN"; btnHint.style.filter = "grayscale(100%)"; } 
        else { btnHint.disabled = false; btnHint.innerText = "BANTUAN (REX)"; btnHint.style.filter = "none"; }
        const optionsContainer = document.getElementById('quiz-options-container'); optionsContainer.innerHTML = '';
        shuffleArray([...data.options]).forEach((opt, index) => {
            const btn = document.createElement('button'); btn.className = 'btn-ml quiz-option-btn'; btn.style.marginTop = '10px'; btn.style.background = '#002244'; btn.style.borderColor = '#004488';
            btn.innerText = `${String.fromCharCode(65 + index)}. ${opt.text}`;
            btn.onclick = () => this.checkAnswer(opt, btn);
            optionsContainer.appendChild(btn);
        });
    }
    checkAnswer(option, button) {
        if (!this.isQuizActive) return;
        const feedbackEl = document.getElementById('quiz-feedback');
        if (option.correct) {
            document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = true);
            AudioMgr.playSFX('sfx-correct'); button.style.background = 'var(--success-green)'; feedbackEl.style.color = 'var(--success-green)';
            
            let scoreGain = 0;
            if(this.attemptsOnCurrent === 0) scoreGain = 40;
            else if(this.attemptsOnCurrent === 1) scoreGain = 30;
            else if(this.attemptsOnCurrent === 2) scoreGain = 20;
            else scoreGain = 10;

            this.game.addScore(scoreGain); feedbackEl.innerText = `[BENAR] (+${scoreGain} Poin)`;
            this.userCode[this.currentPhase] = this.generatedCode[this.currentPhase]; this.updateCodeDisplay();
            setTimeout(() => { this.currentPhase++; this.loadPhase(); }, 1500);
        } else {
            this.attemptsOnCurrent++; AudioMgr.playSFX('sfx-wrong'); button.style.background = 'var(--danger-red)'; button.disabled = true; feedbackEl.style.color = 'var(--danger-red)'; feedbackEl.innerText = `[SALAH] - Maaf, jawaban itu kurang tepat.`;
        }
    }
    getHint() {
        if (this.hasUsedHint) return; this.hasUsedHint = true; const btnHint = document.getElementById('btn-hint'); btnHint.disabled = true; btnHint.innerText = "DIGUNAKAN"; btnHint.style.filter = "grayscale(100%)"; 
        showRexMessage("PETUNJUK MASTER REX", this.activeQuestions[this.currentPhase].hint); this.game.addScore(-5);
    }
    updateCodeDisplay() { 
        this.userCode.forEach((digit, index) => { 
            const elDigit = document.getElementById(`digit-${index}`); 
            if(elDigit) elDigit.innerText = digit; 
            
            const elLock = document.getElementById(`lock-${index}`);
            if(elLock) {
                if(digit !== '-' && digit !== undefined) {
                    elLock.innerText = 'ðŸ”’'; 
                    elLock.style.color = '#00FF88';
                } else {
                    elLock.innerText = 'ðŸ”“'; 
                    elLock.style.color = '#FF4444'; 
                }
            }
        }); 
    }
    finishQuiz() { this.isQuizActive = false; clearInterval(this.timerInterval); this.game.addScore(this.timeLeft); spawnFloatingScore(`TIME BONUS +${this.timeLeft}`); if(this.onComplete) this.onComplete(); }
    cleanup() { clearInterval(this.timerInterval); }
    update() { } draw(ctx) { }
}

class ChapterCabling {
    constructor(game) {
        this.game = game; this.timeLeft = 60; 
        this.active = false; // Start paused
        
        const selectedTasks = shuffleArray([...BANK_SOAL_KABEL]).slice(0, 3);
        // ... existing task setup ...
        const positions = [
            { sX: 100, sY: 150, tX: 600, tY: 150 }, 
            { sX: 100, sY: 300, tX: 500, tY: 300 }, 
            { sX: 100, sY: 450, tX: 600, tY: 450 } 
        ];

        this.tasks = selectedTasks.map((task, index) => {
            return {
                q: task.q,
                sX: positions[index].sX,
                sY: positions[index].sY,
                tX: positions[index].tX,
                tY: positions[index].tY,
                srcType: task.srcType,
                targetType: task.targetType,
                cableType: task.cableType,
                completed: false,
                connected: false
            };
        });
        
        this.dragged = null; this.mx = 0; this.my = 0;
        this.evDown = (e) => this.input(e, 'down'); this.evMove = (e) => this.input(e, 'move'); this.evUp = (e) => this.input(e, 'up');
        canvas.addEventListener('mousedown', this.evDown); canvas.addEventListener('mousemove', this.evMove); canvas.addEventListener('mouseup', this.evUp);
        
        document.getElementById('hud-timer').innerText = this.timeLeft;

        // TUTORIAL OVERLAY CABLING (UPDATED TEXT) - ADDED TIMEOUT
        setTimeout(() => {
            showMessage(
                "TUTORIAL: PENGKABELAN",
                `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
                <strong>ðŸŽ® CARA BERMAIN:</strong><br>
                Hubungkan port perangkat kiri ke kanan dengan kabel yang sesuai.<br>
                ðŸ–±ï¸ <strong>KLIK & TAHAN</strong> pada Port Awal (Kiri).<br>
                ðŸ‘‰ <strong>GESER</strong> kabel ke Port Tujuan (Kanan).<br>
                âœ… Lepas mouse untuk menghubungkan.
                </div>`,
                () => {
                    this.active = true;
                    this.timerInterval = setInterval(() => {
                        if(!this.active) return;
                        this.timeLeft--; document.getElementById('hud-timer').innerText = this.timeLeft;
                        if(this.timeLeft <= 0) { 
                            this.cleanup(); 
                            this.game.triggerGameOver();
                        }
                    }, 1000);
                }
            );
        }, 500);
    }
    cleanup() { clearInterval(this.timerInterval); canvas.removeEventListener('mousedown', this.evDown); canvas.removeEventListener('mousemove', this.evMove); canvas.removeEventListener('mouseup', this.evUp); }
    getCanvasCoords(e) { const r = canvas.getBoundingClientRect(); return { mx: (e.clientX - r.left) * (800/r.width), my: (e.clientY - r.top) * (600/r.height) }; }
    input(e, type) {
        if(!this.active) return; // Prevent input if paused
        const {mx, my} = this.getCanvasCoords(e); this.mx = mx; this.my = my;
        if (type === 'down') { for (let i = 0; i < this.tasks.length; i++) { if (!this.tasks[i].completed && Math.hypot(mx - (this.tasks[i].sX + 40), my - (this.tasks[i].sY + 40)) < 40) { this.dragged = i; AudioMgr.playSFX('sfx-click'); return; } } }
        else if (type === 'up' && this.dragged !== null) {
            const t = this.tasks[this.dragged];
            if(Math.hypot(mx - (t.tX + 40), my - (t.tY + 40)) < 60) {
                t.completed = true; t.connected = true; this.game.addScore(100); AudioMgr.playSFX('sfx-correct'); 
                if(this.tasks.every(task => task.completed)) { this.cleanup(); showMessage("JARINGAN AKTIF", `Koneksi Stabil! Bonus Waktu: ${this.timeLeft * 2}`); setTimeout(() => this.game.triggerPostCablingNarrative(), 3000); }
            } else { AudioMgr.playSFX('sfx-wrong'); }
            this.dragged = null;
        }
    }
    update(dt) { }
    draw(ctx) {
        // ... existing drawing code ...
        const pulse = 1 + Math.sin(Date.now() / 200) * 0.05;

        this.tasks.forEach(t => {
            const imgS = this.game.imgs[t.srcType]; const imgT = this.game.imgs[t.targetType];
            const safeDraw = (img, x, y, label) => {
                let size = 80;
                let offset = 0;
                if(!t.completed) { size = 80 * pulse; offset = (80 - size)/2; }
                
                if(img && img.complete) ctx.drawImage(img, x + offset, y + offset, size, size);
                else { ctx.fillStyle = "#334"; ctx.fillRect(x, y, 80, 80); ctx.strokeRect(x, y, 80, 80); }
                ctx.fillStyle = "white"; ctx.font = "12px sans-serif"; ctx.textAlign = "center";
                const text = label.replace('item_', '').toUpperCase(); ctx.fillText(text, x + 40, y + 95); ctx.textAlign = "left"; 
            };
            safeDraw(imgS, t.sX, t.sY, t.srcType);
            if(t.srcType !== t.targetType || !t.completed) safeDraw(imgT, t.tX, t.tY, t.targetType);
            if(t.connected) { ctx.beginPath(); ctx.moveTo(t.sX + 40, t.sY + 40); ctx.lineTo(t.tX + 40, t.tY + 40); ctx.strokeStyle = t.cableType === 'straight' ? "#00A8FF" : "#FFD700"; ctx.lineWidth = 4; ctx.stroke(); }
        });
        if(this.dragged !== null) { const t = this.tasks[this.dragged]; ctx.beginPath(); ctx.moveTo(t.sX + 40, t.sY + 40); ctx.lineTo(this.mx, this.my); ctx.strokeStyle = t.cableType === 'straight' ? "#00D9FF" : "#FFD700"; ctx.lineWidth = 5; ctx.stroke(); }
        
        const currentTask = this.tasks.find(t => !t.completed);
        if (currentTask) { 
            // FIX (Poin 5): Background Gelap agar tulisan terbaca jelas
            ctx.fillStyle = "rgba(0, 0, 0, 0.85)";
            ctx.fillRect(100, 520, 600, 50);
            ctx.strokeStyle = "#00D9FF";
            ctx.lineWidth = 2;
            ctx.strokeRect(100, 520, 600, 50);

            // Ganti warna teks jadi Gold/Kuning agar kontras dengan biru/hijau elemen lain
            ctx.fillStyle = "#FFD700"; 
            ctx.font = "bold 24px Orbitron"; 
            ctx.textAlign = "center"; 
            ctx.fillText("MISI: " + currentTask.q, 400, 553); 
            ctx.textAlign = "left"; 
        }
    }
}

class Chapter2 { 
    constructor(game) {
        this.game = game; this.pX = 400; this.pY = 500; this.bullets = []; this.enemies = []; this.particles = [];
        this.isShooting = false; this.spawnTimer = 0; this.shootTimer = 0; this.waveCount = 0;
        this.kills = 0; 
        this.targetKills = 25; 
        this.hp = 100; this.maxHp = 100; 
        this.active = false; // Start paused for tutorial
        this.missedCount = 0; 
        this.missedLimit = 5; 
        this.won = false;

        // --- NEW: COMBO SYSTEM ---
        this.combo = 0;
        
        this.timeLeft = 60; 
        document.getElementById('hud-timer').innerText = this.timeLeft;
        
        this.handleMove = (e) => { if(!this.active) return; const r = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; this.pX = (clientX - r.left) * (800/r.width); if(this.pX < 30) this.pX = 30; if(this.pX > 770) this.pX = 770; };
        this.handleStart = (e) => { if(!this.active) return; this.isShooting = true; this.handleMove(e); }; this.handleEnd = (e) => { this.isShooting = false; };
        canvas.addEventListener('mousemove', this.handleMove); canvas.addEventListener('mousedown', this.handleStart); canvas.addEventListener('mouseup', this.handleEnd);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.handleMove(e); }, {passive: false});
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleStart(e); }, {passive: false});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); this.handleEnd(e); }, {passive: false});

        // TUTORIAL OVERLAY SHOOTER
        showMessage(
            "MISI: FIREWALL DEFENSE", 
            `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
            <strong>ðŸŽ® KONTROL:</strong><br>
            ðŸ–±ï¸ GESER MOUSE = Gerakkan Hero<br>
            ðŸ–±ï¸ TAHAN KLIK = Auto Shoot<br><br>
            <strong>ðŸŽ¯ MISI:</strong><br>
            Target: Hancurkan ${this.targetKills} Malware!<br>
            âš ï¸ Jangan biarkan 5+ lolos!
            </div>`,
            () => {
                this.active = true;
                this.timerInterval = setInterval(() => {
                    if(!this.active) return;
                    this.timeLeft--;
                    document.getElementById('hud-timer').innerText = this.timeLeft;
                    if(this.timeLeft <= 0) {
                         this.gameOver();
                    }
                }, 1000);
            }
        );
    }
    // ... rest of Chapter2 unchanged ...
    cleanup() { 
        clearInterval(this.timerInterval);
        canvas.removeEventListener('mousemove', this.handleMove); canvas.removeEventListener('mousedown', this.handleStart); canvas.removeEventListener('mouseup', this.handleEnd); 
    }
    
    spawnEnemy() { 
        let speed = 0.8 + (this.waveCount * 0.03); 
        
        let x1 = Math.random() * 700 + 50;
        this.enemies.push({ x: x1, y: -50, spd: speed, hp: 3, maxHp: 3 }); 

        let offset = (Math.random() > 0.5 ? 1 : -1) * (40 + Math.random() * 40);
        let x2 = x1 + offset;
        if(x2 < 50) x2 = 50 + Math.abs(offset);
        if(x2 > 750) x2 = 750 - Math.abs(offset);

        this.enemies.push({ x: x2, y: -50 - (Math.random()*30), spd: speed, hp: 3, maxHp: 3 });
    }

    spawnExplosion(x, y, color) { for(let i=0; i<8; i++) this.particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1.0, color: color }); }
    update(dt) {
        if(!this.active) return;
        if(this.isShooting) { this.shootTimer += dt; if(this.shootTimer > 150) { this.bullets.push({ x: this.pX, y: this.pY - 40 }); this.shootTimer = 0; } }
        
        this.spawnTimer += dt; 
        if(this.spawnTimer > 2000) { 
            this.spawnEnemy(); 
            this.spawnTimer = 0; 
            this.waveCount++; 
        }
        
        for(let i = this.bullets.length - 1; i >= 0; i--) { let b = this.bullets[i]; b.y -= 10; if(b.y < -10) this.bullets.splice(i, 1); }
        for(let i = this.enemies.length - 1; i >= 0; i--) {
            let e = this.enemies[i]; e.y += e.spd;
            if(Math.hypot(e.x - this.pX, e.y - this.pY) < 50) { 
                this.hp -= 20; 
                this.spawnExplosion(e.x, e.y, 'red'); 
                AudioMgr.playSFX('sfx-wrong'); 
                this.enemies.splice(i, 1); 
                
                // COMBO BREAK
                this.combo = 0;
                this.game.gameStats.damageTaken += 20;
                this.game.screenShake = 15; // Trigger Shake

                if(this.hp <= 0) this.gameOver(); 
                continue; 
            }
            if(e.y > 600) { 
                this.missedCount++; 
                this.enemies.splice(i, 1); 
                AudioMgr.playSFX('sfx-wrong'); 
                this.combo = 0; // Miss = Combo Reset
                if(this.missedCount >= this.missedLimit) this.gameOver(); 
                continue; 
            }
            for(let j = this.bullets.length - 1; j >= 0; j--) {
                let b = this.bullets[j];
                if(Math.hypot(e.x - b.x, e.y - b.y) < 40) { 
                    e.hp--; 
                    this.bullets.splice(j, 1); 
                    this.spawnExplosion(b.x, b.y, 'cyan'); 
                    if(e.hp <= 0) { 
                        this.enemies.splice(i, 1); 
                        this.kills++; 
                        
                        // COMBO INCREMENT
                        this.combo++;
                        if(this.combo > this.game.gameStats.maxCombo) this.game.gameStats.maxCombo = this.combo;
                        this.game.gameStats.totalKills++;

                        // Bonus Score for Combo
                        let comboBonus = Math.floor(this.combo / 5) * 10;
                        this.game.addScore(50 + comboBonus); 
                        
                        AudioMgr.playSFX('sfx-correct'); 
                        this.checkWin(); 
                    } 
                    break; 
                }
            }
        }
        for(let i = this.particles.length - 1; i >= 0; i--) { let p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05; if(p.life <= 0) this.particles.splice(i, 1); }
    }
    checkWin() { if(this.kills >= this.targetKills && !this.won) { this.won = true; this.active = false; showMessage("MISI SELESAI", "Area diamankan! Melanjutkan ke konfigurasi firewall..."); setTimeout(() => { this.cleanup(); this.game.triggerConfigNarrative(); }, 3000); } }
    
    gameOver() { this.active = false; this.game.triggerGameOver(); }
    
    draw(ctx) {
        const heartsLeft = this.missedLimit - this.missedCount;
        for(let h=0; h<this.missedLimit; h++) { ctx.fillStyle = h < heartsLeft ? "#FF4444" : "#555"; ctx.beginPath(); ctx.arc(780 - (h*25), 570, 10, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="white"; ctx.stroke(); }
        ctx.fillStyle = "#550000"; ctx.fillRect(580, 585, 200, 10); ctx.fillStyle = this.hp > 30 ? "#00FF88" : "#FF4444"; ctx.fillRect(580, 585, 200 * (this.hp / this.maxHp), 10);
        ctx.textAlign="left"; ctx.fillStyle = "#00D9FF"; ctx.font = "16px Orbitron"; ctx.fillText(`MALWARE ELIMINATED: ${this.kills}/${this.targetKills}`, 20, 570);

        // --- DRAW COMBO ---
        if(this.combo > 1) {
            ctx.fillStyle = "#FFD700";
            ctx.font = "bold 30px Orbitron";
            ctx.textAlign = "center";
            ctx.shadowColor = "orange";
            ctx.shadowBlur = 15;
            const scale = 1 + Math.sin(Date.now()/100) * 0.1;
            ctx.save();
            ctx.translate(400, 100);
            ctx.scale(scale, scale);
            ctx.fillText(this.combo + "x COMBO!", 0, 0);
            ctx.restore();
            ctx.shadowBlur = 0;
            ctx.textAlign = "left";
        }

        const charId = this.game.player.charId;
        let charImg = this.game.imgs['hero' + charId + '_tembak'];
        if (!charImg || !charImg.complete || charImg.naturalWidth === 0) {
             charImg = this.game.getHeroIdle(charId); 
        }

        // ANIMATION 5: Hero Sprite Animation in Firewall Defense
        const breath = Math.sin(Date.now() / 200) * 2; // Rapid breathing/bobbing
        if(charImg && charImg.complete) { ctx.drawImage(charImg, this.pX - 32, this.pY - 40 + breath, 64, 64); } else { ctx.fillStyle = "blue"; ctx.beginPath(); ctx.arc(this.pX, this.pY, 20, 0, Math.PI*2); ctx.fill(); }
        
        const virusImg = this.game.imgs.virus;
        
        const wobble = Math.sin(Date.now() / 200) * 0.1; 
        const pulse = 1 + Math.sin(Date.now() / 150) * 0.1; 

        this.enemies.forEach(e => { 
            if(virusImg && virusImg.complete) {
                ctx.save();
                ctx.translate(e.x, e.y);
                ctx.rotate(wobble);
                ctx.scale(pulse, pulse);
                ctx.drawImage(virusImg, -30, -30, 60, 60);
                ctx.restore();
            } else { 
                ctx.fillStyle = "red"; ctx.fillRect(e.x-20, e.y-20, 40, 40); 
            } 
            ctx.fillStyle = "green"; ctx.fillRect(e.x - 20, e.y - 40, 40 * (e.hp / e.maxHp), 5); 
        });

        ctx.fillStyle = "#FFFF00"; this.bullets.forEach(b => { ctx.fillRect(b.x - 3, b.y - 10, 6, 20); });
        this.particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0; });
    }
}

// ... [KODE CHAPTER FIREWALL CONFIG & BOMBER TETAP SAMA] ...
class ChapterFirewallConfig {
    constructor(game) {
        this.game = game;
        this.packets = [];
        this.spawnTimer = 0;
        this.score = 0;
        this.targetScore = 10;
        this.active = false; // Start paused
        this.draggedPacket = null;

        // Zones
        this.zoneAllow = { x: 50, y: 150, w: 200, h: 300, color: 'rgba(0, 255, 0, 0.2)', label: "ALLOW (Aman)" };
        this.zoneBlock = { x: 550, y: 150, w: 200, h: 300, color: 'rgba(255, 0, 0, 0.2)', label: "BLOCK (Virus)" };

        // Helper untuk normalisasi input (Mouse & Touch)
        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - r.left) * (800/r.width),
                y: (e.clientY - r.top) * (600/r.height)
            };
        };

        this.evDown = (e) => {
            if(!this.active) return;
            const pos = getPos(e);
            
            // Loop reverse agar yang paling atas (terakhir digambar) yang terpilih
            for(let i=this.packets.length-1; i>=0; i--) {
                const p = this.packets[i];
                if(Math.hypot(pos.x - p.x, pos.y - p.y) < 40) { // Radius hit diperbesar sedikit
                    this.draggedPacket = p;
                    AudioMgr.playSFX('sfx-click');
                    return;
                }
            }
        };
        
        this.evMove = (e) => {
            if(this.draggedPacket) {
                const pos = getPos(e);
                this.draggedPacket.x = pos.x;
                this.draggedPacket.y = pos.y;
            }
        };
        
        this.evUp = (e) => {
            if(this.draggedPacket) {
                // Check Drop Zones
                const p = this.draggedPacket;
                let processed = false;
                
                // Check Allow Zone
                if(p.x > this.zoneAllow.x && p.x < this.zoneAllow.x + this.zoneAllow.w &&
                   p.y > this.zoneAllow.y && p.y < this.zoneAllow.y + this.zoneAllow.h) {
                    if(p.type === 'good') {
                        this.score++; this.game.addScore(50); AudioMgr.playSFX('sfx-correct'); spawnFloatingScore("ALLOWED!");
                    } else {
                        this.game.addScore(-20); AudioMgr.playSFX('sfx-wrong'); spawnFloatingScore("SECURITY BREACH!");
                    }
                    processed = true;
                }
                // Check Block Zone
                else if(p.x > this.zoneBlock.x && p.x < this.zoneBlock.x + this.zoneBlock.w &&
                        p.y > this.zoneBlock.y && p.y < this.zoneBlock.y + this.zoneBlock.h) {
                    if(p.type === 'bad') {
                        this.score++; this.game.addScore(50); AudioMgr.playSFX('sfx-correct'); spawnFloatingScore("BLOCKED!");
                    } else {
                        this.game.addScore(-20); AudioMgr.playSFX('sfx-wrong'); spawnFloatingScore("PACKET LOST!");
                    }
                    processed = true;
                }

                if(processed) {
                    this.packets = this.packets.filter(pkt => pkt !== p);
                    if(this.score >= this.targetScore) {
                        this.active = false; // Stop immediately
                        this.cleanup();
                        showMessage("FIREWALL TERKONFIGURASI", "Aturan filtering berhasil diterapkan. Sistem aman.");
                        setTimeout(() => this.game.startChapter2Quiz(), 2000);
                    }
                }
                this.draggedPacket = null;
            }
        };

        // Bind Mouse Events
        canvas.addEventListener('mousedown', this.evDown);
        canvas.addEventListener('mousemove', this.evMove);
        canvas.addEventListener('mouseup', this.evUp);
        // Bind ke window juga agar drag tidak nyangkut jika lepas di luar canvas
        window.addEventListener('mouseup', this.evUp);

        // Bind Touch Events (FIX for Mobile Drag & Drop)
        this.evTouchStart = (e) => { e.preventDefault(); this.evDown(e.touches[0]); };
        this.evTouchMove = (e) => { e.preventDefault(); this.evMove(e.touches[0]); };
        this.evTouchEnd = (e) => { e.preventDefault(); this.evUp(e.changedTouches[0]); }; 

        canvas.addEventListener('touchstart', this.evTouchStart, {passive: false});
        canvas.addEventListener('touchmove', this.evTouchMove, {passive: false});
        canvas.addEventListener('touchend', this.evTouchEnd, {passive: false});

        // SPAWN 1 PACKET IMMEDIATELY (Agar tidak terlihat kosong)
        this.spawnPacket();

        // TUTORIAL OVERLAY FIREWALL
        setTimeout(() => {
            showMessage(
                "TUTORIAL: FIREWALL", 
                `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
                <strong>ðŸŽ® KONTROL:</strong><br>
                ðŸ–±ï¸ KLIK & TAHAN Paket Data<br>
                ðŸ“¥ GESER ke zona ALLOW (Hijau) jika Aman<br>
                ðŸš« GESER ke zona BLOCK (Merah) jika Virus<br><br>
                <strong>ðŸŽ¯ MISI:</strong><br>
                Sortir 10 paket data dengan benar!
                </div>`,
                () => { this.active = true; }
            );
        }, 500);
    }

    spawnPacket() {
        const isGood = Math.random() > 0.4;
        
        // --- PERBAIKAN: MEMILIH ICON SESUAI TIPE ---
        const goodIcons = ['icon_http', 'icon_ssh', 'icon_email'];
        const badIcons = ['icon_sql', 'icon_telnet', 'icon_exe', 'icon_ping'];
        
        const iconKey = isGood 
            ? goodIcons[Math.floor(Math.random() * goodIcons.length)] 
            : badIcons[Math.floor(Math.random() * badIcons.length)];

        this.packets.push({
            x: 400,
            y: -50,
            type: isGood ? 'good' : 'bad',
            imgKey: iconKey, // Simpan key gambar untuk dirender nanti
            vy: 2
        });
    }

    update(dt) {
        if(!this.active) return;
        this.spawnTimer += dt;
        // Percepat spawn agar user tidak bosan
        if(this.spawnTimer > 1200 && this.packets.length < 5) {
            this.spawnTimer = 0;
            this.spawnPacket();
        }
        
        this.packets.forEach(p => {
            if(p !== this.draggedPacket) {
                p.y += p.vy;
                // Reset if falls off screen
                if(p.y > 650) {
                    p.y = -50; p.x = 400;
                }
            }
        });
    }

    draw(ctx) {
        // --- PERBAIKAN: LOGIKA RENDER GAMBAR ---
        const imgAllow = this.game.imgs.zone_allow;
        const imgBlock = this.game.imgs.zone_block;

        // Draw Allow Zone
        if(imgAllow && imgAllow.complete) {
             ctx.drawImage(imgAllow, this.zoneAllow.x, this.zoneAllow.y, this.zoneAllow.w, this.zoneAllow.h);
        } else {
             // Fallback jika gambar gagal load
             const pulse = 0.2 + (Math.sin(Date.now() / 500) * 0.05);
             ctx.fillStyle = `rgba(0, 255, 0, ${pulse})`;
             ctx.fillRect(this.zoneAllow.x, this.zoneAllow.y, this.zoneAllow.w, this.zoneAllow.h);
             ctx.strokeStyle = "#0F0"; ctx.lineWidth = 2; ctx.strokeRect(this.zoneAllow.x, this.zoneAllow.y, this.zoneAllow.w, this.zoneAllow.h);
        }
        // Label selalu di atas gambar
        ctx.fillStyle = "#0F0"; ctx.font = "bold 20px Orbitron"; 
        ctx.fillText(this.zoneAllow.label, this.zoneAllow.x + 20, this.zoneAllow.y + 30);
        
        // Draw Block Zone
        if(imgBlock && imgBlock.complete) {
             ctx.drawImage(imgBlock, this.zoneBlock.x, this.zoneBlock.y, this.zoneBlock.w, this.zoneBlock.h);
        } else {
             // Fallback
             const pulse = 0.2 + (Math.sin(Date.now() / 500) * 0.05);
             ctx.fillStyle = `rgba(255, 0, 0, ${pulse})`;
             ctx.fillRect(this.zoneBlock.x, this.zoneBlock.y, this.zoneBlock.w, this.zoneBlock.h);
             ctx.strokeStyle = "#F00"; ctx.strokeRect(this.zoneBlock.x, this.zoneBlock.y, this.zoneBlock.w, this.zoneBlock.h);
        }
        // Label selalu di atas gambar
        ctx.fillStyle = "#F00"; 
        ctx.fillText(this.zoneBlock.label, this.zoneBlock.x + 20, this.zoneBlock.y + 30);

        // Draw Packets dengan Animasi Pulse & Label
        const pulse = 1 + Math.sin(Date.now() / 200) * 0.1; // Efek denyut

        this.packets.forEach(p => {
            const img = this.game.imgs[p.imgKey]; // Ambil gambar sesuai key

            // Simpan state context untuk transformasi animasi
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.scale(pulse, pulse); // Terapkan animasi denyut

            if(img && img.complete) {
                // Render Gambar Icon
                ctx.shadowBlur = 10;
                ctx.shadowColor = p.type === 'good' ? "#00D9FF" : "#FF4444";
                ctx.drawImage(img, -30, -30, 60, 60); // Gambar center di 0,0 lokal
            } else {
                // Fallback (Lingkaran) jika gambar belum siap
                ctx.beginPath();
                ctx.shadowBlur = 10;
                ctx.shadowColor = p.type === 'good' ? "#00D9FF" : "#FF4444"; 
                ctx.fillStyle = p.type === 'good' ? "#00D9FF" : "#FF4444";
                ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore(); // Kembalikan state untuk menggambar teks (agar teks tidak ikut berdenyut)

            // GAMBAR LABEL TEKS (FIXED: UNCOMMENTED)
            ctx.shadowBlur = 0;
            ctx.fillStyle = "white"; 
            ctx.font = "bold 12px sans-serif"; 
            ctx.textAlign = "center";
            // Hilangkan prefix 'icon_' dan jadikan uppercase
            const label = p.imgKey.replace('icon_', '').toUpperCase();
            ctx.fillText(label, p.x, p.y + 45); // Posisi teks di bawah ikon
        });
        
        // Reset Text Align
        ctx.textAlign="left";

        // Instructions & Active Status
        ctx.fillStyle = "white"; ctx.font = "16px Rajdhani"; ctx.textAlign="center";
        ctx.fillText(`PAKET TERPROSES: ${this.score} / ${this.targetScore}`, 400, 550);
        
        if(!this.active) {
            ctx.fillStyle = "yellow"; ctx.font = "20px Orbitron";
            ctx.fillText("PAUSED / TUTORIAL", 400, 580);
        }
        
        ctx.textAlign="left";
    }

    cleanup() {
        // Remove Mouse Listeners
        canvas.removeEventListener('mousedown', this.evDown);
        canvas.removeEventListener('mousemove', this.evMove);
        canvas.removeEventListener('mouseup', this.evUp);
        window.removeEventListener('mouseup', this.evUp);
        
        // Remove Touch Listeners
        canvas.removeEventListener('touchstart', this.evTouchStart);
        canvas.removeEventListener('touchmove', this.evTouchMove);
        canvas.removeEventListener('touchend', this.evTouchEnd);
    }
}

class Chapter3Bomber {
    constructor(game) {
        this.game = game;
        this.tileSize = 40; 
        this.gridOffsetX = 80; 
        this.gridOffsetY = 110; 

        this.rows = 12; this.cols = 16;
        this.grid = []; 
        this.playerPos = {r:1, c:1};
        this.exitPos = {r:10, c:14}; 
        this.logsCollected = 0;
        this.logsRequired = 3;
        this.logs = [];
        this.enemies = [];
        this.bombs = [];
        this.active = false; // Start paused
        this.exitRevealed = false;
        this.scanEffect = 0;
        this.isPlacingBomb = false; 
        this.level = 1;
        this.maxLevels = 3;
        this.facingRight = true; 

        this.timeLeft = 120; 
        document.getElementById('hud-timer').innerText = this.timeLeft;
        

        this.heroFrames = game.getHeroFrames(game.player.charId);
        this.heroIdle = game.getHeroIdle(game.player.charId);
        
        this.virusImg = game.imgs.virus;
        this.logImg = game.imgs.item_keylogger;
        this.bombImg = game.imgs.icon_exe; 
        this.doorImg = game.imgs.pintu_keluar; 

        this.isMoving = false;
        this.frameIdx = 0;
        this.frameTimer = 0;
        
        this.initLevel(this.level);

        this.keyDown = (e) => {
            if(!this.active) return;
            if(e.key === 'ArrowUp') this.move(-1, 0);
            if(e.key === 'ArrowDown') this.move(1, 0);
            if(e.key === 'ArrowLeft') this.move(0, -1);
            if(e.key === 'ArrowRight') this.move(0, 1);
            if(e.key === ' ' || e.key === 'Enter') this.placeBomb();
        };
        window.addEventListener('keydown', this.keyDown);
        
        document.getElementById('dpad-controls').style.display = 'block';
        this.dpadHandler = (e) => {
            e.preventDefault();
            const key = e.target.getAttribute('data-key');
            if(!key) return;
            
            if(key === 'ArrowUp') this.move(-1, 0);
            if(key === 'ArrowDown') this.move(1, 0);
            if(key === 'ArrowLeft') this.move(0, -1);
            if(key === 'ArrowRight') this.move(0, 1);
            if(key === 'Space') this.placeBomb();
        };
        
        this.dpadEl = document.getElementById('dpad-controls');
        this.dpadEl.addEventListener('touchstart', this.dpadHandler, {passive: false});
        this.dpadEl.addEventListener('mousedown', this.dpadHandler);

        // TUTORIAL OVERLAY BOMBER
        setTimeout(() => {
            showMessage(
                "TUTORIAL: LABIRIN SERVER",
                `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
                <strong>ðŸŽ® KONTROL:</strong><br>
                ðŸ•¹ï¸ Gunakan <strong>Tombol Panah / WASD</strong> untuk bergerak.<br>
                ðŸ’£ Tekan <strong>SPASI</strong> untuk memasang Bom.<br><br>
                <strong>ðŸŽ¯ MISI:</strong><br>
                Cari 3 Keylogger yang tersembunyi di tembok rapuh!<br>
                Hindari virus penjaga!
                </div>`,
                () => {
                    this.active = true;
                    this.timerInterval = setInterval(() => {
                        if(!this.active) return;
                        this.timeLeft--;
                        document.getElementById('hud-timer').innerText = this.timeLeft;
                        if(this.timeLeft <= 0) {
                            this.cleanup();
                            this.game.triggerGameOver();
                        }
                    }, 1000);
                }
            );
        }, 500);
    }

    initLevel(lvl) {
        this.grid = [];
        this.playerPos = {r:1, c:1};
        this.exitPos = {r:10, c:14}; 
        this.logsCollected = 0;
        this.logsRequired = 3;
        this.logs = [];
        this.enemies = [];
        this.bombs = [];
        this.exitRevealed = false;
        
        if(lvl > 1) spawnFloatingScore(`LEVEL ${lvl} START!`);
        
        for(let r=0; r<this.rows; r++) {
            let row = [];
            for(let c=0; c<this.cols; c++) {
                if(r===0 || r===this.rows-1 || c===0 || c===this.cols-1 || (r%2===0 && c%2===0)) row.push(1); 
                else if(Math.random() < 0.3 && !(r===1 && c===1)) row.push(2); 
                else row.push(0); 
            }
            this.grid.push(row);
        }
        this.grid[this.exitPos.r][this.exitPos.c] = 2; 

        for(let i=0; i<3; i++) {
            let placed = false;
            while(!placed) {
                let r = Math.floor(Math.random() * (this.rows-2)) + 1;
                let c = Math.floor(Math.random() * (this.cols-2)) + 1;
                if(this.grid[r][c] === 2) { this.logs.push({r,c, collected:false}); placed = true; }
            }
        }

        // FIX (Poin 3): Ensure Enemies Spawn FAR AWAY from Player
        let enemyCount = 2 + lvl;
        let spawned = 0;
        let attempts = 0;
        while(spawned < enemyCount && attempts < 200) {
             let r = Math.floor(Math.random() * (this.rows-2)) + 1; // Range diperbaiki
             let c = Math.floor(Math.random() * (this.cols-2)) + 1;
             
             // Hitung Jarak Manhattan ke Player (r=1, c=1)
             let dist = Math.abs(r - 1) + Math.abs(c - 1);

             // Syarat: Di lantai kosong, belum ada musuh, dan JARAK > 6
             if(this.grid[r][c] === 0 && !this.enemies.some(e => e.r === r && e.c === c) && dist > 6) { 
                 this.enemies.push({r:r, c:c, dir:1, moveTimer:0});
                 spawned++;
             }
             attempts++;
        }
        
        this.scanEffect = 50;
    }

    move(dr, dc) {
        if (dc > 0) this.facingRight = true;
        if (dc < 0) this.facingRight = false;

        let nr = this.playerPos.r + dr;
        let nc = this.playerPos.c + dc;
        if(this.grid[nr][nc] === 0 || this.grid[nr][nc] === 4) {
            this.playerPos.r = nr;
            this.playerPos.c = nc;
            this.checkPickups();
            this.isMoving = true;
            this.frameIdx = (this.frameIdx + 1) % 4; 
        }
    }

    placeBomb() { 
        this.bombs.push({r:this.playerPos.r, c:this.playerPos.c, timer: 120}); 
        this.isPlacingBomb = true;
        setTimeout(() => this.isPlacingBomb = false, 300);
    }

    update(dt) {
        if(!this.active) return;
        if(this.scanEffect > 0) this.scanEffect--;
        
        if(this.isMoving) {
            setTimeout(() => {this.isMoving = false}, 100);
        }

        for(let i=this.bombs.length-1; i>=0; i--) {
            let b = this.bombs[i]; b.timer--;
            if(b.timer <= 0) { this.explode(b.r, b.c); this.bombs.splice(i, 1); }
        }
        
        this.enemies.forEach(e => {
            e.moveTimer++;
            // FIX (Poin 4): SLOWER ENEMIES
            // Base timer dinaikkan dari 30 ke 55 (makin tinggi makin lambat)
            // Scaling per level: Lvl 1=50, Lvl 2=45, Lvl 3=40
            if(e.moveTimer > 55 - (this.level * 5)) {
                let moves = [[0,1], [0,-1], [1,0], [-1,0]];
                let m = moves[Math.floor(Math.random()*4)];
                if(this.grid[e.r+m[0]][e.c+m[1]] === 0) { e.r += m[0]; e.c += m[1]; }
                e.moveTimer = 0;
            }
            if(e.r === this.playerPos.r && e.c === this.playerPos.c) { this.showFailMessage(); }
        });
    }

    showFailMessage() {
        this.active = false;
        this.game.triggerGameOver();
    }

    explode(r, c) {
        AudioMgr.playSFX('sfx-wrong'); // Sound ledakan
        
        // Cek 5 titik (Tengah + Atas/Bawah/Kiri/Kanan)
        let fl = [{r,c}, {r:r+1,c}, {r:r-1,c}, {r,c:c+1}, {r,c:c-1}];
        
        fl.forEach(p => {
            // 1. Hancurkan Tembok Rapuh
            if(this.grid[p.r][p.c] === 2) { 
                this.grid[p.r][p.c] = 0; 
                this.game.addScore(10); 
            }

            // 2. FIX (Poin 2): Hancurkan Musuh jika terkena ledakan
            for(let i = this.enemies.length - 1; i >= 0; i--) {
                let e = this.enemies[i];
                if(e.r === p.r && e.c === p.c) {
                    this.enemies.splice(i, 1); // Hapus musuh
                    this.game.addScore(50);
                    spawnFloatingScore("VIRUS DELETED!");
                    // Opsi: Mainkan suara musuh mati jika ada
                }
            }
        });
    }

    checkPickups() {
        this.logs.forEach(l => {
            if(!l.collected && l.r === this.playerPos.r && l.c === this.playerPos.c) {
                l.collected = true; this.logsCollected++; this.game.addScore(100); AudioMgr.playSFX('sfx-correct'); spawnFloatingScore("KEYLOGGER +1");
                if(this.logsCollected >= this.logsRequired) { this.exitRevealed = true; spawnFloatingScore("IP DETECTED!"); }
            }
        });
        if(this.exitRevealed && this.playerPos.r === this.exitPos.r && this.playerPos.c === this.exitPos.c) {
            AudioMgr.playSFX('sfx-correct');
            if(this.level < this.maxLevels) {
                this.level++;
                this.initLevel(this.level);
            } else {
                this.active = false; this.cleanup(); this.game.startChapter3Quiz();
            }
        }
    }

    draw(ctx) {
        // ... existing background drawing ...
        // FIX 2: Draw Full Background Once
        let floorImg = this.game.imgs['bomb_lt' + this.level];
        const totalW = this.cols * this.tileSize;
        const totalH = this.rows * this.tileSize;
        
        if(floorImg && floorImg.complete) {
             ctx.drawImage(floorImg, this.gridOffsetX, this.gridOffsetY, totalW, totalH);
        } else {
             ctx.fillStyle = "#222"; ctx.fillRect(this.gridOffsetX, this.gridOffsetY, totalW, totalH);
        }

        // ... existing Grid Loop ...
        for(let r=0; r<this.rows; r++) {
            for(let c=0; c<this.cols; c++) {
                let x = c*this.tileSize + this.gridOffsetX; 
                let y = r*this.tileSize + this.gridOffsetY;

                if(this.grid[r][c] === 1) { 
                    if(this.game.imgs.tile_tembok && this.game.imgs.tile_tembok.complete) {
                        ctx.drawImage(this.game.imgs.tile_tembok, x, y, this.tileSize, this.tileSize);
                    } else {
                        ctx.fillStyle = "#444"; ctx.fillRect(x,y,this.tileSize,this.tileSize); ctx.strokeStyle="#555"; ctx.strokeRect(x,y,this.tileSize,this.tileSize); 
                    }
                }
                else if(this.grid[r][c] === 2) { 
                    if(this.game.imgs.tile_meledak && this.game.imgs.tile_meledak.complete) {
                        ctx.drawImage(this.game.imgs.tile_meledak, x, y, this.tileSize, this.tileSize);
                    } else {
                        ctx.fillStyle = "#840"; ctx.fillRect(x,y,this.tileSize,this.tileSize); ctx.strokeStyle="#A60"; ctx.strokeRect(x,y,this.tileSize,this.tileSize); 
                    }
                }
            }
        }
        
        // ... existing Items/Bombs Loop ...
        let pulseLog = 1 + Math.sin(Date.now() / 250) * 0.15;

        this.logs.forEach(l => {
            if(!l.collected && this.grid[l.r][l.c] === 0) {
                 let lx = l.c*this.tileSize + this.gridOffsetX + 5;
                 let ly = l.r*this.tileSize + this.gridOffsetY + 5;
                 let lw = 30 * pulseLog;
                 
                 let offset = (30 - lw) / 2;

                 if(this.logImg && this.logImg.complete) ctx.drawImage(this.logImg, lx + offset, ly + offset, lw, lw);
                 else { ctx.fillStyle = "#0FF"; ctx.beginPath(); ctx.arc(lx + 15, ly + 15, 10, 0, Math.PI*2); ctx.fill(); }
            }
        });
        
        if(this.exitRevealed && this.grid[this.exitPos.r][this.exitPos.c] === 0) { 
            let ex = this.exitPos.c*this.tileSize + this.gridOffsetX;
            let ey = this.exitPos.r*this.tileSize + this.gridOffsetY;
            
            if(this.doorImg && this.doorImg.complete) {
                ctx.drawImage(this.doorImg, ex, ey, 40, 40);
            } else {
                 ctx.fillStyle = "#0F0"; ctx.fillRect(ex + 5, ey + 5, 30, 30); 
                 ctx.fillStyle = "black"; ctx.fillText("OUT", ex + 5, ey + 25);
            }
        }
        
        this.bombs.forEach(b => { 
            let bx = b.c*this.tileSize + this.gridOffsetX;
            let by = b.r*this.tileSize + this.gridOffsetY;
            let pulse = Math.abs(Math.sin(Date.now() / 100)) * 5;
            
            if(this.bombImg && this.bombImg.complete) ctx.drawImage(this.bombImg, bx + 5 - (pulse/2), by + 5 - (pulse/2), 30+pulse, 30+pulse);
            else { ctx.fillStyle = `rgb(${255}, ${pulse*20}, 0)`; ctx.beginPath(); ctx.arc(bx + 20, by + 20, 15 + (pulse/2), 0, Math.PI*2); ctx.fill(); }
        });
        
        this.enemies.forEach(e => {
            let ex = e.c*this.tileSize + this.gridOffsetX;
            let ey = e.r*this.tileSize + this.gridOffsetY;
            let wobble = Math.sin(Date.now() / 200) * 5;
            
            if(this.virusImg && this.virusImg.complete) ctx.drawImage(this.virusImg, ex + wobble, ey, 40, 40);
            else { ctx.fillStyle = "purple"; ctx.beginPath(); ctx.arc(ex + 20, ey + 20, 20, 0, Math.PI*2); ctx.fill(); }
        });

        // ... existing Player Drawing ...
        let pImg;
        if(this.isMoving) { pImg = this.heroFrames[this.frameIdx]; } else { pImg = this.heroIdle; }
        let px = this.playerPos.c*this.tileSize + this.gridOffsetX;
        let py = this.playerPos.r*this.tileSize + this.gridOffsetY;
        ctx.save();
        ctx.translate(px + 20, py + 15);
        if(this.facingRight) { ctx.scale(-1, 1); }
        if(pImg && pImg.complete) { ctx.drawImage(pImg, -20, -25, 40, 50); } else { ctx.fillStyle = "#00A8FF"; ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill(); }
        ctx.restore();

        // --- FIX (Poin 4): UI OVERLAY JELAS ---
        // Latar belakang panel UI agar lebih jelas di bawah Purity
        ctx.fillStyle = "rgba(0,0,0,0.85)"; 
        ctx.fillRect(10, 80, 280, 80);
        ctx.strokeStyle = "#00D9FF";
        ctx.strokeRect(10, 80, 280, 80);

        ctx.fillStyle = "#FFD700"; 
        ctx.font = "bold 22px Orbitron";
        ctx.fillText(`LANTAI ${this.level} / ${this.maxLevels}`, 20, 110);
        
        ctx.fillStyle = "white"; 
        ctx.font = "18px Rajdhani";
        ctx.fillText(`KEYLOGGERS: ${this.logsCollected}/${this.logsRequired}`, 20, 140);
        
        // --- NEW: MISSION TEXT OVERLAY (BAWAH LAYAR) ---
        // Kotak Misi yang jelas
        ctx.fillStyle = "rgba(0,0,0,0.85)";
        ctx.fillRect(100, 550, 600, 40);
        ctx.strokeStyle = "#00FF88";
        ctx.lineWidth = 2;
        ctx.strokeRect(100, 550, 600, 40);

        ctx.fillStyle = "#00FF88";
        ctx.font = "16px Rajdhani";
        ctx.textAlign = "center";
        ctx.fillText("MISI: Cari Keylogger & Hindari Virus Penjaga!", 400, 575);
        ctx.textAlign = "left";

        if(this.scanEffect > 0) { ctx.fillStyle = `rgba(0, 217, 255, ${this.scanEffect/200})`; ctx.fillRect(0,0,800,600); ctx.fillStyle = "white"; ctx.font = "30px Orbitron"; ctx.textAlign="center"; ctx.fillText(`MEMINDAI LANTAI ${this.level}...`, 400, 300); ctx.textAlign="left"; }
    }
    // ... existing cleanup ...
}

// ... [CLASS BOSS BATTLE TETAP SAMA] ...
// --- NEW CLASS: CHAPTER BOSS BATTLE (REAL-TIME ARPG STYLE) ---
class ChapterBossBattle {
    constructor(game) {
        this.game = game;
        this.active = false; // Start paused
        
        // Setup Characters (CharacterSprite untuk animasi)
        const frames = game.getHeroFrames(game.player.charId);
        const idle = game.getHeroIdle(game.player.charId);
        // Player stats for Action RPG
        this.playerX = 100;
        this.playerY = 300;
        this.playerSpeed = 8; // UPDATED: Increased from 5 to 8 for better feel
        this.playerHp = 100;
        this.maxPlayerHp = 100;
        this.playerCooldown = 0; // Cooldown serangan (frames)
        
        // DASH MECHANIC VARS
        this.isDashing = false;
        this.dashTimer = 0;
        this.dashCooldown = 0;
        this.dashDuration = 10; // Frames duration
        this.invincible = false; // I-Frames status

        this.hero = new CharacterSprite(idle, frames, this.playerX, this.playerY, 96); 
        
        // Boss Stats
        this.bossX = 600;
        this.bossY = 300;
        this.bossHp = 1500;
        this.maxBossHp = 1500;
        this.bossState = 'idle'; 
        this.bossDirY = 1;
        this.bossAttackTimer = 0;
        this.bossMinionTimer = 0;
        
        // Game Objects
        this.projectiles = []; // {x, y, vx, vy, type: 'player'|'boss', damage}
        this.minions = [];     // {x, y, hp, speed}
        this.particles = [];
        this.damageTexts = [];
        
        this.keys = {};
        
        // Input Listeners
        this.keyDownHandler = (e) => this.keys[e.key] = true;
        this.keyUpHandler = (e) => this.keys[e.key] = false;
        window.addEventListener('keydown', this.keyDownHandler);
        window.addEventListener('keyup', this.keyUpHandler);

        // UI Setup
        document.getElementById('rpg-controls').style.display = 'flex'; 

        // TUTORIAL OVERLAY BOSS - ADDED TIMEOUT
        setTimeout(() => {
            showMessage(
                "BOSS BATTLE: FINAL PHASE",
                `<div style='text-align:left; font-size:1rem; line-height:1.5;'>
                <strong>ðŸŽ® KONTROL:</strong><br>
                ðŸƒ WASD / ARAH = Hindari Serangan<br>
                ðŸ’¨ <strong>SHIFT / DASH</strong> = Dodge Roll (Kebal Sesaat)<br>
                âš”ï¸ SPASI / TOMBOL ATK = Serang Boss<br>
                âš¡ Z / TOMBOL SKILL = Serangan Kuat (Butuh Energi)<br><br>
                <strong>ðŸŽ¯ MISI:</strong><br>
                Kalahkan Genderuwo Malware!
                </div>`,
                () => { this.active = true; }
            );
        }, 500);
    }

    // Helper functions for external calls (Buttons)
    attack() { this.spawnPlayerProjectile(false); }
    skill() { this.spawnPlayerProjectile(true); }
    
    // NEW DASH FUNCTION
    dash() {
        if (this.dashCooldown <= 0 && !this.isDashing) {
            this.isDashing = true;
            this.dashTimer = this.dashDuration;
            this.dashCooldown = 40; // Cooldown frames (~0.7s)
            this.invincible = true;
            
            // Visual & Audio
            // AudioMgr.playSFX('sfx-click'); // Optional sound
            
            // Burst Particles for visual feedback
            for(let i=0; i<8; i++) {
                this.particles.push({
                    x: this.playerX + 40, y: this.playerY + 40,
                    vx: -5 + Math.random()*10, vy: -5 + Math.random()*10,
                    life: 0.5, color: '#FFF', size: 4
                });
            }
            
            // UI Feedback
            const btn = document.getElementById('btn-dash');
            if(btn) btn.classList.add('cooldown');
        }
    }

    // ... rest of ChapterBossBattle unchanged ...
    spawnPlayerProjectile(isSkill) {
        if(this.playerCooldown > 0) return;
        
        let damage = 25;
        let color = '#00FFFF';
        let size = 15;
        let cooldownTime = 20;

        if(isSkill) {
            if(this.game.player.toyaPurity < 10) {
                 spawnFloatingScore("BUTUH ENERGY!");
                 return;
            }
            this.game.updatePurityDisplay(this.game.player.toyaPurity - 10);
            damage = 80;
            color = '#FFD700'; // Gold
            size = 40;
            cooldownTime = 60;
            AudioMgr.playSFX('sfx-correct'); // Skill sound
        } else {
            AudioMgr.playSFX('sfx-click'); // Attack sound
        }

        this.projectiles.push({
            x: this.playerX + 40,
            y: this.playerY,
            vx: 12, // Move Right
            vy: 0,
            type: 'player',
            damage: damage,
            color: color,
            size: size
        });
        
        this.playerCooldown = cooldownTime;
    }

    spawnBossProjectile() {
        // Boss shoots at player position
        const dx = this.playerX - this.bossX;
        const dy = this.playerY - this.bossY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        this.projectiles.push({
            x: this.bossX,
            y: this.bossY,
            vx: (dx/dist) * 6,
            vy: (dy/dist) * 6,
            type: 'boss',
            damage: 10,
            color: '#FF00FF', // Purple
            size: 10
        });
        AudioMgr.playSFX('sfx-wrong');
    }

    spawnMinion() {
        // Spawn Virus Minion near boss
        this.minions.push({
            x: this.bossX - 50,
            y: this.bossY + (Math.random() * 100 - 50),
            hp: 30,
            maxHp: 30,
            speed: 2 + Math.random()
        });
    }

    update(dt) {
        if(!this.active) return;
        
        // 0. Handle Dash Inputs & Logic
        if ((this.keys['Shift'] || this.keys['Control']) && !this.isDashing) {
            this.dash();
        }

        // Manage Dash Cooldown UI
        if(this.dashCooldown > 0) {
            this.dashCooldown--;
            if(this.dashCooldown <= 0) {
                const btn = document.getElementById('btn-dash');
                if(btn) btn.classList.remove('cooldown');
            }
        }

        let currentSpeed = this.playerSpeed;
        
        // Apply Dash Effect
        if (this.isDashing) {
            currentSpeed = 20; // Burst Speed
            this.dashTimer--;
            
            // Create afterimage/ghost effect
            if (this.dashTimer % 2 === 0) {
                 this.particles.push({
                    x: this.playerX + 40, y: this.playerY + 40,
                    vx: 0, vy: 0,
                    life: 0.2, color: 'rgba(255, 255, 255, 0.4)', size: 35
                });
            }

            if (this.dashTimer <= 0) {
                this.isDashing = false;
                this.invincible = false;
            }
        }

        // 1. Player Movement (Real-Time)
        let moved = false;
        if(this.keys['ArrowUp'] || this.keys['w']) { this.playerY -= currentSpeed; moved = true; }
        if(this.keys['ArrowDown'] || this.keys['s']) { this.playerY += currentSpeed; moved = true; }
        if(this.keys['ArrowLeft'] || this.keys['a']) { this.playerX -= currentSpeed; moved = true; }
        if(this.keys['ArrowRight'] || this.keys['d']) { this.playerX += currentSpeed; moved = true; }
        
        // Attack Keys
        if(this.keys[' ']) { this.attack(); } // Space to attack
        if(this.keys['z']) { this.skill(); }

        // Clamp Player to Screen
        this.playerX = Math.max(20, Math.min(780, this.playerX));
        this.playerY = Math.max(50, Math.min(550, this.playerY));

        // Update Hero Sprite Logic (sync with simple x/y)
        this.hero.x = this.playerX;
        this.hero.y = this.playerY;
        // Manual animation update since not using moveTo()
        if(moved) {
            this.hero.frameTimer += dt;
            if(this.hero.frameTimer > 150) { 
                this.hero.frameIdx = (this.hero.frameIdx + 1) % 4; 
                this.hero.frameTimer = 0; 
            }
        } else {
            this.hero.frameIdx = 0; // Idle frame
        }

        // Cooldown
        if(this.playerCooldown > 0) this.playerCooldown--;

        // 2. Boss Logic (Real-Time)
        // Float movement
        this.bossY += this.bossDirY * 2;
        if(this.bossY < 100 || this.bossY > 500) this.bossDirY *= -1;

        // Boss Actions (Independent Timers)
        this.bossAttackTimer++;
        if(this.bossAttackTimer > 60) { // Shoot every ~1 sec
            this.spawnBossProjectile();
            this.bossAttackTimer = 0;
        }

        this.bossMinionTimer++;
        if(this.bossMinionTimer > 200) { // Spawn minion every ~3 sec
            this.spawnMinion();
            this.bossMinionTimer = 0;
        }

        // 3. Update Minions
        for(let i = this.minions.length - 1; i >= 0; i--) {
            let m = this.minions[i];
            // Move towards player
            const dx = this.playerX - m.x;
            const dy = this.playerY - m.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if(dist > 5) {
                m.x += (dx/dist) * m.speed;
                m.y += (dy/dist) * m.speed;
            }

            // Collide with Player (Check Invincible)
            if(!this.invincible && dist < 30) {
                this.playerHp -= 0.5; // Damage over time contact
                this.game.gameStats.damageTaken += 0.5;
                this.spawnDamage(this.playerX, this.playerY, "-1", "red");
            }
        }

        // 4. Update Projectiles & Collisions
        for(let i = this.projectiles.length - 1; i >= 0; i--) {
            let p = this.projectiles[i];
            p.x += p.vx;
            p.y += p.vy;

            // Remove if out of bounds
            if(p.x < 0 || p.x > 800 || p.y < 0 || p.y > 600) {
                this.projectiles.splice(i, 1);
                continue;
            }

            let hit = false;
            
            if(p.type === 'player') {
                // Check Boss Hit
                if(Math.hypot(p.x - this.bossX, p.y - this.bossY) < 80) {
                    this.bossHp -= p.damage;
                    this.game.screenShake = 5; // Boss Hit Shake
                    this.spawnDamage(this.bossX, this.bossY, p.damage, "orange");
                    this.spawnExplosion(p.x, p.y, p.color);
                    hit = true;
                    if(this.bossHp <= 0) this.winBattle();
                }
                
                // Check Minion Hit
                if(!hit) {
                    for(let j=this.minions.length-1; j>=0; j--) {
                        let m = this.minions[j];
                        if(Math.hypot(p.x - m.x, p.y - m.y) < 30) {
                            m.hp -= p.damage;
                            this.spawnExplosion(m.x, m.y, "green");
                            hit = true;
                            if(m.hp <= 0) {
                                this.minions.splice(j, 1);
                                this.game.gameStats.totalKills++;
                                this.spawnDamage(m.x, m.y, "KILL", "gold");
                            }
                            break; 
                        }
                    }
                }
            } else if (p.type === 'boss') {
                // Check Player Hit (Check Invincible)
                if(!this.invincible && Math.hypot(p.x - this.playerX, p.y - this.playerY) < 30) {
                    this.playerHp -= p.damage;
                    this.game.gameStats.damageTaken += p.damage;
                    this.game.screenShake = 20; // Player Hit Shake (Hard)
                    this.spawnDamage(this.playerX, this.playerY, "-" + p.damage, "red");
                    this.spawnExplosion(p.x, p.y, "red");
                    hit = true;
                    if(this.playerHp <= 0) this.loseBattle();
                }
            }

            if(hit) {
                this.projectiles.splice(i, 1);
            }
        }

        // 5. FX Updates
        for(let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            if(p.life <= 0) this.particles.splice(i, 1);
        }
        for(let i = this.damageTexts.length - 1; i >= 0; i--) {
            let t = this.damageTexts[i];
            t.y -= 1; t.life -= 0.02;
            if(t.life <= 0) this.damageTexts.splice(i, 1);
        }
    }

    winBattle() {
        this.active = false;
        this.cleanup();
        this.game.startEndingCinematic(); // Ini akan memicu audio/ending.mp3
    }

    loseBattle() {
        this.active = false;
        this.cleanup();
        this.game.triggerGameOver();
    }

    draw(ctx) {
        // Draw Background Overlay (Darken)
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillRect(0,0,800,600);

        // Draw Player
        this.hero.draw(ctx);
        
        // --- VISUAL EFFECT FOR DASH (GLOW) ---
        if(this.isDashing) {
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            ctx.beginPath();
            ctx.arc(this.playerX + 40, this.playerY + 40, 50, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fill();
            ctx.restore();
        }

        // --- DRAW PLAYER HUD HP (NEW) ---
        // Bar HP Statis di Pojok Kiri Atas
        const playerHpPct = Math.max(0, this.playerHp / this.maxPlayerHp);
        
        // Border
        ctx.fillStyle = "rgba(0,0,0,0.8)"; 
        ctx.fillRect(20, 50, 200, 20); 
        ctx.strokeStyle = "#FFF"; ctx.lineWidth=2; 
        ctx.strokeRect(20, 50, 200, 20);
        
        // Fill Color (Green -> Red)
        ctx.fillStyle = playerHpPct > 0.3 ? "#00FF88" : "#FF4444"; 
        ctx.fillRect(22, 52, 196 * playerHpPct, 16);
        
        // Text Label
        ctx.fillStyle = "white"; ctx.font = "bold 14px Orbitron"; ctx.textAlign = "left";
        ctx.fillText(`GUARDIAN HP: ${Math.floor(this.playerHp)}%`, 20, 45);

        // Draw Boss (Virus Genderuwo)
        const bossImg = this.game.imgs.virus;
        if(bossImg && bossImg.complete) {
            const size = 200;
            ctx.drawImage(bossImg, this.bossX - size/2, this.bossY - size/2, size, size);
        } else {
            ctx.fillStyle = "purple"; ctx.beginPath(); ctx.arc(this.bossX, this.bossY, 80, 0, Math.PI*2); ctx.fill();
        }

        // Draw Boss HP Bar (Top Center)
        const bossHpPct = Math.max(0, this.bossHp / this.maxBossHp);
        ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(250, 50, 400, 20); ctx.strokeStyle = "#FFF"; ctx.lineWidth=2; ctx.strokeRect(250, 50, 400, 20);
        ctx.fillStyle = "#FF0000"; ctx.fillRect(252, 52, 396 * bossHpPct, 16);
        ctx.fillStyle = "white"; ctx.font = "bold 16px Orbitron"; ctx.textAlign = "center";
        ctx.fillText(`BOSS: GENDERUWO MALWARE (${this.bossHp}/${this.maxBossHp})`, 450, 40);
        ctx.textAlign = "left";

        // Draw Minions
        const minionImg = this.game.imgs.virus; // Use same virus asset but smaller
        this.minions.forEach(m => {
            if(minionImg && minionImg.complete) {
                ctx.drawImage(minionImg, m.x - 20, m.y - 20, 40, 40);
            } else {
                ctx.fillStyle = "green"; ctx.beginPath(); ctx.arc(m.x, m.y, 15, 0, Math.PI*2); ctx.fill();
            }
        });

        // Draw Projectiles
        this.projectiles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.beginPath();
            if(p.type === 'player' && p.size > 20) {
                 // Skill effect (Slash)
                 ctx.ellipse(p.x, p.y, p.size, p.size/2, 0, 0, Math.PI*2);
            } else {
                 ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            }
            ctx.fill();
        });

        // Draw Effects
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life; ctx.fillStyle = p.color; 
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        });
        
        this.damageTexts.forEach(t => {
            ctx.globalAlpha = t.life; 
            ctx.fillStyle = t.color; 
            ctx.font = "bold 20px Orbitron"; 
            ctx.strokeStyle = "black"; ctx.lineWidth = 2;
            ctx.strokeText(t.val, t.x, t.y);
            ctx.fillText(t.val, t.x, t.y);
        });
        ctx.globalAlpha = 1;

        // Draw Controls Hint
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, 550, 800, 50);
        ctx.fillStyle = "white"; ctx.font = "16px Rajdhani"; ctx.textAlign="left";
        ctx.fillText("WASD: Gerak | SHIFT: Dash | SPASI: Attack | Z: Skill", 20, 580);
    }

    spawnDamage(x, y, val, color) {
        this.damageTexts.push({ x, y, val, color, life: 1.0 });
    }

    spawnExplosion(x, y, color) {
        for(let i=0; i<8; i++) {
            this.particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                size: Math.random() * 4 + 2,
                color: color,
                life: 1.0
            });
        }
    }

    cleanup() {
        window.removeEventListener('keydown', this.keyDownHandler);
        window.removeEventListener('keyup', this.keyUpHandler);
        document.getElementById('rpg-controls').style.display = 'none';
        this.active = false;
    }
}

const app = new GameApp();
</script>
</body>
</html>
