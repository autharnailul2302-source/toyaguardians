<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toya Guardians: Tirtatelaga Defense</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* --- STYLES UTAMA --- */
        :root {
            --primary-blue: #00A8FF; --tech-cyan: #00D9FF; --accent-gold: #FFD700;
            --dark-base: #050A14; --danger-red: #FF4444; --success-green: #00FF88;
            --glass-panel: rgba(5, 20, 40, 0.95);
        }
        body { margin: 0; padding: 0; background-color: #000; color: white; font-family: 'Rajdhani', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; background: radial-gradient(circle, var(--dark-base) 0%, #000000 100%); }
        #game-container { position: relative; width: 800px; height: 600px; background: #000; border: 2px solid var(--primary-blue); box-shadow: 0 0 30px rgba(0, 168, 255, 0.3); overflow: hidden; border-radius: 8px; }
        @media (max-width: 800px) { #game-container { width: 100vw; height: 100vh; border: none; border-radius: 0; } }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* UI SCREENS */
        .ui-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* SCREEN SPLASH (LOADING BAR) */
        #screen-splash { background-color: #000; z-index: 100; font-family: 'VT323', monospace; color: var(--primary-blue); text-align: center; align-items: center; padding: 50px; box-sizing: border-box; }
        #loading-pct-large { font-size: 4rem; margin-bottom: 10px; text-shadow: 0 0 15px var(--primary-blue); color: var(--accent-gold); }
        .terminal-text { font-size: 1.2rem; margin-bottom: 5px; text-shadow: 0 0 5px var(--primary-blue); text-align: left; width: 100%; max-width: 600px; }
        .loading-bar-container { width: 100%; max-width: 600px; height: 20px; border: 2px solid var(--primary-blue); margin-top: 10px; padding: 2px; align-self: center; }
        .loading-bar-fill { height: 100%; background-color: var(--primary-blue); width: 0%; box-shadow: 0 0 15px var(--primary-blue); transition: width 0.1s; }

        /* TITLE & LIGHTNING */
        #screen-title { background-color: var(--dark-base); background-image: linear-gradient(rgba(5, 20, 40, 0.4), rgba(5, 20, 40, 0.9)), url('images/bg_title.png'); background-size: cover; background-position: center; justify-content: flex-start; padding-top: 20px; }
        
        /* Logo Container Updated */
        #logo-container { margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; overflow: visible; }
        
        /* Main Logo Animation */
        #logo-img { width: auto; height: auto; max-width: 80%; max-height: 420px; display: block; filter: drop-shadow(0 0 25px rgba(0, 168, 255, 0.7)); object-fit: contain; animation: floatLogo 3s ease-in-out infinite; }
        
        /* Subtitle Animation */
        #subtitle-img { width: auto; height: auto; max-width: 70%; max-height: 90px; margin-top: -140px; display: block; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)); animation: floatLogo 3.5s ease-in-out infinite reverse; }
        
        @keyframes floatLogo { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        /* Lightning Flash Overlay */
        #lightning-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 5; mix-blend-mode: overlay; }
        
        /* REGISTER & CHAR SELECT */
        .panel { background: var(--glass-panel); padding: 30px; border: 1px solid var(--primary-blue); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 168, 255, 0.2); max-width: 400px; width: 90%; backdrop-filter: blur(5px); position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: var(--danger-red); font-size: 1.5rem; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; transition: 0.2s; }
        .close-btn:hover { transform: scale(1.2); text-shadow: 0 0 10px red; }
        
        .form-group { margin-bottom: 10px; text-align: left; }
        label { color: var(--tech-cyan); font-weight: bold; font-size: 0.8rem; display: block; margin-bottom: 3px; }
        input, select { width: 100%; padding: 8px; background: rgba(0,0,0,0.6); border: 1px solid #445; color: white; font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--tech-cyan); box-shadow: 0 0 10px var(--primary-blue); }
        
        /* Button Animations */
        @keyframes pulseButton { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(0, 168, 255, 0.7); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(0, 168, 255, 0.7); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(0, 168, 255, 0); } }
        .btn-anim { animation: pulseButton 2s infinite; }

        .btn-ml { background: linear-gradient(180deg, var(--primary-blue) 0%, #0056b3 100%); border: 2px solid var(--tech-cyan); color: white; padding: 12px 30px; font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 1.1rem; border-radius: 6px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 0 #003366, 0 0 15px rgba(0, 168, 255, 0.4); transition: 0.1s; margin-top: 15px; width: 100%; position: relative; overflow: hidden; }
        .btn-ml:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-ml:active { transform: translateY(4px); box-shadow: none; border-color: #556; }
        .btn-ml:disabled { background: #333; color: #777; border-color: #555; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(100%); }
        .btn-music-toggle { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--tech-cyan); color: var(--tech-cyan); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1.2rem; z-index: 100; transition: 0.3s; }
        
        #screen-register { 
            background-color: var(--dark-base); 
            background-image: linear-gradient(rgba(5, 20, 40, 0.8), rgba(5, 20, 40, 0.9)), url('images/bg_noc.png'); 
            background-size: cover; 
            background-position: center; 
            flex-direction: row; 
            gap: 30px;
        }
        .reg-illustration { width: 250px; height: 400px; background: rgba(0,0,0,0.3); border: 1px solid var(--primary-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; display: none; }
        @media (min-width: 800px) { .reg-illustration { display: flex; } }
        .reg-illustration img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; filter: grayscale(50%); }

        #screen-char { 
            background-color: var(--dark-base); 
            background-image: linear-gradient(rgba(5, 20, 40, 0.7), rgba(5, 20, 40, 0.9)), url('images/bg_noc.png'); 
            background-size: cover; 
            background-position: center; 
        }
        .char-grid { display: flex; gap: 20px; margin-top: 20px; justify-content: center; }
        .char-card { background: rgba(255,255,255,0.05); border: 2px solid #445; border-radius: 12px; padding: 10px; cursor: pointer; width: 120px; text-align: center; transition: 0.3s; position: relative; overflow: hidden; }
        .char-card img { width: 100%; height: 130px; object-fit: cover; object-position: top center; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); image-rendering: pixelated; border-radius: 8px; }
        .char-card.selected { border-color: var(--tech-cyan); background: linear-gradient(135deg, rgba(0, 168, 255, 0.1), rgba(0, 86, 179, 0.3)); transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 168, 255, 0.4); }

        /* STORY & HUD */
        #screen-story { justify-content: flex-end; background-color: #000; }
        #story-bg { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; opacity: 0.6; background-image: url('images/bg_server.png'); transition: background-image 0.5s ease-in-out; }
        .dialogue-box { position: relative; width: 90%; min-height: 160px; background: linear-gradient(90deg, rgba(5, 20, 40, 0.95), rgba(10, 30, 60, 0.9)); border: 2px solid var(--tech-cyan); margin-bottom: 20px; padding: 20px; box-sizing: border-box; display: flex; align-items: flex-end; border-radius: 12px; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .char-portrait { width: 100px; height: 100px; background: #000; border: 2px solid var(--primary-blue); margin-right: 20px; flex-shrink: 0; overflow: hidden; border-radius: 8px; margin-bottom: 10px; }
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .dialogue-text { width: 100%; }
        .dialogue-text h3 { margin: 0 0 5px 0; color: var(--tech-cyan); font-family: 'Orbitron'; font-size: 1.2rem; }
        .dialogue-text p { margin: 0; font-size: 1.1rem; line-height: 1.4; color: #eee; }
        .next-arrow { position: absolute; bottom: 15px; right: 20px; color: var(--accent-gold); animation: bounce 1s infinite; font-size: 1.5rem; cursor: pointer; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; box-sizing: border-box; display: none; justify-content: space-between; pointer-events: none; z-index: 20; }
        .hud-top-left { display:flex; gap:10px; flex-direction: column; align-items: flex-start; }
        .hud-panel { background: rgba(5, 20, 40, 0.85); border: 1px solid var(--tech-cyan); padding: 5px 15px; border-radius: 6px; color: white; font-family: 'Orbitron'; font-size: 1rem; display: flex; flex-direction: column; align-items: center; min-width: 80px; box-shadow: 0 0 10px rgba(0, 168, 255, 0.2); }
        .hud-val { font-size: 1.2rem; font-weight: bold; }
        .purity-container { width: 150px; height: 10px; background: #333; border: 1px solid #555; margin-top: 5px; position: relative; }
        /* Purity Fill with Dynamic Color Transition */
        .purity-fill { height: 100%; width: 100%; transition: width 0.3s, background-color 0.5s; box-shadow: 0 0 5px var(--tech-cyan); }
        
        #mission-overlay { 
            background: linear-gradient(90deg, rgba(5, 20, 40, 0.95), rgba(10, 30, 60, 0.8));
            border: 1px solid var(--accent-gold); padding: 8px 15px; border-radius: 6px; 
            color: var(--accent-gold); font-family: 'Orbitron', sans-serif; font-size: 0.9rem; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); display: none; z-index: 20;
        }

        /* RPG CONTROLS (NEW) */
        #rpg-controls {
            position: absolute; bottom: 20px; right: 20px; display: none; gap: 15px; z-index: 50;
        }
        .rpg-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Orbitron'; font-weight: bold; font-size: 0.9rem;
            color: white; cursor: pointer; user-select: none;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .rpg-btn:active { transform: scale(0.9); }
        #btn-atk { background: radial-gradient(circle, #FF4444, #880000); border-color: #FF8888; width: 80px; height: 80px; font-size: 1.1rem; }
        #btn-skill { background: radial-gradient(circle, #00D9FF, #0056b3); border-color: #88FFFF; }
        .cooldown { filter: grayscale(1); opacity: 0.5; pointer-events: none; }

        /* FLOATING TEXT (New) */
        .float-score { position: absolute; color: var(--accent-gold); font-family: 'Orbitron'; font-weight: bold; font-size: 1.5rem; text-shadow: 0 0 10px black; animation: floatUp 1s forwards; pointer-events: none; z-index: 50; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* NEW: Custom Message Box */
        #custom-message-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(5, 20, 40, 0.98), rgba(10, 30, 60, 0.98));
            border: 3px solid var(--accent-gold); border-radius: 10px; padding: 25px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); z-index: 1000;
            max-width: 450px; text-align: center; display: none;
            flex-direction: column; align-items: center;
        }
        #msg-icon { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--primary-blue); margin-bottom: 10px; object-fit: cover; object-position: top center; background: #000; display: none; }
        #msg-title { color: var(--tech-cyan); font-family: 'Orbitron'; font-size: 1.5rem; margin-bottom: 10px; margin-top: 0; }
        #msg-body { color: white; margin-bottom: 20px; }
        .btn-msg-ok { background: linear-gradient(180deg, var(--primary-blue) 0%, #0056b3 100%); border: 2px solid var(--tech-cyan); color: white; padding: 8px 20px; font-family: 'Orbitron'; border-radius: 5px; cursor: pointer; }


        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #ccc; font-size: 0.8rem;}
        #leaderboard-table th { text-align: left; color: var(--tech-cyan); border-bottom: 1px solid #445; padding: 5px;}
        #leaderboard-table td { border-bottom: 1px solid #223; padding: 5px; }
        .lb-controls { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; flex-wrap: wrap; }
        .lb-select { flex: 1; padding: 5px; background: rgba(0,0,0,0.5); border: 1px solid #445; color: white; font-family: 'Rajdhani'; min-width: 150px;}

        #screen-loading { background-color: #000; z-index: 99; color: var(--primary-blue); font-family: 'Orbitron'; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <!-- NEW STYLES for Chapter Title and Quiz -->
    <style>
        #screen-title-ch1, #screen-title-ch2, #screen-title-ch3 { background-color: #111; }
        #screen-quiz { background-image: linear-gradient(rgba(5, 20, 40, 0.8), rgba(5, 20, 40, 0.9)), url('images/bg_server.png'); background-size: cover; background-position: center; }
        #quiz-code-display span { margin: 0 5px; }
        .quiz-option-btn { width: 100%; text-align: left; }
    </style>
</head>
<body>

<!-- AUDIO TRACKS -->
<audio id="bgm-player" loop><source src="audio/bgm.mp3" type="audio/mp3"></audio>
<audio id="bgm-shooter" loop><source src="audio/bgm_shooter.mp3" type="audio/mp3"></audio> <!-- Shooter BGM -->
<audio id="bgm-bomber" loop><source src="audio/bgm_bomber.mp3" type="audio/mp3"></audio> <!-- Bomberman BGM -->
<audio id="sfx-click"><source src="audio/click.mp3" type="audio/mp3"></audio>
<audio id="sfx-correct"><source src="audio/correct.mp3" type="audio/mp3"></audio>
<audio id="sfx-wrong"><source src="audio/wrong.mp3" type="audio/mp3"></audio>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="btn-music-toggle" id="btn-music" onclick="app.toggleMusic()" title="Toggle Music">â™ª</div>
    
    <!-- Lightning Effect Overlay -->
    <div id="lightning-overlay"></div>

    <div id="hud">
        <div class="hud-top-left">
            <div style="display:flex; gap:10px;">
                <div class="hud-panel"><span>SCORE</span><span class="hud-val" id="hud-score" style="color:var(--accent-gold)">0</span></div>
                <div class="hud-panel" style="border-color: var(--danger-red)"><span>TIME</span><span class="hud-val" id="hud-timer" style="color:var(--danger-red)">--</span></div>
            </div>
            <div id="mission-overlay">MISI: <span id="current-mission-text"></span></div>
        </div>
        <div class="hud-panel" style="min-width: 160px; align-items: flex-start;">
            <span style="color:var(--tech-cyan)">TOYA PURITY</span>
            <div class="purity-container"><div class="purity-fill" id="hud-purity" style="background-color: var(--danger-red);"></div></div>
        </div>
    </div>

    <!-- RPG Controls -->
    <div id="rpg-controls">
        <div class="rpg-btn" id="btn-skill" onclick="app.currentChapter.skill()">SKILL</div>
        <div class="rpg-btn" id="btn-atk" onclick="app.currentChapter.attack()">ATK</div>
    </div>

    <!-- CUSTOM MESSAGE BOX -->
    <div id="custom-message-box">
        <img id="msg-icon" src="images/npc_rex.png" alt="Rex">
        <h3 id="msg-title">NOTIFIKASI</h3>
        <p id="msg-body">Pesan akan muncul di sini.</p>
        <button class="btn-msg-ok" onclick="document.getElementById('custom-message-box').style.display='none'">OK</button>
    </div>

    <!-- SCREENS -->
    <div id="screen-splash" class="ui-screen active">
        <div style="width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center;">
            <div id="loading-pct-large">0%</div>
            <div id="terminal-output"></div>
            <div class="loading-bar-container"><div class="loading-bar-fill" id="loading-fill"></div></div>
            <div style="text-align: right; margin-top: 5px; font-size: 1.2rem; color: #00A8FF; width: 100%;">INITIALIZING...</div>
        </div>
    </div>

    <div id="screen-loading" class="ui-screen">
        <div class="spinner"></div>
        <h2>SINKRONISASI JARINGAN...</h2>
        <p style="color:#aaa; font-family:'Rajdhani'">Menghubungkan ke Telaga Dunia</p>
    </div>

    <div id="screen-title" class="ui-screen">
        <div id="logo-container">
            <img id="logo-img" src="images/logo_main.png" alt="TOYA GUARDIANS" onerror="this.style.display='none'">
            <img id="subtitle-img" src="images/subtitle.png" alt="TIRTATELAGA DEFENSE" onerror="this.style.display='none'">
        </div>
        <div class="panel" style="background:transparent; border:none; box-shadow:none; margin-top:10px;">
            <button class="btn-ml btn-anim" onclick="app.goToRegister()">MULAI MISI</button>
            <button class="btn-ml btn-anim" style="background: #002244; border-color:#004488;" onclick="app.showLeaderboard()">HALL OF GUARDIANS</button>
        </div>
        <p style="position:absolute; bottom:10px; color:var(--tech-cyan); font-size:0.8rem; text-shadow:0 0 5px black;">Ver. 17.2 (Game Balance & Visual Patch)</p>
    </div>

    <div id="screen-register" class="ui-screen">
        <div class="reg-illustration"><img src="images/hero_male.png" alt="Guardian"></div>
        <div class="panel">
            <div class="close-btn" onclick="app.switchScreen('screen-title')">X</div>
            <h2 style="color:var(--primary-blue); text-align:center; margin-top:0;">DATA GUARDIAN</h2>
            <div class="form-group"><label>CODENAME</label><input type="text" id="reg-name" placeholder="Ex: CyberOne" maxlength="12"></div>
            <div class="form-group"><label>PROVINSI</label><select id="reg-prov" onchange="app.populateCities()"><option value="">Pilih Provinsi...</option></select></div>
            <div class="form-group"><label>KOTA / KAB</label><select id="reg-city" disabled onchange="app.populateDistricts()"><option>-</option></select></div>
            <div class="form-group"><label>KECAMATAN</label><select id="reg-district" disabled><option>-</option></select></div>
            <div class="form-group"><label>SEKOLAH</label><input type="text" id="reg-school" placeholder="Nama Sekolah..." oninput="this.value = this.value.toUpperCase()"></div>
            <button class="btn-ml" onclick="app.submitRegistration()">LANJUT</button>
        </div>
    </div>

    <div id="screen-char" class="ui-screen">
        <div class="panel" style="max-width: 600px;">
            <h2 style="text-align:center; color:var(--tech-cyan);">PILIH AVATAR</h2>
            <div class="char-grid">
                <div class="char-card selected" id="char-1" onclick="app.selectChar(1)">
                    <img src="images/hero_male.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">TECH BOY</div>
                </div>
                <div class="char-card" id="char-2" onclick="app.selectChar(2)">
                    <img src="images/hero_female_hijab.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">HIJAB HERO</div>
                </div>
                <div class="char-card" id="char-3" onclick="app.selectChar(3)">
                    <img src="images/hero_female.png"><div style="font-size:0.8rem; margin-top:8px; font-weight:bold;">CYBER GIRL</div>
                </div>
            </div>
            <button class="btn-ml" onclick="app.startStory()">DEPLOY</button>
        </div>
    </div>

    <div id="screen-story" class="ui-screen" onclick="story.next()">
        <div id="story-bg"></div>
        <div class="dialogue-box">
            <div class="char-portrait"><img id="story-portrait" src="images/npc_rex.png"></div>
            <div class="dialogue-text"><h3 id="story-speaker">NAME</h3><p id="story-text">...</p></div>
            <div class="next-arrow">â–¼</div>
        </div>
    </div>

    <div id="screen-leaderboard" class="ui-screen">
        <div class="panel" style="height: 500px; display:flex; flex-direction:column; max-width:600px; width:95%;">
            <h2 style="color:var(--accent-gold); text-align:center; margin-bottom:10px;">HALL OF GUARDIANS</h2>
            
            <div class="lb-controls">
                <select id="lb-filter" class="lb-select" onchange="app.renderLeaderboard()">
                    <option value="all">Lingkup: NASIONAL</option>
                    <option value="school">Lingkup: SEKOLAH SAYA</option>
                    <option value="district">Lingkup: KECAMATAN SAYA</option>
                    <option value="city">Lingkup: KOTA SAYA</option>
                </select>
            </div>

            <div style="overflow-y:auto; flex:1; border:1px solid #334; padding:5px;">
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th style="width:30px">#</th>
                            <th>GUARDIAN</th>
                            <th>SEKOLAH</th>
                            <th>LOKASI</th>
                            <th>SKOR</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
            <button class="btn-ml btn-anim" style="background:#002244; margin-top:10px;" onclick="app.switchScreen('screen-title')">KEMBALI</button>
        </div>
    </div>

    <!-- Chapter Title Screen 1 -->
    <div id="screen-title-ch1" class="ui-screen">
        <h1 style="color:var(--primary-blue); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(0, 168, 255, 0.5);">CHAPTER 1</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">DASAR KEAMANAN JARINGAN</h2>
        <p style="color:#aaa;">Persiapan Infiltrasi Server Utama</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter1Story()">LANJUT</button>
    </div>

    <!-- Chapter Title Screen 2 -->
    <div id="screen-title-ch2" class="ui-screen">
        <h1 style="color:var(--danger-red); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(255, 68, 68, 0.5);">CHAPTER 2</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">PERTAHANAN FIREWALL</h2>
        <p style="color:#aaa;">Menghalau Serangan Genderuwo</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter2Intro()">LANJUT</button>
    </div>

    <!-- Chapter Title Screen 3 -->
    <div id="screen-title-ch3" class="ui-screen">
        <h1 style="color:var(--accent-gold); font-family:'Orbitron'; font-size:3rem; text-shadow:0 0 10px rgba(255, 215, 0, 0.5);">CHAPTER 3</h1>
        <h2 style="color:var(--tech-cyan); font-size:1.5rem; text-shadow:0 0 5px rgba(0, 217, 255, 0.5);">INVESTIGASI SERANGAN</h2>
        <p style="color:#aaa;">Melacak Posisi Boss & Forensik Digital</p>
        <button class="btn-ml" style="width:200px" onclick="app.startChapter3Intro()">LANJUT</button>
    </div>

    <!-- Quiz Screen -->
    <div id="screen-quiz" class="ui-screen">
        <div class="panel" style="max-width: 600px; padding: 20px;">
            <h2 id="quiz-title-text" style="color:var(--accent-gold); text-align:center; margin-top:0; font-family:'Orbitron'">KODE AKSES PINTU </h2>
            <div id="quiz-code-display" style="font-family:'VT323', monospace; font-size:2.5rem; letter-spacing:15px; color:var(--success-green); text-align:center; background:rgba(0,0,0,0.5); padding:10px; margin-bottom:20px; border:1px dashed #334;">
                <span id="digit-0">-</span><span id="digit-1">-</span><span id="digit-2">-</span><span id="digit-3">-</span><span id="digit-4">-</span>
            </div>
            
            <p style="color:var(--tech-cyan); font-weight:bold;">PHASE <span id="quiz-phase-num">1</span> / 5</p>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:5px; margin-bottom:15px;">
                <p id="quiz-question-text" style="font-size:1.1rem; color:white; margin:0;">Pertanyaan akan muncul di sini.</p>
            </div>
            
            <div id="quiz-options-container" class="flex flex-col gap-2">
                <!-- Answer options will be injected here -->
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <button class="btn-ml" id="btn-hint" style="width:150px; padding:8px; font-size:1rem; background:linear-gradient(180deg, #FFD700 0%, #B8860B 100%); border-color:#FFC400;" onclick="app.currentChapter.getHint()">BANTUAN (REX)</button>
                <span id="quiz-feedback" style="font-weight:bold; font-family:'Orbitron'"></span>
            </div>
        </div>
    </div>


    <div id="screen-ending" class="ui-screen">
        <h1 style="color:var(--success-green); font-family:'Orbitron';">MISI SELESAI</h1>
        <div style="font-size:5rem; color:var(--accent-gold); font-family:'Orbitron'; font-weight:900;" id="end-rank">S</div>
        <p>Total Skor: <span id="end-score" style="color:white; font-weight:bold">0</span></p>
        <p id="end-msg" style="color:#aaa">Energi Toya Berhasil Dimurnikan!</p>
        <button class="btn-ml" style="width:200px" onclick="location.reload()">RE-DEPLOY</button>
    </div>
</div>

<script>
/**
 * TOYA GUARDIANS v17.2: Visual Upgrades & Gameplay Fixes
 */

const ASSETS = {
    hero1_idle: 'images/hero_male.png', hero1_idle1: 'images/hero1_walk1.png',hero1_walk1: 'images/hero1_walk1.png', hero1_walk2: 'images/hero1_walk2.png', hero1_walk3: 'images/hero1_walk3.png', hero1_walk4: 'images/hero1_walk4.png',
    hero2_idle: 'images/hero_female_hijab.png', hero2_idle1: 'images/hero2_walk1.png',hero2_walk1: 'images/hero2_walk1.png', hero2_walk2: 'images/hero2_walk2.png', hero2_walk3: 'images/hero2_walk3.png', hero2_walk4: 'images/hero2_walk4.png',
    hero3_idle: 'images/hero_female.png',hero3_idle1: 'images/hero3_walk1.png', hero3_walk1: 'images/hero3_walk1.png', hero3_walk2: 'images/hero3_walk2.png', hero3_walk3: 'images/hero3_walk3.png', hero3_walk4: 'images/hero3_walk4.png',
    hero1_tembak: 'images/hero1_tembak.png', hero2_tembak: 'images/hero2_tembak.png', hero3_tembak: 'images/hero3_tembak.png',
	
	rex: 'images/npc_rex.png', virus: 'images/enemy_virus.png', narrator: 'images/narrator.png',
    
	bg_title: 'images/bg_title.png', bg_server: 'images/bg_server.png', bg_firewall: 'images/bg_firewall.png', bg_noc: 'images/bg_noc.png',bg_open1: 'images/bg_open1.png',bg_open2: 'images/bg_open2.png',
	bg_open3: 'images/bg_open3.png',bg_open4: 'images/bg_open4.png',bg_open5: 'images/bg_open5.png',
	bg_tutorend: 'images/bg_tutorend.png',bg_victory: 'images/bg_victory.png',bg_rtraining: 'images/bg_rtraining.png',bg_rtraining1: 'images/bg_rtraining1.png',bg_jaringan: 'images/bg_jaringan.png',
    bg_kabel: 'images/bg_kabel.png', bg_bomber: 'images/bg_server.png', // Fallback for bomber BG
	item_pc: 'images/item_pc.png', item_server: 'images/item_server.png', item_tablet: 'images/item_tablet.png', item_laptop: 'images/item_laptop.png',
    item_switch: 'images/item_switch.png', item_firewall: 'images/item_firewall.png', item_keylogger: 'images/item_keylogger.png',
    icon_http: 'images/icon_http.png', icon_ssh: 'images/icon_ssh.png', icon_email: 'images/icon_email.png',
    icon_sql: 'images/icon_sql.png', icon_ping: 'images/icon_ping.png', icon_telnet: 'images/icon_telnet.png', icon_exe: 'images/icon_exe.png',
    subtitle: 'images/subtitle.png',
    zone_allow: 'images/zone_allow.png',
    zone_block: 'images/zone_block.png'
};

const DATA_INDONESIA = {
    "DKI Jakarta": {
        "Jakarta Pusat": ["Gambir", "Tanah Abang", "Menteng", "Senen", "Cempaka Putih"],
        "Jakarta Selatan": ["Kebayoran Baru", "Kebayoran Lama", "Cilandak", "Pasar Minggu", "Tebet"]
    },
    "Jawa Barat": {
        "Bandung": ["Cicendo", "Coblong", "Andir", "Buahbatu", "Kiaracondong"],
        "Bekasi": ["Bekasi Barat", "Bekasi Timur", "Bekasi Selatan", "Jatiasih"],
        "Bogor": ["Bogor Tengah", "Bogor Barat", "Bogor Selatan"]
    },
    "Jawa Tengah": {
        "Semarang": ["Semarang Tengah", "Semarang Barat", "Candisari"],
        "Surakarta": ["Banjarsari", "Jebres", "Laweyan", "Pasar Kliwon", "Serengan"]
    },
    "Jawa Timur": {
        "Surabaya": ["Gubeng", "Tegalsari", "Genteng", "Wonokromo"],
        "Malang": ["Klojen", "Blimbing", "Kedungkandang", "Lowokwaru", "Sukun"],
		"Lamongan": ["Brondong", "Tlogoretno", "Sedayulawas", "Brengkok", "Labuhan"]
    },
    "Bali": {
        "Denpasar": ["Denpasar Barat", "Denpasar Timur", "Denpasar Selatan", "Denpasar Utara"],
        "Badung": ["Kuta", "Kuta Selatan", "Kuta Utara", "Mengwi"]
    },
    "Sumatera Utara": {
        "Medan": ["Medan Kota", "Medan Baru", "Medan Sunggal", "Medan Johor"],
        "Deli Serdang": ["Percut Sei Tuan", "Tanjung Morawa"]
    }
};

const BANK_SOAL_CH1 = [
    { q: "Apa nama serangan yang membanjiri server dengan lalu lintas palsu agar layanan lumpuh?", options: [{text:"DDoS",correct:true},{text:"Phishing",correct:false},{text:"Trojan",correct:false},{text:"Worm",correct:false}], hint:"Distributed Denial of Service." },
    { q: "Tiga pilar utama keamanan informasi dikenal dengan singkatan CIA. Apa kepanjangannya?", options: [{text:"Confidentiality, Integrity, Availability",correct:true},{text:"Control, Intelligence, Access",correct:false},{text:"Cyber, Internet, Authority",correct:false},{text:"Code, Input, Algorithm",correct:false}], hint:"Kerahasiaan, Integritas, Ketersediaan." },
    { q: "Jenis malware yang menyamar sebagai program berguna namun berisi kode berbahaya disebut...", options: [{text:"Trojan Horse",correct:true},{text:"Worm",correct:false},{text:"Spyware",correct:false},{text:"Adware",correct:false}], hint:"Seperti kuda kayu Yunani kuno." },
    { q: "Serangan di mana peretas menempatkan diri di antara dua pihak yang berkomunikasi disebut...", options: [{text:"Man-in-the-Middle (MITM)",correct:true},{text:"Brute Force",correct:false},{text:"SQL Injection",correct:false},{text:"Ransomware",correct:false}], hint:"Orang di tengah-tengah." },
    { q: "Teknik memalsukan identitas pengirim (seperti IP address) untuk menipu penerima disebut...", options: [{text:"Spoofing",correct:true},{text:"Sniffing",correct:false},{text:"Hacking",correct:false},{text:"Phishing",correct:false}], hint:"Mirip kata 'Spoof' (parodi/palsu)." },
    { q: "Apa dampak utama jika aspek 'Availability' dalam CIA Triad dilanggar?", options: [{text:"Layanan tidak bisa diakses user",correct:true},{text:"Data dicuri",correct:false},{text:"Data dimodifikasi",correct:false},{text:"Password terenkripsi",correct:false}], hint:"Server down." },
    { q: "Topologi jaringan mana yang jika kabel utamanya putus, seluruh jaringan akan mati?", options: [{text:"Bus",correct:true},{text:"Star",correct:false},{text:"Mesh",correct:false},{text:"Ring",correct:false}], hint:"Bentuknya lurus seperti bis." },
    { q: "Apa itu 'Sniffing' dalam konteks jaringan?", options: [{text:"Penyadapan lalu lintas data",correct:true},{text:"Pemblokiran akses",correct:false},{text:"Pengiriman virus",correct:false},{text:"Pencurian hardware",correct:false}], hint:"Mengendus paket data." },
    { q: "Malware yang dapat menggandakan diri dan menyebar tanpa bantuan file inang disebut...", options: [{text:"Worm",correct:true},{text:"Virus",correct:false},{text:"Trojan",correct:false},{text:"Rootkit",correct:false}], hint:"Cacing komputer." },
    { q: "Apa fungsi utama dari enkripsi data?", options: [{text:"Menjaga kerahasiaan (Confidentiality)",correct:true},{text:"Mempercepat internet",correct:false},{text:"Menghemat penyimpanan",correct:false},{text:"Menghapus virus",correct:false}], hint:"Mengubah teks jadi kode acak." },
    { q: "Serangan yang mencoba menebak password dengan mencoba semua kombinasi disebut...", options: [{text:"Brute Force",correct:true},{text:"Social Engineering",correct:false},{text:"Phishing",correct:false},{text:"Malware",correct:false}], hint:"Paksa secara kasar." },
    { q: "Kelemahan utama topologi Star adalah...", options: [{text:"Bergantung pada Switch/Hub pusat",correct:true},{text:"Kabel boros",correct:false},{text:"Sulit dikonfigurasi",correct:false},{text:"Jika satu PC mati, semua mati",correct:false}], hint:"Jika pusat mati, semua mati." },
    { q: "Apa tujuan utama serangan Ransomware?", options: [{text:"Meminta tebusan uang",correct:true},{text:"Mencuri password FB",correct:false},{text:"Memperlambat PC",correct:false},{text:"Menampilkan iklan",correct:false}], hint:"Ransom artinya tebusan." },
    { q: "Protokol HTTPs menggunakan port nomor...", options: [{text:"443",correct:true},{text:"80",correct:false},{text:"21",correct:false},{text:"22",correct:false}], hint:"Lebih tinggi dari port HTTP standar." },
    { q: "Siapa pihak yang paling bertanggung jawab menjaga password akun?", options: [{text:"Pengguna (User)",correct:true},{text:"Admin Jaringan",correct:false},{text:"Penyedia Internet",correct:false},{text:"Pemerintah",correct:false}], hint:"Pemilik akun itu sendiri." }
];

const BANK_SOAL_CH2 = [
    { q: "Apa perbedaan mendasar antara Firewall dan IDS (Intrusion Detection System)?", options: [{text:"Firewall memblokir akses, IDS mendeteksi serangan",correct:true},{text:"Firewall hanya mencatat log, IDS memblokir virus",correct:false},{text:"Keduanya sama saja",correct:false},{text:"IDS hanya untuk WiFi",correct:false}], hint:"Satu bertindak sebagai gerbang (memblokir), satu sebagai alarm (mendeteksi)." },
    { q: "Teknologi apa yang memungkinkan akses aman ke jaringan privat melalui jaringan publik (internet)?", options: [{text:"VPN (Virtual Private Network)",correct:true},{text:"VLAN",correct:false},{text:"WAN",correct:false},{text:"LAN",correct:false}], hint:"Jaringan 'Pribadi Virtual'." },
    { q: "Dalam konfigurasi firewall, aturan apa yang paling aman diterapkan sebagai standar?", options: [{text:"Default Deny (Blokir semua kecuali yang diizinkan)",correct:true},{text:"Default Allow (Izinkan semua)",correct:false},{text:"Block Port 80",correct:false},{text:"Allow All Traffic",correct:false}], hint:"Tolak semua secara default." },
    { q: "Apa fungsi dari ACL (Access Control List) pada router atau firewall?", options: [{text:"Mengontrol lalu lintas berdasarkan aturan (IP/Port)",correct:true},{text:"Mempercepat koneksi internet",correct:false},{text:"Menyimpan password pengguna",correct:false},{text:"Mendeteksi kerusakan kabel",correct:false}], hint:"Daftar untuk mengontrol akses." },
    { q: "Tindakan 'Hardening' pada perangkat jaringan meliputi...", options: [{text:"Menutup port yang tidak perlu & update firmware",correct:true},{text:"Menambah RAM perangkat",correct:false},{text:"Membersihkan debu perangkat",correct:false},{text:"Memasang kipas tambahan",correct:false}], hint:"Memperkuat sistem dari sisi software/konfigurasi." },
    { q: "Port mana yang sebaiknya DIBLOKIR untuk mencegah akses remote yang tidak aman (pengganti SSH)?", options: [{text:"Port 23 (Telnet)",correct:true},{text:"Port 22 (SSH)",correct:false},{text:"Port 80 (HTTP)",correct:false},{text:"Port 443 (HTTPS)",correct:false}], hint:"Protokol jadul teks polos." },
    { q: "IPS (Intrusion Prevention System) berbeda dengan IDS karena IPS dapat...", options: [{text:"Secara otomatis memblokir serangan yang terdeteksi",correct:true},{text:"Hanya mencatat log serangan",correct:false},{text:"Bekerja offline",correct:false},{text:"Memperbaiki hardware",correct:false}], hint:"Prevention berarti Pencegahan aktif." },
    { q: "Konfigurasi 'Allow Port 443' pada firewall bertujuan untuk...", options: [{text:"Mengizinkan akses web aman (HTTPS)",correct:true},{text:"Mengizinkan akses web biasa (HTTP)",correct:false},{text:"Mengizinkan email",correct:false},{text:"Mengizinkan game",correct:false}], hint:"Port standar untuk web secure." },
    { q: "Apa tujuan utama dari Kebijakan Keamanan (Security Policy)?", options: [{text:"Memberikan panduan & aturan tertulis tentang keamanan",correct:true},{text:"Hanya formalitas dokumen",correct:false},{text:"Membuat pekerjaan lambat",correct:false},{text:"Menghukum karyawan",correct:false}], hint:"Dasar aturan organisasi." },
    { q: "Stateful Inspection pada firewall berarti...", options: [{text:"Memantau status koneksi dari awal hingga akhir",correct:true},{text:"Hanya memeriksa header paket statis",correct:false},{text:"Memeriksa virus dalam file",correct:false},{text:"Memeriksa keaslian hardware",correct:false}], hint:"Mengingat 'State' atau status koneksi." },
    { q: "Mengubah password default admin router adalah contoh langkah...", options: [{text:"Device Hardening",correct:true},{text:"Network Mapping",correct:false},{text:"Penetration Testing",correct:false},{text:"Social Engineering",correct:false}], hint:"Penguatan perangkat." },
    { q: "Packet Filtering Firewall bekerja pada layer OSI...", options: [{text:"Network (Layer 3) & Transport (Layer 4)",correct:true},{text:"Application (Layer 7)",correct:false},{text:"Physical (Layer 1)",correct:false},{text:"Data Link (Layer 2)",correct:false}], hint:"Mengecek IP dan Port." },
    { q: "Apa itu DMZ (Demilitarized Zone) dalam arsitektur firewall?", options: [{text:"Area jaringan semi-publik untuk server yang diakses publik",correct:true},{text:"Area paling aman dan rahasia",correct:false},{text:"Area untuk database internal",correct:false},{text:"Jaringan khusus admin",correct:false}], hint:"Zona netral." },
    { q: "Next-Generation Firewall (NGFW) memiliki kelebihan dibanding firewall tradisional, yaitu...", options: [{text:"Deep Packet Inspection & Application Awareness",correct:true},{text:"Hanya filter port",correct:false},{text:"Harga lebih murah",correct:false},{text:"Tidak perlu konfigurasi",correct:false}], hint:"Inspeksi lebih dalam." },
    { q: "Jika sebuah firewall dikonfigurasi 'Block All Inbound', apa efeknya?", options: [{text:"Tidak ada koneksi dari luar yang bisa masuk",correct:true},{text:"Tidak bisa browsing internet",correct:false},{text:"Semua koneksi lancar",correct:false},{text:"Komputer akan mati",correct:false}], hint:"Semua yang masuk diblokir." }
];

const BANK_SOAL_CH3 = [
    { q: "Aplikasi apa yang paling umum digunakan untuk menganalisis paket data jaringan (Packet Sniffer)?", options: [{text:"Wireshark",correct:true},{text:"Photoshop",correct:false},{text:"Notepad++",correct:false},{text:"WinRAR",correct:false}], hint:"Ikonnya sirip hiu." },
    { q: "Di dalam Wireshark, warna merah pada baris paket biasanya menandakan...", options: [{text:"Paket Error / Reset (RST)",correct:true},{text:"Paket Aman",correct:false},{text:"Paket Gambar",correct:false},{text:"Paket Email",correct:false}], hint:"Warna bahaya." },
    { q: "Langkah pertama dalam Incident Response menurut standar NIST adalah...", options: [{text:"Preparation (Persiapan)",correct:true},{text:"Detection",correct:false},{text:"Eradication",correct:false},{text:"Recovery",correct:false}], hint:"Sedia payung sebelum hujan." },
    { q: "Apa itu 'Log File' dalam server?", options: [{text:"Catatan aktivitas sistem dan user",correct:true},{text:"Batang kayu",correct:false},{text:"File sampah",correct:false},{text:"Program antivirus",correct:false}], hint:"Jejak digital." },
    { q: "Jika ditemukan login sukses di jam 3 pagi dari IP asing, ini indikasi...", options: [{text:"Compromised Account (Akun jebol)",correct:true},{text:"Server update",correct:false},{text:"Admin lembur",correct:false},{text:"Listrik padam",correct:false}], hint:"Aktivitas anomali." },
    { q: "Tindakan 'Containment' (Isolasi) bertujuan untuk...", options: [{text:"Mencegah penyebaran serangan",correct:true},{text:"Menghapus virus",correct:false},{text:"Menginstall ulang OS",correct:false},{text:"Menuntut hacker",correct:false}], hint:"Mengurung agar tidak menyebar." },
    { q: "Bukti digital harus dijaga integritasnya menggunakan...", options: [{text:"Hashing (MD5/SHA)",correct:true},{text:"Copy Paste",correct:false},{text:"Screenshot",correct:false},{text:"Zip file",correct:false}], hint:"Sidik jari file." },
    { q: "Serangan yang mengubah tampilan halaman depan website disebut...", options: [{text:"Web Defacement",correct:true},{text:"Web Crawling",correct:false},{text:"Web Hosting",correct:false},{text:"Web Design",correct:false}], hint:"Merusak wajah web." },
    { q: "Apa fungsi dari SIEM (Security Information and Event Management)?", options: [{text:"Pusat analisa log keamanan terpusat",correct:true},{text:"Game server",correct:false},{text:"Aplikasi chat",correct:false},{text:"Pemutar video",correct:false}], hint:"Manajemen Event Keamanan." },
    { q: "Setelah insiden selesai, tahap 'Lessons Learned' penting untuk...", options: [{text:"Mencegah kejadian berulang",correct:true},{text:"Menghukum staf IT",correct:false},{text:"Melupakan masalah",correct:false},{text:"Menjual data",correct:false}], hint:"Belajar dari pengalaman." },
    { q: "Port Scanning biasanya merupakan tahap awal dari serangan, yang disebut...", options: [{text:"Reconnaissance (Pengintaian)",correct:true},{text:"Exploitation",correct:false},{text:"Actions on Objectives",correct:false},{text:"Delivery",correct:false}], hint:"Mata-mata." },
    { q: "Serangan Brute Force SSH akan terlihat di log sebagai...", options: [{text:"Banyak 'Failed Login' dalam waktu singkat",correct:true},{text:"Koneksi lambat",correct:false},{text:"Layar biru",correct:false},{text:"Download file besar",correct:false}], hint:"Gagal berkali-kali." },
    { q: "Keylogger adalah malware yang berfungsi untuk...", options: [{text:"Merekam ketikan keyboard korban",correct:true},{text:"Membuka kunci pintu",correct:false},{text:"Memutar musik",correct:false},{text:"Mengunci folder",correct:false}], hint:"Log tombol (Key)." },
    { q: "Forensik Digital harus dilakukan pada...", options: [{text:"Image/Copy dari harddisk asli",correct:true},{text:"Harddisk asli yang sedang menyala",correct:false},{text:"Monitor komputer",correct:false},{text:"Keyboard",correct:false}], hint:"Jangan sentuh barang bukti asli." },
    { q: "Protocol Analyzer membantu admin jaringan untuk...", options: [{text:"Mendiagnosa masalah jaringan",correct:true},{text:"Memperbaiki hardware",correct:false},{text:"Membuat website",correct:false},{text:"Menulis kode program",correct:false}], hint:"Menganalisa protokol." }
];

const AudioMgr = {
    isMuted: false,
    currentTrack: 'bgm-player',
    playMusic: function(trackId) {
        if (this.isMuted) return;
        this.stopAll();
        this.currentTrack = trackId;
        const t = document.getElementById(trackId);
        if(t) { t.volume = 0.5; t.currentTime = 0; t.play().catch(()=>{}); }
    },
    stopAll: function() {
        ['bgm-player', 'bgm-shooter', 'bgm-bomber'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.pause();
        });
    },
    playSFX: function(id) { if(!this.isMuted) { const s=document.getElementById(id); if(s){s.currentTime=0; s.play().catch(()=>{});} } },
    toggle: function() { 
        this.isMuted = !this.isMuted; 
        const btn = document.querySelector('.btn-music-toggle'); 
        if(this.isMuted) { this.stopAll(); btn.style.opacity="0.5"; btn.innerHTML='ðŸ”‡'; } 
        else { this.playMusic(this.currentTrack); btn.style.opacity="1"; btn.innerHTML='â™ª'; } 
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const AppState = { SPLASH: -1, TITLE: 0, STORY: 1, TUTORIAL: 1.5, GAME_CH1: 2, BRIDGE_CH1: 2.5, GAME_CH2: 3, GAME_CH2_CONFIG: 3.2, GAME_CH2_QUIZ: 3.5, BRIDGE_CH2: 3.8, GAME_CH3: 4, GAME_CH3_BOMBER: 4.2, GAME_CH3_QUIZ: 4.5, GAME_CH3_IR: 4.8, BOSS_BATTLE: 4.9, ENDING: 5 };

function showMessage(title, body) {
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-body').innerText = body;
    document.getElementById('msg-icon').style.display = 'none'; 
    document.getElementById('custom-message-box').style.display = 'flex';
    AudioMgr.playSFX('sfx-click');
}

function showRexMessage(title, body) {
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-body').innerText = body;
    const rexIcon = document.getElementById('msg-icon');
    rexIcon.style.display = 'block'; 
    rexIcon.src = ASSETS.rex; 
    document.getElementById('custom-message-box').style.display = 'flex';
    AudioMgr.playSFX('sfx-click');
}

function spawnFloatingScore(text) {
    const el = document.createElement('div');
    el.className = 'float-score';
    el.innerText = text;
    const x = 400 + (Math.random() * 100 - 50);
    const y = 300 + (Math.random() * 50 - 25);
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    document.getElementById('game-container').appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Helper: Lightning Effect
function triggerLightning() {
    const overlay = document.getElementById('lightning-overlay');
    overlay.style.opacity = '0.8';
    overlay.style.transition = 'none';
    setTimeout(() => {
        overlay.style.transition = 'opacity 0.5s ease-out';
        overlay.style.opacity = '0';
    }, 50);
    // Draw canvas bolt logic
    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    ctx.beginPath();
    let lx = Math.random() * 800;
    let ly = 0;
    ctx.moveTo(lx, ly);
    while(ly < 600) {
        lx += (Math.random() - 0.5) * 50;
        ly += Math.random() * 50;
        ctx.lineTo(lx, ly);
    }
    ctx.stroke();
    AudioMgr.playSFX('sfx-click'); // Use click sound or placeholder for thunder
}

class GameApp {
    constructor() {
        this.player = { name: "", charId: 1, score: 0, toyaPurity: 20, school: "", prov: "", city: "", district: "" }; 
        this.state = AppState.SPLASH;
        this.currentChapter = null; this.lastTime = 0;
        this.imgs = {};
        let loadedCount = 0;
        const totalAssets = Object.keys(ASSETS).length;

        for (const [k, v] of Object.entries(ASSETS)) { 
            this.imgs[k] = new Image(); 
            this.imgs[k].src = v; 
            this.imgs[k].onload = () => {
                loadedCount++;
                const progress = Math.floor((loadedCount / totalAssets) * 100);
                const pct = document.getElementById('loading-pct-large');
                const fill = document.getElementById('loading-fill');
                if(pct) pct.innerText = progress + "%";
                if(fill) fill.style.width = progress + "%";
                if (loadedCount === totalAssets) this.runSplashTextAnimation();
            };
            this.imgs[k].onerror = () => { 
                if(k.includes('_w')) { let id = k.split('_')[0]+'_idle'; if(this.imgs[id]) this.imgs[k].src = this.imgs[id].src; } else if(k==='narrator') this.imgs[k].src = this.imgs['rex']?this.imgs['rex'].src:''; 
                loadedCount++;
                if (loadedCount === totalAssets) this.runSplashTextAnimation();
            };
        }
        this.initUI();
        this.loop = this.loop.bind(this);
    }
    
    addScore(amount) {
        if(isNaN(amount)) { console.warn("Invalid score amount"); return; }
        this.player.score += amount;
        const hudScore = document.getElementById('hud-score');
        if(hudScore) hudScore.innerText = Math.floor(this.player.score);
        spawnFloatingScore(amount >= 0 ? `+${amount}` : `${amount}`);
    }

    getHeroFrames(charId) { const p = 'hero' + charId; return [ this.imgs[p+'_walk1'], this.imgs[p+'_walk2'], this.imgs[p+'_walk3'], this.imgs[p+'_walk4'] ]; }
    getHeroIdle(charId) { return this.imgs['hero'+charId+'_idle1']; }
    
    updatePurityDisplay(newPurity) {
        this.player.toyaPurity = Math.min(100, Math.max(0, newPurity));
        const purityEl = document.getElementById('hud-purity');
        if (purityEl) {
            purityEl.style.width = this.player.toyaPurity + "%";
            const r = Math.floor(255 * (1 - this.player.toyaPurity / 100));
            const g = Math.floor(255 * (this.player.toyaPurity / 100) * 0.7); 
            const b = Math.floor(255 * (this.player.toyaPurity / 100));
            purityEl.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        }
    }

    triggerGameOver() {
        this.active = false;
        if(this.currentChapter && this.currentChapter.cleanup) this.currentChapter.cleanup();
        this.state = AppState.ENDING;
        this.switchScreen('screen-ending');
        
        // Custom UI for Game Over
        document.querySelector('#screen-ending h1').innerText = "GAME OVER";
        document.querySelector('#screen-ending h1').style.color = "var(--danger-red)";
        document.getElementById('end-rank').innerText = "F";
        document.getElementById('end-rank').style.color = "var(--danger-red)";
        document.getElementById('end-msg').innerText = "Sistem Keamanan Telah Dikuasai Malware!";
        document.getElementById('end-score').innerText = Math.floor(this.player.score);
        
        const btn = document.querySelector('#screen-ending button');
        btn.innerText = "KEMBALI KE MENU";
        btn.onclick = () => location.reload();
        
        AudioMgr.stopAll();
        AudioMgr.playSFX('sfx-wrong');
    }

    runSplashTextAnimation() {
        requestAnimationFrame(this.loop); 
        const texts = ["MENGHUBUNGKAN KE TELAGA DUNIA...", "MEMINDAI INTEGRITAS DATA...", "MENYIAPKAN PETA DIGITAL...", "PROTOKOL TOYA GUARDIAN AKTIF...", "SISTEM SIAP."];
        let i = 0;
        const out = document.getElementById('terminal-output');
        const totalSteps = texts.length;
        const pct = document.getElementById('loading-pct-large');
        const fill = document.getElementById('loading-fill');
        
        const timer = setInterval(() => {
            if(i < totalSteps) { 
                let d = document.createElement('div'); d.className='terminal-text'; d.innerText="> "+texts[i]; out.appendChild(d); i++; 
                const textProgress = Math.floor((i / totalSteps) * 99);
                if(pct) pct.innerText = textProgress + "%";
                if(fill) fill.style.width = textProgress + "%";
            } else {
                clearInterval(timer);
                if(pct) pct.innerText = "100%";
                if(fill) fill.style.width = "100%";
                setTimeout(() => { this.switchScreen('screen-title'); this.state=AppState.TITLE; this.updatePurityDisplay(this.player.toyaPurity); }, 1000);
            }
        }, 600);
    }

    initUI() {
        const s = document.getElementById('reg-prov');
        Object.keys(DATA_INDONESIA).forEach(p => { let o=document.createElement('option'); o.innerText=p; s.appendChild(o); });
    }
    populateCities() {
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city'); 
        const d = document.getElementById('reg-district');
        c.innerHTML='<option value="-">Pilih Kota/Kab...</option>'; 
        d.innerHTML='<option value="-">-</option>'; d.disabled=true;
        c.disabled=!p;
        if(DATA_INDONESIA[p]) Object.keys(DATA_INDONESIA[p]).forEach(city => { let o=document.createElement('option'); o.innerText=city; c.appendChild(o); });
    }
    populateDistricts() {
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city').value;
        const d = document.getElementById('reg-district');
        d.innerHTML='<option value="-">Pilih Kecamatan...</option>'; d.disabled=!c || c==='-';
        if(DATA_INDONESIA[p] && DATA_INDONESIA[p][c]) {
            DATA_INDONESIA[p][c].forEach(dist => { let o=document.createElement('option'); o.innerText=dist; d.appendChild(o); });
        }
    }

    switchScreen(id) {
        document.querySelectorAll('.ui-screen').forEach(e => e.classList.remove('active'));
        const s = document.getElementById(id); if(s) s.classList.add('active');
        document.getElementById('hud').style.display = 'none';
        document.getElementById('mission-overlay').style.display = 'none';
        
        // Hide RPG controls by default
        document.getElementById('rpg-controls').style.display = 'none';

        // Auto music logic for Title
        if(id === 'screen-title') AudioMgr.playMusic('bgm-player');
    }
    toggleMusic() { AudioMgr.toggle(); }
    goToRegister() { AudioMgr.playSFX('sfx-click'); this.switchScreen('screen-register'); }
    
    submitRegistration() { 
        AudioMgr.playSFX('sfx-click'); 
        const n = document.getElementById('reg-name').value;
        const s = document.getElementById('reg-school').value;
        const p = document.getElementById('reg-prov').value;
        const c = document.getElementById('reg-city').value;
        const d = document.getElementById('reg-district').value;
        
        if(!n || !s || !p || c === '-' || d === '-') {
            showMessage("DATA TIDAK LENGKAP", "Harap isi semua data (Nama, Sekolah, Wilayah, Kecamatan) untuk melanjutkan.");
            return;
        }

        this.player.name = n; 
        this.player.school = s;
        this.player.prov = p;
        this.player.city = c;
        this.player.district = d;
        this.switchScreen('screen-char'); 
    }
    
    selectChar(id) { AudioMgr.playSFX('sfx-click'); this.player.charId = id; document.querySelectorAll('.char-card').forEach(e => e.classList.remove('selected')); document.getElementById('char-'+id).classList.add('selected'); }

    startStory() {
        AudioMgr.playSFX('sfx-click'); this.state = AppState.STORY; this.switchScreen('screen-story');
        story.start([
           { speaker: "Dewi Air", text: "Tirtatelaga, kota digital yang dilindungi oleh TOYAâ€”energi suci dari Telaga Dunia.", char: 'narrator', bg: 'bg_open1' },
            { speaker: "Dewi Air", text: "Tapi ancaman datang... Malware Genderuwo menyerang, mencoba mengkontaminasi Toya.", char: 'narrator', bg: 'bg_open2' },
            { speaker: "Dewi Air", text: "Semua senior hero sedang bertarung di garis depan. Kamu, Guardian muda, adalah harapan terakhir kami!", char: 'narrator', bg: 'bg_open3' },
            { speaker: "Dewi Air", text: "Misi mu adalah Lindungi server kota dan murnikan Toya dari kontaminasi malware!", char: 'narrator', bg: 'bg_open4' },
			 { speaker: "Dewi Air", text: "Kamu akan dipandu oleh Master Rex - Mentor di SMK Nusantara Muda Tech.", char: 'narrator', bg: 'bg_open5' }
        ], () => { this.switchScreen('screen-loading'); setTimeout(() => this.startTutorial(), 2000); });
    }

    startTutorial() { this.switchScreen('dummy'); document.getElementById('hud').style.display = 'flex'; this.state = AppState.TUTORIAL; this.currentChapter = new ChapterTutorial(this); }
    finishTutorial() {
        this.switchScreen('screen-story'); this.state = AppState.STORY;
        story.start([ { speaker: "MASTER REX", text: "Kamu siap. Menuju gerbang server sekarang.", char: 'rex', bg: 'bg_rtraining' } ], () => { this.startChapter1(); });
    }
    
    startChapter1() { AudioMgr.playSFX('sfx-click'); this.switchScreen('screen-title-ch1'); }
    startChapter1Story() {
        AudioMgr.playSFX('sfx-click'); this.state = AppState.STORY; this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Pintu ini dikunci sistem kuantum. Pecahkan Kode Akses!", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Jawab dengan cepat pertanyaan tentang ancaman jaringan dan keamanan.", char: 'rex', bg: 'bg_server' }
        ], () => { 
            this.switchScreen('screen-quiz');
            document.getElementById('hud').style.display = 'flex'; 
            document.getElementById('mission-overlay').style.display = 'block';
            document.getElementById('current-mission-text').innerText = "PECAHKAN KODE AKSES";
            this.state = AppState.GAME_CH1; 
            this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH1, () => {
                showMessage("AKSES DITERIMA", "Pintu Server Terbuka.");
                setTimeout(() => this.triggerCablingNarrative(), 2000); // PERBAIKAN: Masuk ke narasi kabel dulu
            }, null);
        });
    }

    // PERBAIKAN: Fungsi narasi sebelum pengkabelan
    triggerCablingNarrative() {
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "SYSTEM", text: "PERINGATAN! Koneksi fisik terputus.", char: 'narrator', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Sistem keamanan server mengalami gangguan. Kamu harus memasang perangkat dan kabel yang benar agar server menyala.", char: 'rex', bg: 'bg_server' }
        ], () => {
            this.startChapterCabling();
        });
    }

    startChapterCabling() { 
        this.switchScreen('dummy'); 
        document.getElementById('hud').style.display = 'flex'; 
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "HUBUNGKAN KABEL JARINGAN";
        this.state = AppState.GAME_CH1; 
        this.currentChapter = new ChapterCabling(this); 
    }

    // PERBAIKAN: Fungsi narasi setelah pengkabelan berhasil
    triggerPostCablingNarrative() {
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "SYSTEM", text: "Koneksi Stabil. Server Online.", char: 'narrator', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Server keamanan kota kembali menyala! Kerja bagus. Sekarang menuju lift.", char: 'rex', bg: 'bg_server' }
        ], () => {
            this.startChapter1Bridge();
        });
    }

    startChapter1Bridge() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "MENUJU LIFT SERVER";
        this.state = AppState.BRIDGE_CH1;
        this.currentChapter = new ChapterWalkingScene(this, () => this.triggerChapter2Narrative());
    }

    triggerChapter2Narrative() {
        AudioMgr.playSFX('sfx-click'); 
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Kerja bagus Guardian. Masuk ke dalam lift menuju lantai berikutnya.", char: 'rex', bg: 'bg_server' },
            { speaker: "SYSTEM", text: "Akses Level 2: FIREWALL PERIMETER.", char: 'narrator', bg: 'bg_server' }
        ], () => { 
            this.switchScreen('screen-title-ch2');
        });
    }

    startChapter2Intro() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "NARATOR", text: "Di lantai Firewall, para Virus Genderuwo telah berkumpul.", char: 'rex', bg: 'bg_firewall' },
            { speaker: "MASTER REX", text: "Awas! Anak buah Genderuwo mencoba menembus firewall kita!", char: 'rex', bg: 'bg_firewall' },
            { speaker: "MASTER REX", text: "Jangan biarkan mereka lewat. Hancurkan semuanya!", char: 'rex', bg: 'bg_firewall1' }
        ], () => {
            this.startChapter2();
        });
    }

    startChapter2() { 
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        this.updatePurityDisplay(this.player.toyaPurity + 30); 
        document.getElementById('current-mission-text').innerText = "HAPUS MALWARE";
        document.getElementById('mission-overlay').style.display = 'block';
        this.state = AppState.GAME_CH2; 
        AudioMgr.playMusic('bgm-shooter'); // PLAY SHOOTER MUSIC
        this.currentChapter = new Chapter2(this); 
    }

    startChapter2Narrative() {
        AudioMgr.playMusic('bgm-player'); // Back to main BGM
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Kerja bagus Guardian! Virus telah dibasmi.", char: 'rex', bg: 'bg_firewall' },
            { speaker: "MASTER REX", text: "Sekarang, kita harus memilah lalu lintas data. Pisahkan paket aman dan berbahaya.", char: 'rex', bg: 'bg_firewall' }
        ], () => {
            this.startChapter2Config();
        });
    }

    startChapter2Config() {
        AudioMgr.playSFX('sfx-click');
        showMessage("FASE KONFIGURASI", "Virus hancur! Sekarang, konfigurasi ulang Firewall. Pisahkan paket Aman (Allow) dan Berbahaya (Block).");
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('current-mission-text').innerText = "KONFIGURASI FIREWALL";
        this.state = AppState.GAME_CH2_CONFIG;
        this.currentChapter = new ChapterFirewallConfig(this);
    }

    startChapter2Quiz() {
        AudioMgr.playSFX('sfx-click');
        showMessage("VERIFIKASI KEAMANAN", "Firewall aktif. Jawab pertanyaan untuk memvalidasi dan mengunci sistem.");
        this.switchScreen('screen-quiz');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('hud-purity').style.width = this.player.toyaPurity + "%";
        document.getElementById('quiz-title-text').innerText = "VALIDASI FIREWALL";
        
        // MODIFIKASI: Ubah tampilan menjadi Gembok untuk Chapter 2
        const display = document.getElementById('quiz-code-display');
        display.style.display = 'block'; 
        display.innerHTML = ''; // Bersihkan angka lama
        
        // Buat 5 Gembok Terbuka
        for(let i=0; i<5; i++) {
             const s = document.createElement('span');
             s.id = `lock-${i}`;
             s.innerText = 'ðŸ”“'; // Awal terbuka
             s.style.margin = '0 10px';
             s.style.color = '#FF4444'; // Merah (tidak aman)
             s.style.fontSize = '3rem';
             display.appendChild(s);
        }

        this.state = AppState.GAME_CH2_QUIZ;
        // Kita beri dummy code [1,1,1,1,1] agar logika quiz berjalan, nilainya tidak penting karena yang kita lihat ikonnya
        this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH2, () => {
            showMessage("SYSTEM SECURE", "Semua Port Terkunci Aman. Firewall Valid!");
            setTimeout(() => this.startChapter2Bridge(), 2000); 
        }, [1,1,1,1,1]);
    }

    startChapter2Bridge() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "MENUJU LIFT SERVER";
        this.state = AppState.BRIDGE_CH2;
        this.currentChapter = new ChapterWalkingScene(this, () => this.startChapter3IntroNarrative());
    }

    // --- CHAPTER 3 START (UPDATED) ---
    startChapter3IntroNarrative() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "MASTER REX", text: "Kita sudah di lantai teratas sekarang. Boss Monster bersembunyi di dalam.", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Kamu harus mencari 'Keylogger' yang disembunyikan virus agar bisa masuk ke ruang server utama.", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Hati-hati, labirin ini dipenuhi virus penjaga. Jangan sampai tertangkap!", char: 'rex', bg: 'bg_server' }
        ], () => {
             this.switchScreen('screen-title-ch3');
        });
    }

    startChapter3Intro() { // Called from title screen button
        this.startChapter3Bomber();
    }

    startChapter3Bomber() {
        AudioMgr.playSFX('sfx-click');
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('current-mission-text').innerText = "TEMUKAN KEYLOGGER";
        document.getElementById('mission-overlay').style.display = 'block';
        this.state = AppState.GAME_CH3_BOMBER;
        AudioMgr.playMusic('bgm-bomber'); // PLAY BOMBER MUSIC
        this.currentChapter = new Chapter3Bomber(this);
    }

    startChapter3Quiz() {
        AudioMgr.playMusic('bgm-player'); // Back to main BGM
        showMessage("INVESTIGASI LANJUTAN", "IP Penyerang Ditemukan! Analisis paket data untuk mendapatkan kode dekripsi.");
        this.switchScreen('screen-quiz');
        document.getElementById('hud').style.display = 'flex'; 
        document.getElementById('quiz-title-text').innerText = "FORENSIK DIGITAL";
        
        // MODIFIKASI: Kembalikan tampilan menjadi Angka untuk Chapter 3
        const display = document.getElementById('quiz-code-display');
        display.style.display = 'block'; 
        display.innerHTML = ''; // Bersihkan gembok
        for(let i=0; i<5; i++) {
             const s = document.createElement('span');
             s.id = `digit-${i}`;
             s.innerText = '-';
             s.style.margin = '0 5px';
             display.appendChild(s);
        }

        const fixedCode = [1,9,0,1,9]; 
        
        this.state = AppState.GAME_CH3_QUIZ;
        this.currentChapter = new ChapterQuiz(this, BANK_SOAL_CH3, () => {
            showMessage("DATA TERDEKRIPSI", "Kode Kunci: 19019. Sistem pulih... Tapi tunggu!");
            setTimeout(() => this.triggerBossNarrative(), 2000);
        }, fixedCode);
    }

    startChapter3IR() {
        // Placeholder kept for compatibility, now unused or jumped over
        this.triggerBossNarrative();
    }
    
    // --- BOSS BATTLE LOGIC ---
    triggerBossNarrative() {
        AudioMgr.playSFX('sfx-click');
        this.state = AppState.STORY;
        this.switchScreen('screen-story');
        story.start([
            { speaker: "SYSTEM", text: "ALERT! Deteksi anomali energi masif di Core Server!", char: 'narrator', bg: 'bg_server' },
            { speaker: "GENDERUWO", text: "GRRR... SIAPA YANG BERANI MENGAKTIFKAN KEMBALI FIREWALL?!", char: 'virus', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Itu dia! Induk Malware Genderuwo! Dia marah karena aksesnya kita tutup.", char: 'rex', bg: 'bg_server' },
            { speaker: "MASTER REX", text: "Guardian! Gunakan 'Cyber-Slash' untuk menghapus kodenya. Hindari serangan area merah!", char: 'rex', bg: 'bg_server' }
        ], () => {
            this.startBossBattle();
        });
    }

    startBossBattle() {
        this.switchScreen('dummy');
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('mission-overlay').style.display = 'block';
        document.getElementById('current-mission-text').innerText = "BOSS BATTLE: KALAHKAN GENDERUWO";
        
        // Show RPG Controls
        document.getElementById('rpg-controls').style.display = 'flex';
        
        this.state = AppState.BOSS_BATTLE;
        AudioMgr.playMusic('bgm-bomber'); // Dramatic music
        this.currentChapter = new ChapterBossBattle(this);
    }

    finishGame() { 
        // Hide controls
        document.getElementById('rpg-controls').style.display = 'none';
        this.updatePurityDisplay(100); 
        this.state = AppState.ENDING; document.getElementById('end-score').innerText = Math.floor(this.player.score); 
        let mockLB = JSON.parse(localStorage.getItem('toya_lb') || '[]');
        mockLB.push({ 
            name: this.player.name, 
            score: this.player.score, 
            school: this.player.school,
            prov: this.player.prov,
            city: this.player.city,
            district: this.player.district,
            date: new Date().toLocaleDateString() 
        });
        localStorage.setItem('toya_lb', JSON.stringify(mockLB)); 
        this.switchScreen('screen-ending'); 
    }
    
    showLeaderboard() { 
        this.switchScreen('screen-leaderboard');
        this.renderLeaderboard(); 
    }

    renderLeaderboard() {
        const lbBody = document.getElementById('leaderboard-body');
        lbBody.innerHTML = '';
        let mockLB = JSON.parse(localStorage.getItem('toya_lb') || '[]');
        const filterType = document.getElementById('lb-filter').value;
        const player = this.player;

        if (filterType === 'school') mockLB = mockLB.filter(d => d.school === player.school);
        else if (filterType === 'city') mockLB = mockLB.filter(d => d.city === player.city);
        else if (filterType === 'district') mockLB = mockLB.filter(d => d.district === player.district);
        
        mockLB.sort((a, b) => b.score - a.score);
        mockLB = mockLB.slice(0, 50);

        if(mockLB.length === 0) {
            lbBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">Belum ada data untuk kategori ini.<br>Jadilah yang pertama!</td></tr>`;
        } else {
            mockLB.forEach((d, i) => {
                const tr = document.createElement('tr');
                if(d.name === player.name && d.score === player.score) tr.style.background = "rgba(0, 168, 255, 0.2)";
                const loc = (d.district && d.district !== '-') ? d.district : (d.city || d.prov);
                const school = d.school || '-';
                tr.innerHTML = `<td>${i+1}</td><td>${d.name}</td><td style="font-size:0.8rem; color:#aaa">${school}</td><td style="font-size:0.8rem; color:#aaa">${loc}</td><td style="color:var(--accent-gold); font-weight:bold;">${d.score}</td>`;
                lbBody.appendChild(tr);
            });
        }
    }

    loop(timestamp) {
        const dt = timestamp - (this.lastTime || timestamp); this.lastTime = timestamp;

        // Lightning Logic for Title
        if (this.state === AppState.TITLE && Math.random() < 0.005) { // 0.5% chance per frame
            triggerLightning();
        }

        if (this.state >= AppState.TUTORIAL && this.state <= AppState.BOSS_BATTLE) {
            ctx.clearRect(0,0, 800, 600);
            let bgKey = 'bg_rtraining';
            if(this.state === AppState.GAME_CH1 && this.currentChapter instanceof ChapterCabling) bgKey = 'bg_kabel';
            else if(this.state === AppState.BRIDGE_CH1) bgKey = 'bg_server'; 
            else if(this.state === AppState.GAME_CH1 && this.currentChapter instanceof ChapterQuiz) bgKey = 'bg_server';
            else if(this.state === AppState.GAME_CH2 || this.state === AppState.GAME_CH2_CONFIG || this.state === AppState.GAME_CH2_QUIZ) bgKey = 'bg_firewall';
            else if(this.state === AppState.BRIDGE_CH2) bgKey = 'bg_firewall';
            else if(this.state === AppState.GAME_CH3_BOMBER || this.state === AppState.BOSS_BATTLE) bgKey = 'bg_bomber'; 
            else if(this.state === AppState.GAME_CH3_QUIZ || this.state === AppState.GAME_CH3_IR) bgKey = 'bg_rtraining';
            
            let bg = this.imgs[bgKey];
            if(bg && bg.complete && bg.naturalWidth > 0) ctx.drawImage(bg, 0, 0, 800, 600); 
            else { 
                ctx.fillStyle='#050A14'; ctx.fillRect(0,0,800,600); 
                ctx.strokeStyle = 'rgba(0, 168, 255, 0.1)'; ctx.beginPath();
                for(let i=0; i<800; i+=40) { ctx.moveTo(i,0); ctx.lineTo(i,600); } for(let i=0; i<600; i+=40) { ctx.moveTo(0,i); ctx.lineTo(800,i); } ctx.stroke();
            }

            if(this.currentChapter) { 
                this.currentChapter.update(dt); 
                this.currentChapter.draw(ctx); 
                document.getElementById('hud-purity').style.width = this.player.toyaPurity + "%"; 
            }
        }
        requestAnimationFrame(this.loop);
    }
}

// ... (Story Object - same as before) ...
const story = {
    data: [], idx: 0, cb: null,
    start: function(data, cb) { this.data = data; this.idx = 0; this.cb = cb; this.render(); },
    render: function() {
        if(this.idx >= this.data.length) { if(this.cb) this.cb(); return; }
        const d = this.data[this.idx];
        document.getElementById('story-speaker').innerText = d.speaker; document.getElementById('story-text').innerText = d.text;
        const bgEl = document.getElementById('story-bg');
        if(app.imgs[d.bg]) bgEl.style.backgroundImage = `url('${app.imgs[d.bg].src}')`;
        let charKey = d.char;
        if(charKey === 'hero') charKey = 'hero'+app.player.charId+'_idle';
        const img = app.imgs[charKey] || app.imgs['rex'];
        document.getElementById('story-portrait').src = img.src;
    },
    next: function() { AudioMgr.playSFX('sfx-click'); this.idx++; this.render(); }
};

// ... (CharacterSprite - same as before) ...
class CharacterSprite {
    constructor(idleImg, frames, x, y, size = 64) { 
        this.idleImg = idleImg; this.frames = frames; this.x = x; this.y = y; this.tx = x; this.ty = y; 
        this.moving = false; this.frameIdx = 0; this.frameTimer = 0;
        this.size = size; 
    }
    moveTo(tx, ty) { this.tx = tx; this.ty = ty; this.moving = true; }
    update(dt) {
        if(!this.moving) return;
        const dx = this.tx - this.x; const dy = this.ty - this.y; const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > 5) {
            const s = 0.3 * dt; this.x += (dx/dist)*s; this.y += (dy/dist)*s;
            this.frameTimer += dt;
            if(this.frameTimer > 150) { this.frameIdx = (this.frameIdx + 1) % 4; this.frameTimer = 0; }
        } else { this.moving = false; this.frameIdx = 0; }
    }
    draw(ctx) {
        let img = this.idleImg;
        if(this.moving && this.frames[this.frameIdx] && this.frames[this.frameIdx].complete) img = this.frames[this.frameIdx];
        const halfSize = this.size / 2;
        const offset = this.size * 0.9375; 
        
        if(img && img.complete && img.naturalWidth > 0) ctx.drawImage(img, this.x - halfSize, this.y - offset, this.size, this.size);
        else { ctx.fillStyle = "cyan"; ctx.beginPath(); ctx.arc(this.x, this.y-halfSize, halfSize/2, 0, Math.PI*2); ctx.fill(); }
    }
}

// ... (Tutorial & Quiz & WalkingScene Classes - mostly same) ...
class ChapterTutorial {
    constructor(game) {
        this.game = game; this.step = 0; 
        const frames = game.getHeroFrames(game.player.charId); const idle1 = game.getHeroIdle(game.player.charId);
        this.hero = new CharacterSprite(idle1, frames, 400, 300, 96); 
        this.handler = (e) => this.click(e); canvas.addEventListener('mousedown', this.handler);
        this.finished = false;
    }
    click(e) {
        const r = canvas.getBoundingClientRect(); const mx = (e.clientX - r.left) * (800/r.width); const my = (e.clientY - r.top) * (600/r.height);
        if(this.step === 1) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); setTimeout(() => this.step=2, 1500); }
        else if(this.step === 3) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); } 
        else { this.step++; AudioMgr.playSFX('sfx-click'); }
    }
    update(dt) {
        this.hero.update(dt);
        if(this.step === 3 && this.hero.x > 700 && !this.finished) { this.finished = true; this.cleanup(); this.game.finishTutorial(); }
    }
    draw(ctx) {
        this.hero.draw(ctx);
        const box = (txt, next) => {
            const bx=50, by=420;
            ctx.fillStyle = "rgba(5, 20, 40, 0.95)"; ctx.strokeStyle = "#00D9FF"; ctx.lineWidth = 2;
            ctx.fillRect(bx, by, 700, 150); ctx.strokeRect(bx, by, 700, 150);
            if(this.game.imgs.rex && this.game.imgs.rex.complete && this.game.imgs.rex.naturalWidth > 0) ctx.drawImage(this.game.imgs.rex, bx+20, by-40, 100, 100);
            ctx.fillStyle = "#FFD700"; ctx.font = "24px Orbitron"; ctx.textAlign="left"; ctx.fillText("MASTER REX", bx+140, by+40);
            ctx.fillStyle = "white"; ctx.font = "20px Rajdhani"; ctx.fillText(txt, bx+140, by+80);
            if(next) { ctx.fillStyle = "#00D9FF"; ctx.font="16px sans-serif"; ctx.fillText("â–¼ Klik untuk lanjut", 650, by+130); }
        };
        if(this.step === 0) box("Selamat datang! Mari tes sistem gerakmu.", true);
        else if(this.step === 1) box("[KLIK] di lantai untuk berjalan ke sana.", false);
        else if(this.step === 2) {
            box("Bagus! Cek inventori: Tablet & Laptop.", true);
            const drawItem = (img, x, y) => { if(img && img.complete) ctx.drawImage(img, x, y, 64, 64); }
            drawItem(this.game.imgs.item_tablet, 350, 200);
            drawItem(this.game.imgs.item_laptop, 450, 200);
        } else if(this.step === 3) {
            box("Peralatan siap. Jalan ke pintu keluar (EXIT) untuk mulai misi!", false);
            ctx.fillStyle = "rgba(0, 255, 136, 0.3)"; ctx.fillRect(700, 200, 100, 400); 
            ctx.fillStyle = "white"; ctx.font="20px Orbitron"; ctx.fillText("EXIT >>", 720, 300);
        }
    }
    cleanup() { canvas.removeEventListener('mousedown', this.handler); }
}

class ChapterWalkingScene {
    constructor(game, onFinish) {
        this.game = game; this.onFinish = onFinish; 
        const frames = game.getHeroFrames(game.player.charId); 
        const idle = game.getHeroIdle(game.player.charId);
        // PERBAIKAN: Mengganti 'idle1' menjadi 'idle' agar sesuai dengan variabel di atas
        this.hero = new CharacterSprite(idle, frames, 50, 450, 96); 
        this.handler = (e) => this.click(e); 
        canvas.addEventListener('mousedown', this.handler);
        this.finished = false;
        showMessage("AREA LORONG SERVER", "Klik lantai untuk berjalan menuju LIFT di ujung kanan.");
    }
    click(e) {
        const r = canvas.getBoundingClientRect(); const mx = (e.clientX - r.left) * (800/r.width); const my = (e.clientY - r.top) * (600/r.height);
        if(my > 350 && my < 600) { this.hero.moveTo(mx, my); AudioMgr.playSFX('sfx-click'); }
    }
    update(dt) {
        this.hero.update(dt);
        if(this.hero.x > 700 && !this.finished) { this.finished = true; this.cleanup(); if(this.onFinish) this.onFinish(); }
    }
    draw(ctx) {
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, 0, 800, 600);
        ctx.fillStyle = "#222"; ctx.fillRect(700, 200, 100, 400); ctx.strokeStyle = "#00D9FF"; ctx.lineWidth = 3; ctx.strokeRect(700, 200, 100, 400);
        ctx.fillStyle = "#333"; ctx.fillRect(710, 210, 80, 380); ctx.fillStyle = "#00FF88"; ctx.font="20px Orbitron"; ctx.fillText("LIFT", 725, 300);
        if(!this.finished) { ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; ctx.font = "30px sans-serif"; ctx.fillText(">>>", 400 + (Math.sin(Date.now()/200)*20), 500); }
        this.hero.draw(ctx);
    }
    cleanup() { canvas.removeEventListener('mousedown', this.handler); }
}

class ChapterQuiz {
    constructor(game, questionBank, onComplete, fixedCode = null) {
        this.game = game; this.onComplete = onComplete; this.currentPhase = 0; 
        this.activeQuestions = shuffleArray([...questionBank]).slice(0, 5);
        this.generatedCode = fixedCode || Array(5).fill(0).map(() => Math.floor(Math.random() * 10)); 
        this.userCode = ['-', '-', '-', '-', '-'];
        this.hasUsedHint = false; this.isQuizActive = true; this.timeLeft = 120; 
        this.timerInterval = setInterval(() => this.tick(), 1000); this.attemptsOnCurrent = 0;
        this.loadPhase(); this.updateCodeDisplay(); document.getElementById('hud-timer').innerText = this.timeLeft;
    }
    tick() {
        if (!this.isQuizActive) return;
        this.timeLeft--; document.getElementById('hud-timer').innerText = this.timeLeft;
        if (this.timeLeft <= 0) {
            this.timeLeft = 0; clearInterval(this.timerInterval); this.isQuizActive = false;
            // UPDATE: TRIGGER GLOBAL GAME OVER
            this.game.triggerGameOver();
        }
    }
    loadPhase() {
        if (this.currentPhase >= this.activeQuestions.length) { this.finishQuiz(); return; }
        this.attemptsOnCurrent = 0; 
        document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = false);
        const data = this.activeQuestions[this.currentPhase];
        document.getElementById('quiz-phase-num').innerText = this.currentPhase + 1;
        document.getElementById('quiz-question-text').innerText = data.q;
        document.getElementById('quiz-feedback').innerText = '';
        const btnHint = document.getElementById('btn-hint');
        if(this.hasUsedHint) { btnHint.disabled = true; btnHint.innerText = "DIGUNAKAN"; btnHint.style.filter = "grayscale(100%)"; } 
        else { btnHint.disabled = false; btnHint.innerText = "BANTUAN (REX)"; btnHint.style.filter = "none"; }
        const optionsContainer = document.getElementById('quiz-options-container'); optionsContainer.innerHTML = '';
        shuffleArray([...data.options]).forEach((opt, index) => {
            const btn = document.createElement('button'); btn.className = 'btn-ml quiz-option-btn'; btn.style.marginTop = '10px'; btn.style.background = '#002244'; btn.style.borderColor = '#004488';
            btn.innerText = `${String.fromCharCode(65 + index)}. ${opt.text}`;
            btn.onclick = () => this.checkAnswer(opt, btn);
            optionsContainer.appendChild(btn);
        });
    }
    checkAnswer(option, button) {
        if (!this.isQuizActive) return;
        const feedbackEl = document.getElementById('quiz-feedback');
        if (option.correct) {
            document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = true);
            AudioMgr.playSFX('sfx-correct'); button.style.background = 'var(--success-green)'; feedbackEl.style.color = 'var(--success-green)';
            
            // UPDATE: FIXED SCORING LOGIC
            let scoreGain = 0;
            if(this.attemptsOnCurrent === 0) scoreGain = 40;
            else if(this.attemptsOnCurrent === 1) scoreGain = 30;
            else if(this.attemptsOnCurrent === 2) scoreGain = 20;
            else scoreGain = 10; // Last attempt (3 previous failures)

            this.game.addScore(scoreGain); feedbackEl.innerText = `[BENAR] (+${scoreGain} Poin)`;
            this.userCode[this.currentPhase] = this.generatedCode[this.currentPhase]; this.updateCodeDisplay();
            setTimeout(() => { this.currentPhase++; this.loadPhase(); }, 1500);
        } else {
            this.attemptsOnCurrent++; AudioMgr.playSFX('sfx-wrong'); button.style.background = 'var(--danger-red)'; button.disabled = true; feedbackEl.style.color = 'var(--danger-red)'; feedbackEl.innerText = `[SALAH] - Maaf, jawaban itu kurang tepat.`;
        }
    }
    getHint() {
        if (this.hasUsedHint) return; this.hasUsedHint = true; const btnHint = document.getElementById('btn-hint'); btnHint.disabled = true; btnHint.innerText = "DIGUNAKAN"; btnHint.style.filter = "grayscale(100%)"; 
        showRexMessage("PETUNJUK MASTER REX", this.activeQuestions[this.currentPhase].hint); this.game.addScore(-5);
    }
    updateCodeDisplay() { 
        this.userCode.forEach((digit, index) => { 
            // Handle untuk Angka (Chapter 1 & 3)
            const elDigit = document.getElementById(`digit-${index}`); 
            if(elDigit) elDigit.innerText = digit; 
            
            // Handle untuk Gembok (Chapter 2)
            const elLock = document.getElementById(`lock-${index}`);
            if(elLock) {
                if(digit !== '-' && digit !== undefined) {
                    // Jika sudah terjawab (ada isinya), kunci gembok
                    elLock.innerText = 'ðŸ”’'; 
                    elLock.style.color = '#00FF88'; // Hijau
                } else {
                    // Jika belum, biarkan terbuka
                    elLock.innerText = 'ðŸ”“'; 
                    elLock.style.color = '#FF4444'; // Merah
                }
            }
        }); 
    }
    finishQuiz() { this.isQuizActive = false; clearInterval(this.timerInterval); this.game.addScore(this.timeLeft); spawnFloatingScore(`TIME BONUS +${this.timeLeft}`); if(this.onComplete) this.onComplete(); }
    cleanup() { clearInterval(this.timerInterval); }
    update() { } draw(ctx) { }
}

class ChapterCabling {
    constructor(game) {
        this.game = game; this.timeLeft = 60; 
        this.tasks = [ 
            { q: "Hubungkan PC ke Switch (Straight)", sX: 100, sY: 300, tX: 600, tY: 300, srcType: 'item_pc', targetType: 'item_switch', cableType: 'straight', completed: false, connected: false }, 
            { q: "Hubungkan Switch ke Server (Straight)", sX: 600, sY: 300, tX: 400, tY: 150, srcType: 'item_switch', targetType: 'item_server', cableType: 'straight', completed: false, connected: false },
            { q: "Hubungkan PC ke Laptop (Crossover)", sX: 100, sY: 500, tX: 300, tY: 500, srcType: 'item_pc', targetType: 'item_laptop', cableType: 'crossover', completed: false, connected: false }
        ];
        this.dragged = null; this.mx = 0; this.my = 0;
        this.evDown = (e) => this.input(e, 'down'); this.evMove = (e) => this.input(e, 'move'); this.evUp = (e) => this.input(e, 'up');
        canvas.addEventListener('mousedown', this.evDown); canvas.addEventListener('mousemove', this.evMove); canvas.addEventListener('mouseup', this.evUp);
        this.timerInterval = setInterval(() => {
            this.timeLeft--; document.getElementById('hud-timer').innerText = this.timeLeft;
            if(this.timeLeft <= 0) { 
                this.cleanup(); 
                // UPDATE: TRIGGER GLOBAL GAME OVER
                this.game.triggerGameOver();
            }
        }, 1000);
        document.getElementById('hud-timer').innerText = this.timeLeft;
    }
    cleanup() { clearInterval(this.timerInterval); canvas.removeEventListener('mousedown', this.evDown); canvas.removeEventListener('mousemove', this.evMove); canvas.removeEventListener('mouseup', this.evUp); }
    getCanvasCoords(e) { const r = canvas.getBoundingClientRect(); return { mx: (e.clientX - r.left) * (800/r.width), my: (e.clientY - r.top) * (600/r.height) }; }
    input(e, type) {
        const {mx, my} = this.getCanvasCoords(e); this.mx = mx; this.my = my;
        if (type === 'down') { for (let i = 0; i < this.tasks.length; i++) { if (!this.tasks[i].completed && Math.hypot(mx - (this.tasks[i].sX + 40), my - (this.tasks[i].sY + 40)) < 40) { this.dragged = i; AudioMgr.playSFX('sfx-click'); return; } } }
        else if (type === 'up' && this.dragged !== null) {
            const t = this.tasks[this.dragged];
            if(Math.hypot(mx - (t.tX + 40), my - (t.tY + 40)) < 60) {
                t.completed = true; t.connected = true; this.game.addScore(100); AudioMgr.playSFX('sfx-correct'); 
                // PERBAIKAN: Memanggil triggerPostCablingNarrative setelah selesai
                if(this.tasks.every(task => task.completed)) { this.cleanup(); showMessage("JARINGAN AKTIF", `Koneksi Stabil! Bonus Waktu: ${this.timeLeft * 2}`); setTimeout(() => this.game.triggerPostCablingNarrative(), 3000); }
            } else { AudioMgr.playSFX('sfx-wrong'); }
            this.dragged = null;
        }
    }
    update(dt) { }
    draw(ctx) {
        this.tasks.forEach(t => {
            const imgS = this.game.imgs[t.srcType]; const imgT = this.game.imgs[t.targetType];
            const safeDraw = (img, x, y, label) => {
                if(img && img.complete) ctx.drawImage(img, x, y, 80, 80);
                else { ctx.fillStyle = "#334"; ctx.fillRect(x, y, 80, 80); ctx.strokeRect(x, y, 80, 80); }
                ctx.fillStyle = "white"; ctx.font = "12px sans-serif"; ctx.textAlign = "center";
                const text = label.replace('item_', '').toUpperCase(); ctx.fillText(text, x + 40, y + 95); ctx.textAlign = "left"; // FIXED LABEL POSITION
            };
            safeDraw(imgS, t.sX, t.sY, t.srcType);
            if(t.srcType !== t.targetType || !t.completed) safeDraw(imgT, t.tX, t.tY, t.targetType);
            if(t.connected) { ctx.beginPath(); ctx.moveTo(t.sX + 40, t.sY + 40); ctx.lineTo(t.tX + 40, t.tY + 40); ctx.strokeStyle = t.cableType === 'straight' ? "#00A8FF" : "#FFD700"; ctx.lineWidth = 4; ctx.stroke(); }
        });
        if(this.dragged !== null) { const t = this.tasks[this.dragged]; ctx.beginPath(); ctx.moveTo(t.sX + 40, t.sY + 40); ctx.lineTo(this.mx, this.my); ctx.strokeStyle = t.cableType === 'straight' ? "#00D9FF" : "#FFD700"; ctx.lineWidth = 5; ctx.stroke(); }
        const currentTask = this.tasks.find(t => !t.completed);
        if (currentTask) { ctx.fillStyle = "#00D9FF"; ctx.font = "24px Orbitron"; ctx.textAlign = "center"; ctx.fillText("MISI: " + currentTask.q, 400, 550); ctx.textAlign = "left"; }
    }
}

class Chapter2 { 
    constructor(game) {
        this.game = game; this.pX = 400; this.pY = 500; this.bullets = []; this.enemies = []; this.particles = [];
        this.isShooting = false; this.spawnTimer = 0; this.shootTimer = 0; this.waveCount = 0;
        this.kills = 0; this.targetKills = 20; this.hp = 100; this.maxHp = 100; this.active = true; this.missedCount = 0; this.missedLimit = 5; this.won = false;
        
        this.handleMove = (e) => { const r = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; this.pX = (clientX - r.left) * (800/r.width); if(this.pX < 30) this.pX = 30; if(this.pX > 770) this.pX = 770; };
        this.handleStart = (e) => { this.isShooting = true; this.handleMove(e); }; this.handleEnd = (e) => { this.isShooting = false; };
        canvas.addEventListener('mousemove', this.handleMove); canvas.addEventListener('mousedown', this.handleStart); canvas.addEventListener('mouseup', this.handleEnd);
        showMessage("MISI: FIREWALL DEFENSE", "Tahan KLIK/SENTUH untuk menembak. Geser untuk bergerak. Hancurkan 20 Malware prajurit gendruwo! Jangan biarkan lebih dari 5 prajurit gendruwo lolos!");
    }
    cleanup() { canvas.removeEventListener('mousemove', this.handleMove); canvas.removeEventListener('mousedown', this.handleStart); canvas.removeEventListener('mouseup', this.handleEnd); }
    // UPDATE: Increased speed formula significantly
    spawnEnemy() { this.enemies.push({ x: Math.random() * 700 + 50, y: -50, spd: 2.0 + (this.waveCount * 0.1), hp: 3, maxHp: 3 }); }
    spawnExplosion(x, y, color) { for(let i=0; i<8; i++) this.particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1.0, color: color }); }
    update(dt) {
        if(!this.active) return;
        if(this.isShooting) { this.shootTimer += dt; if(this.shootTimer > 150) { this.bullets.push({ x: this.pX, y: this.pY - 40 }); this.shootTimer = 0; } }
        this.spawnTimer += dt; if(this.spawnTimer > 2000) { this.spawnEnemy(); this.spawnTimer = 0; this.waveCount++; }
        
        for(let i = this.bullets.length - 1; i >= 0; i--) { let b = this.bullets[i]; b.y -= 10; if(b.y < -10) this.bullets.splice(i, 1); }
        for(let i = this.enemies.length - 1; i >= 0; i--) {
            let e = this.enemies[i]; e.y += e.spd;
            if(Math.hypot(e.x - this.pX, e.y - this.pY) < 50) { this.hp -= 20; this.spawnExplosion(e.x, e.y, 'red'); AudioMgr.playSFX('sfx-wrong'); this.enemies.splice(i, 1); if(this.hp <= 0) this.gameOver(); continue; }
            if(e.y > 600) { this.missedCount++; this.enemies.splice(i, 1); AudioMgr.playSFX('sfx-wrong'); if(this.missedCount >= this.missedLimit) this.gameOver(); continue; }
            for(let j = this.bullets.length - 1; j >= 0; j--) {
                let b = this.bullets[j];
                if(Math.hypot(e.x - b.x, e.y - b.y) < 40) { e.hp--; this.bullets.splice(j, 1); this.spawnExplosion(b.x, b.y, 'cyan'); if(e.hp <= 0) { this.enemies.splice(i, 1); this.kills++; this.game.addScore(50); AudioMgr.playSFX('sfx-correct'); this.checkWin(); } break; }
            }
        }
        for(let i = this.particles.length - 1; i >= 0; i--) { let p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05; if(p.life <= 0) this.particles.splice(i, 1); }
    }
    checkWin() { if(this.kills >= this.targetKills && !this.won) { this.won = true; this.active = false; showMessage("MISI SELESAI", "Area diamankan! Melanjutkan ke konfigurasi firewall..."); setTimeout(() => { this.cleanup(); this.game.startChapter2Narrative(); }, 3000); } }
    
    // UPDATE: Trigger Global Game Over
    gameOver() { this.active = false; this.game.triggerGameOver(); }
    
    draw(ctx) {
        // UI
        const heartsLeft = this.missedLimit - this.missedCount;
        for(let h=0; h<this.missedLimit; h++) { ctx.fillStyle = h < heartsLeft ? "#FF4444" : "#555"; ctx.beginPath(); ctx.arc(780 - (h*25), 570, 10, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="white"; ctx.stroke(); }
        ctx.fillStyle = "#550000"; ctx.fillRect(580, 585, 200, 10); ctx.fillStyle = this.hp > 30 ? "#00FF88" : "#FF4444"; ctx.fillRect(580, 585, 200 * (this.hp / this.maxHp), 10);
        ctx.textAlign="left"; ctx.fillStyle = "#00D9FF"; ctx.font = "16px Orbitron"; ctx.fillText(`MALWARE ELIMINATED: ${this.kills}/${this.targetKills}`, 20, 570);

        //const charImg = this.game.getHeroIdle(this.game.player.charId);
		// -- UPDATED: USE TEMBAK SPRITE --
        const charId = this.game.player.charId;
        // Try to get shooting sprite
        let charImg = this.game.imgs['hero' + charId + '_tembak'];
        // Fallback to idle if shooting sprite is missing/broken
        if (!charImg || !charImg.complete || charImg.naturalWidth === 0) {
             charImg = this.game.getHeroIdle(charId); 
        }

		
		
		
		
        if(charImg && charImg.complete) { ctx.drawImage(charImg, this.pX - 32, this.pY - 40, 64, 64); } else { ctx.fillStyle = "blue"; ctx.beginPath(); ctx.arc(this.pX, this.pY, 20, 0, Math.PI*2); ctx.fill(); }
        const virusImg = this.game.imgs.virus;
        this.enemies.forEach(e => { if(virusImg && virusImg.complete) ctx.drawImage(virusImg, e.x - 30, e.y - 30, 60, 60); else { ctx.fillStyle = "red"; ctx.fillRect(e.x-20, e.y-20, 40, 40); } ctx.fillStyle = "green"; ctx.fillRect(e.x - 20, e.y - 40, 40 * (e.hp / e.maxHp), 5); });
        ctx.fillStyle = "#FFFF00"; this.bullets.forEach(b => { ctx.fillRect(b.x - 3, b.y - 10, 6, 20); });
        this.particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0; });
    }
}

// 1. INVESTIGATION MAZE (UPDATED FOR SPRITES & GAMEPLAY)
class Chapter3Bomber {
    constructor(game) {
        this.game = game;
        this.tileSize = 50;
        this.rows = 12; this.cols = 16;
        this.grid = []; // 0=Empty, 1=Indestructible, 2=Destructible, 3=Bomb, 4=Explosion
        this.playerPos = {r:1, c:1};
        this.exitPos = {r:10, c:14}; // Hidden exit
        this.logsCollected = 0;
        this.logsRequired = 3;
        this.logs = [];
        this.enemies = [];
        this.bombs = [];
        this.active = true;
        this.exitRevealed = false;
        this.scanEffect = 0;

        // UPDATE: Timer Logic
        this.timeLeft = 90; 
        document.getElementById('hud-timer').innerText = this.timeLeft;
        this.timerInterval = setInterval(() => {
            if(!this.active) return;
            this.timeLeft--;
            document.getElementById('hud-timer').innerText = this.timeLeft;
            if(this.timeLeft <= 0) {
                this.cleanup();
                this.game.triggerGameOver();
            }
        }, 1000);

        // Sprite references
        this.heroFrames = game.getHeroFrames(game.player.charId);
        this.heroIdle = game.getHeroIdle(game.player.charId);
        this.virusImg = game.imgs.virus;
        this.logImg = game.imgs.item_keylogger;
        this.bombImg = game.imgs.icon_exe; // UPDATE: Use EXE icon as "Logic Bomb"

        // Animation State
        this.isMoving = false;
        this.frameIdx = 0;
        this.frameTimer = 0;
        
        // Init Grid
        for(let r=0; r<this.rows; r++) {
            let row = [];
            for(let c=0; c<this.cols; c++) {
                if(r===0 || r===this.rows-1 || c===0 || c===this.cols-1 || (r%2===0 && c%2===0)) row.push(1); // Hard
                else if(Math.random() < 0.3 && !(r===1 && c===1)) row.push(2); // Soft
                else row.push(0);
            }
            this.grid.push(row);
        }
        this.grid[this.exitPos.r][this.exitPos.c] = 2; 

        // Place Logs
        for(let i=0; i<3; i++) {
            let placed = false;
            while(!placed) {
                let r = Math.floor(Math.random() * (this.rows-2)) + 1;
                let c = Math.floor(Math.random() * (this.cols-2)) + 1;
                if(this.grid[r][c] === 2) { this.logs.push({r,c, collected:false}); placed = true; }
            }
        }

        this.enemies.push({r:10, c:1, dir:1, moveTimer:0});
        this.enemies.push({r:1, c:14, dir:1, moveTimer:0});

        this.keyDown = (e) => {
            if(!this.active) return;
            if(e.key === 'ArrowUp') this.move(-1, 0);
            if(e.key === 'ArrowDown') this.move(1, 0);
            if(e.key === 'ArrowLeft') this.move(0, -1);
            if(e.key === 'ArrowRight') this.move(0, 1);
            if(e.key === ' ' || e.key === 'Enter') this.placeBomb();
        };
        window.addEventListener('keydown', this.keyDown);
        this.click = (e) => this.placeBomb();
        canvas.addEventListener('click', this.click);
        
        showMessage("MISI: INVESTIGASI", "Gunakan ARAH PANAH untuk gerak. SPASI untuk pasang Logic Bomb. Hancurkan tembok, temukan 3 KEYLOGGER!");
        this.scanEffect = 100;
    }

    move(dr, dc) {
        let nr = this.playerPos.r + dr;
        let nc = this.playerPos.c + dc;
        if(this.grid[nr][nc] === 0 || this.grid[nr][nc] === 4) {
            this.playerPos.r = nr;
            this.playerPos.c = nc;
            this.checkPickups();
            this.isMoving = true;
            this.frameIdx = (this.frameIdx + 1) % 4; // Cycle frame on move
        }
    }

    placeBomb() { this.bombs.push({r:this.playerPos.r, c:this.playerPos.c, timer: 120}); }

    update(dt) {
        if(!this.active) return;
        if(this.scanEffect > 0) this.scanEffect--;
        
        // Reset moving flag slightly after input for visual feel (simple)
        if(this.isMoving) {
            setTimeout(() => {this.isMoving = false}, 100);
        }

        for(let i=this.bombs.length-1; i>=0; i--) {
            let b = this.bombs[i]; b.timer--;
            if(b.timer <= 0) { this.explode(b.r, b.c); this.bombs.splice(i, 1); }
        }
        this.enemies.forEach(e => {
            e.moveTimer++;
            if(e.moveTimer > 30) {
                let moves = [[0,1], [0,-1], [1,0], [-1,0]];
                let m = moves[Math.floor(Math.random()*4)];
                if(this.grid[e.r+m[0]][e.c+m[1]] === 0) { e.r += m[0]; e.c += m[1]; }
                e.moveTimer = 0;
            }
            if(e.r === this.playerPos.r && e.c === this.playerPos.c) { this.showFailMessage(); }
        });
    }

    showFailMessage() {
        this.active = false;
        // Trigger global Game Over instead of restart loop
        this.game.triggerGameOver();
    }

    explode(r, c) {
        AudioMgr.playSFX('sfx-wrong');
        let fl = [{r,c}, {r:r+1,c}, {r:r-1,c}, {r,c:c+1}, {r,c:c-1}];
        fl.forEach(p => {
            if(this.grid[p.r][p.c] === 2) { this.grid[p.r][p.c] = 0; this.game.addScore(10); }
        });
    }

    checkPickups() {
        this.logs.forEach(l => {
            if(!l.collected && l.r === this.playerPos.r && l.c === this.playerPos.c) {
                l.collected = true; this.logsCollected++; this.game.addScore(100); AudioMgr.playSFX('sfx-correct'); spawnFloatingScore("KEYLOGGER +1");
                if(this.logsCollected >= this.logsRequired) { this.exitRevealed = true; spawnFloatingScore("IP DETECTED!"); }
            }
        });
        if(this.exitRevealed && this.playerPos.r === this.exitPos.r && this.playerPos.c === this.exitPos.c) {
            this.active = false; this.cleanup(); this.game.startChapter3Quiz();
        }
    }

    draw(ctx) {
        // Draw walls
        for(let r=0; r<this.rows; r++) {
            for(let c=0; c<this.cols; c++) {
                let x = c*this.tileSize, y = r*this.tileSize;
                if(this.grid[r][c] === 1) { ctx.fillStyle = "#444"; ctx.fillRect(x,y,this.tileSize,this.tileSize); ctx.strokeStyle="#555"; ctx.strokeRect(x,y,this.tileSize,this.tileSize); }
                else if(this.grid[r][c] === 2) { ctx.fillStyle = "#840"; ctx.fillRect(x,y,this.tileSize,this.tileSize); ctx.strokeStyle="#A60"; ctx.strokeRect(x,y,this.tileSize,this.tileSize); }
            }
        }
        // Items
        this.logs.forEach(l => {
            if(!l.collected && this.grid[l.r][l.c] === 0) {
                 if(this.logImg && this.logImg.complete) ctx.drawImage(this.logImg, l.c*50+10, l.r*50+10, 30, 30);
                 else { ctx.fillStyle = "#0FF"; ctx.beginPath(); ctx.arc(l.c*50+25, l.r*50+25, 10, 0, Math.PI*2); ctx.fill(); }
            }
        });
        // Exit
        if(this.exitRevealed && this.grid[this.exitPos.r][this.exitPos.c] === 0) { ctx.fillStyle = "#0F0"; ctx.fillRect(this.exitPos.c*50+10, this.exitPos.r*50+10, 30, 30); ctx.fillStyle = "black"; ctx.fillText("IP", this.exitPos.c*50+20, this.exitPos.r*50+30); }
        
        // Bombs (UPDATE: Visual Pulse)
        this.bombs.forEach(b => { 
            let pulse = Math.abs(Math.sin(Date.now() / 100)) * 5;
            if(this.bombImg && this.bombImg.complete) ctx.drawImage(this.bombImg, b.c*50+10 - (pulse/2), b.r*50+10 - (pulse/2), 30+pulse, 30+pulse);
            else { ctx.fillStyle = `rgb(${255}, ${pulse*20}, 0)`; ctx.beginPath(); ctx.arc(b.c*50+25, b.r*50+25, 15 + (pulse/2), 0, Math.PI*2); ctx.fill(); }
        });
        
        // Enemies (UPDATE: Wobble Animation)
        this.enemies.forEach(e => {
            let wobble = Math.sin(Date.now() / 200) * 5;
            if(this.virusImg && this.virusImg.complete) ctx.drawImage(this.virusImg, e.c*50+5 + wobble, e.r*50+5, 40, 40);
            else { ctx.fillStyle = "purple"; ctx.beginPath(); ctx.arc(e.c*50+25, e.r*50+25, 20, 0, Math.PI*2); ctx.fill(); }
        });

        // Player (UPDATE: 4 Frame Animation)
        let pImg;
        if(this.isMoving) {
             pImg = this.heroFrames[this.frameIdx]; // Cycle through walking frames
        } else {
             pImg = this.heroIdle; // Idle frame
        }
        
        if(pImg && pImg.complete) ctx.drawImage(pImg, this.playerPos.c*50+5, this.playerPos.r*50-10, 40, 50); 
        else { ctx.fillStyle = "#00A8FF"; ctx.beginPath(); ctx.arc(this.playerPos.c*50+25, this.playerPos.r*50+25, 20, 0, Math.PI*2); ctx.fill(); }

        // UI
        ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(10, 10, 250, 40);
        ctx.fillStyle = "white"; ctx.font = "20px Orbitron";
        ctx.fillText(`KEYLOGGERS: ${this.logsCollected}/${this.logsRequired}`, 20, 35);

        if(this.scanEffect > 0) { ctx.fillStyle = `rgba(0, 217, 255, ${this.scanEffect/200})`; ctx.fillRect(0,0,800,600); ctx.fillStyle = "white"; ctx.font = "30px Orbitron"; ctx.textAlign="center"; ctx.fillText("SCANNING NETWORK SEGMENT...", 400, 300); ctx.textAlign="left"; }
    }
    cleanup() { 
        clearInterval(this.timerInterval);
        window.removeEventListener('keydown', this.keyDown); 
        canvas.removeEventListener('click', this.click); 
    }
}

class ChapterFirewallConfig {
    constructor(game) {
        this.game = game; this.packets = []; this.score = 0; this.targetScore = 10; this.spawnTimer = 0; this.active = true; this.draggedPacket = null;
        this.zones = { allow: { x: 50, y: 400, w: 200, h: 150, color: "#005522", label: "ALLOW (SAFE)", img: 'zone_allow' }, block: { x: 550, y: 400, w: 200, h: 150, color: "#550000", label: "BLOCK (THREAT)", img: 'zone_block' } };
        
        // UPDATE: TIMER LOGIC
        this.timeLeft = 60;
        this.timerTimer = 0; // Milliseconds accumulator
        document.getElementById('hud-timer').innerText = this.timeLeft;

        // WITH IMAGES
        this.packetTypes = [
            { text: "HTTP Request", type: "allow", color: "#00AAFF", icon: 'icon_http' },
            { text: "SSH Admin", type: "allow", color: "#00AAFF", icon: 'icon_ssh' },
            { text: "Email Sync", type: "allow", color: "#00AAFF", icon: 'icon_email' },
            { text: "SQL Injection", type: "block", color: "#FF4444", icon: 'icon_sql' },
            { text: "Ping Flood", type: "block", color: "#FF4444", icon: 'icon_ping' },
            { text: "Port 23 Telnet", type: "block", color: "#FF4444", icon: 'icon_telnet' },
            { text: "Unknown EXE", type: "block", color: "#FF4444", icon: 'icon_exe' }
        ];

        this.evDown = (e) => this.input(e, 'down'); this.evMove = (e) => this.input(e, 'move'); this.evUp = (e) => this.input(e, 'up');
        canvas.addEventListener('mousedown', this.evDown); canvas.addEventListener('mousemove', this.evMove); canvas.addEventListener('mouseup', this.evUp);
    }
    spawnPacket() {
        const template = this.packetTypes[Math.floor(Math.random() * this.packetTypes.length)];
        this.packets.push({ x: 400, y: 50, text: template.text, type: template.type, color: template.color, icon: template.icon, w: 80, h: 80, vx: (Math.random() - 0.5) * 2, vy: 1 });
    }
    getCanvasCoords(e) { const r = canvas.getBoundingClientRect(); return { mx: (e.clientX - r.left) * (800/r.width), my: (e.clientY - r.top) * (600/r.height) }; }
    input(e, type) {
        const {mx, my} = this.getCanvasCoords(e);
        if (type === 'down') { for (let i = this.packets.length - 1; i >= 0; i--) { const p = this.packets[i]; if (mx > p.x - p.w/2 && mx < p.x + p.w/2 && my > p.y - p.h/2 && my < p.y + p.h/2) { this.draggedPacket = p; AudioMgr.playSFX('sfx-click'); return; } } }
        else if (type === 'move' && this.draggedPacket) { this.draggedPacket.x = mx; this.draggedPacket.y = my; }
        else if (type === 'up' && this.draggedPacket) { this.checkDrop(this.draggedPacket); this.draggedPacket = null; }
    }
    checkDrop(p) {
        const inZone = (zone) => (p.x > zone.x && p.x < zone.x + zone.w && p.y > zone.y && p.y < zone.y + zone.h);
        if (inZone(this.zones.allow)) { if (p.type === 'allow') this.success(p); else this.fail(p); } 
        else if (inZone(this.zones.block)) { if (p.type === 'block') this.success(p); else this.fail(p); }
    }
    success(p) { this.score++; AudioMgr.playSFX('sfx-correct'); this.game.addScore(50); this.packets = this.packets.filter(pkt => pkt !== p); if (this.score >= this.targetScore) { this.active = false; this.cleanup(); showMessage("KONFIGURASI SELESAI", "Firewall Rules Diperbarui!"); setTimeout(() => this.game.startChapter2Quiz(), 2000); } }
    fail(p) { AudioMgr.playSFX('sfx-wrong'); this.game.addScore(-20); this.game.updatePurityDisplay(this.game.player.toyaPurity - 5); this.packets = this.packets.filter(pkt => pkt !== p); spawnFloatingScore("RULE ERROR!"); }
    update(dt) { 
        if (!this.active) return; 
        
        // UPDATE: TIMER UPDATE IN LOOP
        this.timerTimer += dt;
        if(this.timerTimer >= 1000) {
            this.timeLeft--;
            this.timerTimer = 0;
            document.getElementById('hud-timer').innerText = this.timeLeft;
            if(this.timeLeft <= 0) {
                this.cleanup();
                this.game.triggerGameOver();
            }
        }

        this.spawnTimer += dt; if (this.spawnTimer > 2000) { this.spawnPacket(); this.spawnTimer = 0; } this.packets.forEach(p => { if (p !== this.draggedPacket) { p.y += p.vy; p.x += p.vx; if (p.x < 50) p.vx = Math.abs(p.vx); if (p.x > 750) p.vx = -Math.abs(p.vx); } }); 
    }
    draw(ctx) {
        const drawZone = (z) => { 
            const img = this.game.imgs[z.img];
            if(img && img.complete) {
                ctx.drawImage(img, z.x, z.y, z.w, z.h);
            } else {
                ctx.fillStyle = z.color; ctx.fillRect(z.x, z.y, z.w, z.h); ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.strokeRect(z.x, z.y, z.w, z.h); 
            }
            // Draw label BELOW box
            ctx.fillStyle = "white"; ctx.font = "20px Orbitron"; ctx.textAlign = "center"; ctx.fillText(z.label, z.x + z.w/2, z.y + z.h + 30); ctx.textAlign = "left"; 
        };
        drawZone(this.zones.allow); drawZone(this.zones.block);
        ctx.fillStyle = "#00D9FF"; ctx.font = "16px Rajdhani"; ctx.textAlign = "center"; ctx.fillText(`FILTER TRAFFIC: ${this.score} / ${this.targetScore}`, 400, 100); ctx.textAlign = "left";
        this.packets.forEach(p => {
            // Draw Icon
            const iconImg = this.game.imgs[p.icon];
            if(iconImg && iconImg.complete) ctx.drawImage(iconImg, p.x - 30, p.y - 40, 60, 60);
            else { ctx.fillStyle = p.color; ctx.fillRect(p.x - 30, p.y - 40, 60, 60); }
            // Draw Text Below - With Background for readability
            const textWidth = ctx.measureText(p.text).width;
            ctx.fillStyle = "rgba(0,0,0,0.7)"; ctx.fillRect(p.x - textWidth/2 - 5, p.y + 25, textWidth + 10, 16);
            ctx.fillStyle = "white"; ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center"; ctx.fillText(p.text, p.x, p.y + 38); ctx.textAlign = "left";
        });
    }
    cleanup() { canvas.removeEventListener('mousedown', this.evDown); canvas.removeEventListener('mousemove', this.evMove); canvas.removeEventListener('mouseup', this.evUp); }
}

class Chapter3IRPuzzle { constructor(g){ this.g=g; setTimeout(() => this.g.finishGame(), 100); } update(){} draw(){} cleanup(){} }

// === CHAPTER BOSS BATTLE (ARPG) ===
class ChapterBossBattle {
    constructor(game) {
        this.game = game;
        this.hero = new CharacterSprite(game.getHeroIdle(game.player.charId), game.getHeroFrames(game.player.charId), 200, 400, 96);
        this.boss = { x: 600, y: 300, hp: 1000, maxHp: 1000, size: 150, state: 'idle', stateTimer: 0, targetX: 600, targetY: 300 };
        this.playerHp = 200; this.playerMaxHp = 200;
        this.minions = [];
        this.damageText = [];
        this.isAttacking = false;
        this.skillCooldown = 0;
        
        // Controls
        this.handler = (e) => this.click(e);
        canvas.addEventListener('mousedown', this.handler);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.click(e.touches[0]); }, {passive: false});

        this.shockwaves = [];
        showMessage("TIPS PERTARUNGAN", "TAP tanah untuk bergerak. TAP tombol 'ATK' untuk serang. Hindari lingkaran merah!");
    }

    click(e) {
        const r = canvas.getBoundingClientRect(); 
        const mx = (e.clientX - r.left) * (800/r.width); 
        const my = (e.clientY - r.top) * (600/r.height);
        
        // Tap to Move logic
        this.hero.moveTo(mx, my);
    }

    attack() {
        if(this.isAttacking) return;
        this.isAttacking = true;
        AudioMgr.playSFX('sfx-shooter'); // Reusing sfx
        
        // Logic: Damage cone in front of hero
        // For simplicity: Distance check to boss
        const dist = Math.hypot(this.hero.x - this.boss.x, this.hero.y - this.boss.y);
        if(dist < 180) { // Range
            const dmg = 40 + Math.floor(Math.random()*10);
            this.boss.hp -= dmg;
            this.showDamage(this.boss.x, this.boss.y, dmg, "#FFD700");
            AudioMgr.playSFX('sfx-click'); // Hit sound
        }

        // Minion damage
        this.minions.forEach((m, i) => {
             if(Math.hypot(this.hero.x - m.x, this.hero.y - m.y) < 100) {
                 m.hp -= 50;
                 this.showDamage(m.x, m.y, 50, "white");
                 if(m.hp <= 0) {
                     this.minions.splice(i, 1);
                     this.game.addScore(10);
                 }
             }
        });

        setTimeout(() => this.isAttacking = false, 300);
    }

    skill() {
        if(this.skillCooldown > 0) return;
        this.skillCooldown = 300; // 5 seconds (at 60fps approx)
        AudioMgr.playSFX('sfx-correct'); 
        
        // Logic: Big damage to boss if visible
        const dmg = 150;
        this.boss.hp -= dmg;
        this.showDamage(this.boss.x, this.boss.y - 50, "CRITICAL " + dmg + "!", "#00D9FF");
        
        // Clear all minions
        this.minions = [];
        this.showDamage(400, 300, "EMP BLAST!", "cyan");
    }

    update(dt) {
        this.hero.update(dt);
        if(this.skillCooldown > 0) this.skillCooldown--;

        // Update Skill Button UI
        const btnSkill = document.getElementById('btn-skill');
        if(this.skillCooldown > 0) {
            btnSkill.classList.add('cooldown');
            btnSkill.innerText = Math.ceil(this.skillCooldown/60);
        } else {
            btnSkill.classList.remove('cooldown');
            btnSkill.innerText = "SKILL";
        }

        // BOSS AI
        this.boss.stateTimer++;
        if(this.boss.stateTimer > 100) {
            this.boss.stateTimer = 0;
            const rand = Math.random();
            if(rand < 0.4) this.boss.state = 'chase';
            else if(rand < 0.7) this.boss.state = 'smash';
            else this.boss.state = 'spawn';
        }

        if(this.boss.state === 'chase') {
            const dx = this.hero.x - this.boss.x;
            const dy = this.hero.y - this.boss.y;
            const dist = Math.sqrt(dx*dx+dy*dy);
            if(dist > 100) {
                this.boss.x += (dx/dist) * 1.5;
                this.boss.y += (dy/dist) * 1.5;
            } else {
                // Touch damage
                if(this.playerHp > 0 && Math.random() < 0.1) {
                    this.playerHp -= 5;
                    this.showDamage(this.hero.x, this.hero.y, 5, "red");
                }
            }
        } else if (this.boss.state === 'smash') {
            if(this.boss.stateTimer === 1) {
                // Create warning zone
                this.shockwaves.push({x: this.hero.x, y: this.hero.y, r: 0, maxR: 100, timer: 60, active: false});
            }
        } else if (this.boss.state === 'spawn') {
            if(this.boss.stateTimer === 1 && this.minions.length < 5) {
                this.minions.push({x: this.boss.x, y: this.boss.y, hp: 30});
            }
        }

        // Update Shockwaves
        this.shockwaves.forEach((s, i) => {
            if(!s.active) {
                s.timer--;
                if(s.timer <= 0) { s.active = true; s.timer = 20; AudioMgr.playSFX('sfx-wrong'); } // Explode
            } else {
                s.r += 10;
                // Damage check
                if(s.r < s.maxR && Math.hypot(this.hero.x - s.x, this.hero.y - s.y) < s.r) {
                     if(this.playerHp > 0) {
                         this.playerHp -= 2; // Tick damage
                         this.game.updatePurityDisplay(this.game.player.toyaPurity - 0.5);
                     }
                }
                if(s.r > s.maxR) this.shockwaves.splice(i, 1);
            }
        });

        // Minions Logic
        this.minions.forEach(m => {
             const dx = this.hero.x - m.x; const dy = this.hero.y - m.y;
             m.x += (dx/Math.hypot(dx,dy)) * 2;
             m.y += (dy/Math.hypot(dx,dy)) * 2;
             if(Math.hypot(dx,dy) < 30 && Math.random()<0.05) { this.playerHp--; }
        });

        // Win/Loss
        if(this.playerHp <= 0) {
            this.game.triggerGameOver();
        }
        if(this.boss.hp <= 0) {
            this.game.addScore(1000);
            this.cleanup();
            this.game.finishGame();
        }

        // Damage Text Physics
        this.damageText.forEach((d, i) => {
            d.y -= 1; d.life--;
            if(d.life <= 0) this.damageText.splice(i, 1);
        });
    }

    showDamage(x, y, txt, color) {
        this.damageText.push({x, y, txt, color, life: 60});
    }

    draw(ctx) {
        // Draw Shockwaves
        this.shockwaves.forEach(s => {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.active ? s.r : 100, 0, Math.PI*2);
            ctx.fillStyle = s.active ? "rgba(255, 0, 0, 0.5)" : "rgba(255, 0, 0, 0.2)";
            ctx.fill();
            if(!s.active) {
                ctx.strokeStyle = "red"; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        // Draw Boss
        const bossImg = this.game.imgs.virus;
        if(bossImg) {
            // Pulse Effect
            const scale = 1 + Math.sin(Date.now()/200)*0.05;
            ctx.save();
            ctx.translate(this.boss.x, this.boss.y);
            ctx.scale(scale, scale);
            // Red Filter for Boss Look
            ctx.filter = "hue-rotate(90deg) brightness(0.8)"; 
            ctx.drawImage(bossImg, -75, -75, 150, 150);
            ctx.restore();
        } else {
             ctx.fillStyle = "purple"; ctx.beginPath(); ctx.arc(this.boss.x, this.boss.y, 70, 0, Math.PI*2); ctx.fill();
        }

        // Boss HP Bar
        ctx.fillStyle = "black"; ctx.fillRect(200, 50, 400, 20);
        ctx.fillStyle = "#FF0000"; ctx.fillRect(200, 50, 400 * (this.boss.hp / this.boss.maxHp), 20);
        ctx.strokeStyle = "white"; ctx.strokeRect(200, 50, 400, 20);
        ctx.fillStyle = "white"; ctx.font="16px Orbitron"; ctx.textAlign="center"; ctx.fillText("GENDERUWO MALWARE", 400, 45); ctx.textAlign="left";

        // Minions
        this.minions.forEach(m => {
            if(bossImg) ctx.drawImage(bossImg, m.x-20, m.y-20, 40, 40);
            else { ctx.fillStyle = "red"; ctx.fillRect(m.x-10, m.y-10, 20, 20); }
        });

        // Draw Hero
        this.hero.draw(ctx);
        if(this.isAttacking) {
            // Draw Slash Effect
            ctx.strokeStyle = "cyan"; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(this.hero.x, this.hero.y, 80, -0.5, 0.5); ctx.stroke();
        }

        // Player HP Bar (Floating above head)
        ctx.fillStyle = "black"; ctx.fillRect(this.hero.x - 30, this.hero.y - 60, 60, 8);
        ctx.fillStyle = "#00FF00"; ctx.fillRect(this.hero.x - 30, this.hero.y - 60, 60 * (this.playerHp / this.playerMaxHp), 8);

        // Damage Texts
        this.damageText.forEach(d => {
            ctx.fillStyle = d.color; ctx.font = "bold 20px Orbitron";
            ctx.fillText(d.txt, d.x, d.y);
        });
    }

    cleanup() {
        canvas.removeEventListener('mousedown', this.handler);
        // Remove touch listener manually if needed, or rely on GC/reload
    }
}

const app = new GameApp();
</script>
</body>
</html>